<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>1ì°¨ ì˜ë£Œìš©: ê°ë³„(ì§ˆí™˜+ICD)Â·ìœ„í—˜ ì§ˆë¬¸Â·EMR ë³µë¶™</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1620; --panel2:#0c121a;
      --text:#e8eef6; --muted:#9bb0c6; --line:#1d2a3a;
      --accent:#5aa9ff; --danger:#ff5a6a;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Apple SD Gothic Neo, Arial, "Helvetica Neue", Helvetica, sans-serif;
    }
    *{box-sizing:border-box}
    body{margin:0; background:linear-gradient(180deg,#070a0f 0%, #0b0f14 55%, #070a0f 100%); color:var(--text); font-family:var(--sans);}
    .wrap{max-width:1200px; margin:0 auto; padding:20px 16px 46px;}
    .topbar{display:flex; gap:12px; align-items:flex-start; justify-content:space-between; margin-bottom:12px; flex-wrap:wrap}
    h1{font-size:18px; margin:0 0 6px}
    .sub{color:var(--muted); font-size:13px; line-height:1.45}
    .badge{font-size:12px; padding:6px 10px; border:1px solid var(--line); border-radius:999px; background:rgba(255,255,255,.02); color:var(--muted)}
    .grid{display:grid; grid-template-columns: 1fr 1.1fr; gap:12px; align-items:start}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.03) 0%, rgba(255,255,255,.015) 100%);
      border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden;
    }
    .hd{padding:12px 14px; border-bottom:1px solid var(--line); background:rgba(0,0,0,.12); display:flex; align-items:center; justify-content:space-between; gap:10px}
    .hd h2{font-size:14px; margin:0}
    .bd{padding:14px}

    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    input, select, textarea{
      width:100%; color:var(--text); background:rgba(0,0,0,.22);
      border:1px solid var(--line); border-radius:12px; padding:10px 11px; outline:none; font-size:13px;
    }
    textarea{min-height:110px; resize:vertical; line-height:1.45}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    @media (max-width: 560px){ .row{grid-template-columns:1fr;} }

    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    button{
      border:1px solid var(--line); background:rgba(255,255,255,.03);
      color:var(--text); padding:10px 12px; border-radius:12px;
      cursor:pointer; font-size:13px;
    }
    button.primary{border-color:rgba(90,169,255,.35); background:rgba(90,169,255,.12)}
    button.danger{border-color:rgba(255,90,106,.35); background:rgba(255,90,106,.10)}
    button:hover{filter:brightness(1.08)}

    .hint{font-size:12px; color:var(--muted); margin-top:8px; line-height:1.45}
    details{
      border:1px dashed rgba(155,176,198,.35);
      border-radius:14px;
      padding:10px 12px;
      background:rgba(0,0,0,.10);
      margin-top:10px;
    }
    summary{cursor:pointer; color:var(--muted); font-size:12px}
    .pill{display:inline-flex; gap:8px; align-items:center; font-size:12px; padding:6px 10px; border:1px solid var(--line); border-radius:999px; color:var(--muted); background:rgba(255,255,255,.02)}
    .alert{
      border:1px solid rgba(255,90,106,.35);
      background:rgba(255,90,106,.10);
      padding:10px 12px; border-radius:14px; margin:0 0 12px;
      display:none;
    }
    .alert.show{display:block}
    .alert b{color:#ffd2d7}

    /* Output layout: 2x2 tiles + EMR block */
    .outGrid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width: 700px){ .outGrid{grid-template-columns:1fr;} }

    .tile{
      border:1px solid var(--line);
      border-radius:16px;
      background:linear-gradient(180deg, rgba(255,255,255,.02) 0%, rgba(0,0,0,.08) 100%);
      overflow:hidden;
    }
    .tile .thd{padding:10px 12px; border-bottom:1px solid var(--line); background:rgba(0,0,0,.10); display:flex; justify-content:space-between; align-items:center; gap:8px}
    .tile .thd h3{margin:0; font-size:13px}
    .tile .tbd{padding:10px 12px}
    ul{margin:0; padding-left:18px}
    li{margin:6px 0; font-size:13px; line-height:1.45}
    .muted{color:var(--muted)}
    .mono{font-family:var(--mono)}
    pre{
      white-space:pre-wrap;
      margin:0;
      padding:12px;
      background:rgba(0,0,0,.22);
      border:1px solid var(--line);
      border-radius:14px;
      min-height:220px;
      font-size:12.5px;
      line-height:1.45;
    }
    .toggleRow{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .seg{
      display:inline-flex; border:1px solid var(--line); border-radius:999px; overflow:hidden;
      background:rgba(255,255,255,.02)
    }
    .seg button{
      border:0; border-right:1px solid var(--line);
      border-radius:0; padding:7px 10px; background:transparent; color:var(--muted); font-size:12px;
    }
    .seg button:last-child{border-right:0}
    .seg button.active{background:rgba(90,169,255,.12); color:var(--text)}
    .footer{margin-top:10px; color:var(--muted); font-size:12px; line-height:1.5}
    .icd{color:var(--muted); font-size:12px}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>1ì°¨ ì˜ë£Œê¸°ê´€ìš©: ê°ë³„ 3(ì§ˆí™˜+ICD) Â· ìœ„í—˜ ì§ˆë¬¸ 3 Â· EMR ë³µë¶™</h1>
        <div class="sub">
          í•„ìˆ˜ ì…ë ¥ì€ <b>ë‚˜ì´Â·ì„±ë³„Â·ì£¼ì¦ìƒ</b>ë§Œ. ë‚˜ë¨¸ì§€ëŠ” ì„ íƒ. ì¶œë ¥ì€ ì§§ê²Œ ë³´ì´ê³ , ì•„ë˜ì— <b>EMRì— ë°”ë¡œ ë¶™ì—¬ë„£ëŠ” ë…¸íŠ¸</b>ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
        </div>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
        <span class="badge">âš ï¸ ì§„ë‹¨/ì¹˜ë£Œ ì§€ì‹œ ì•„ë‹˜</span>
        <span class="badge">ğŸ”’ PHI ìµœì†Œ ì…ë ¥ ê¶Œì¥</span>
        <span class="badge">ğŸ“ ë³µì‚¬ 1í´ë¦­</span>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Input -->
      <div class="card">
        <div class="hd">
          <h2>ì…ë ¥</h2>
          <div class="toggleRow">
            <span class="pill" id="modePill">ìë™ ìƒì„±</span>
            <div class="seg" aria-label="detail toggle">
              <button id="shortBtn" class="active" type="button">ì§§ê²Œ</button>
              <button id="detailBtn" type="button">ì¡°ê¸ˆ ë”</button>
            </div>
          </div>
        </div>
        <div class="bd">
          <div class="row">
            <div>
              <label>ë‚˜ì´ (í•„ìˆ˜)</label>
              <input id="age" type="number" min="0" placeholder="ì˜ˆ: 42" />
            </div>
            <div>
              <label>ì„±ë³„ (í•„ìˆ˜)</label>
              <select id="sex">
                <option value="">ì„ íƒ</option>
                <option value="F">ì—¬</option>
                <option value="M">ë‚¨</option>
                <option value="O">ê¸°íƒ€/ë¯¸ìƒ</option>
              </select>
            </div>
          </div>

          <div style="margin-top:10px">
            <label>ì£¼ì¦ìƒ/ìƒí™© (í•„ìˆ˜) â€” í™˜ì ë§ ê·¸ëŒ€ë¡œ ì ì–´ë„ ë¨</label>
            <textarea id="cc" placeholder="ì˜ˆ: 'ê°€ìŠ´ì´ ì¥ì–´ì§œë“¯ ì•„í”„ê³  ì‹ì€ë•€ì´ ë‚˜ìš”. 2ì‹œê°„ ì „ë¶€í„°. ìˆ¨ë„ ì°¨ìš”.'"></textarea>
          </div>

          <details>
            <summary>ì¶”ê°€ ì •ë³´(ì„ íƒ) â€” ìˆìœ¼ë©´ ë” specificí•˜ê²Œ ìƒì„±</summary>
            <div class="row" style="margin-top:10px">
              <div>
                <label>ì¦ìƒ ì‹œì‘/ê¸°ê°„</label>
                <input id="duration" placeholder="ì˜ˆ: 2ì‹œê°„ ì „ / 3ì¼ì§¸" />
              </div>
              <div>
                <label>í™œë ¥ì§•í›„/SpO2</label>
                <input id="vitals" placeholder="ì˜ˆ: BP 90/60 HR 120 SpO2 90%" />
              </div>
            </div>
            <div class="row" style="margin-top:10px">
              <div>
                <label>ê¸°ì €ì§ˆí™˜/ì•½ë¬¼</label>
                <input id="pmh" placeholder="ì˜ˆ: HTN, DM / í•­ì‘ê³ ì œ ë³µìš©" />
              </div>
              <div>
                <label>ì„ì‹ /ì‚°í›„</label>
                <select id="preg">
                  <option value="">í•´ë‹¹ ì—†ìŒ/ë¯¸ìƒ</option>
                  <option value="pregnant">ì„ì‹  ì¤‘</option>
                  <option value="postpartum">ì‚°í›„(6ì£¼ ì´ë‚´)</option>
                </select>
              </div>
            </div>
            <div style="margin-top:10px">
              <label>ì¶”ê°€ ë©”ëª¨</label>
              <input id="memo" placeholder="ì˜ˆ: ìµœê·¼ ìˆ˜ìˆ /ì¥ê±°ë¦¬, ì™¸ìƒ, ë°œì—´, ê°í˜ˆ, í‘ìƒ‰ë³€ ë“±" />
            </div>
          </details>

          <div class="btns">
            <button class="primary" id="genBtn">ìƒì„±</button>
            <button id="copyAllBtn">EMR ë…¸íŠ¸ ë³µì‚¬</button>
            <button class="danger" id="resetBtn">ì´ˆê¸°í™”</button>
          </div>

          <div class="hint">
            ì •ë³´ê°€ ë¶€ì¡±í•˜ë©´ <b>â€˜ë¯¸ìƒâ€™</b>ìœ¼ë¡œ ìë™ ì±„ìš°ê³ ë„ ë™ì‘. (ëª©ì : EMR ë³µë¶™)
          </div>
        </div>
      </div>

      <!-- RIGHT: Output -->
      <div class="card">
        <div class="hd">
          <h2>ì¶œë ¥</h2>
          <span class="pill" id="categoryPill">ì¹´í…Œê³ ë¦¬: ìë™</span>
        </div>
        <div class="bd">
          <div class="alert" id="alertBox">
            <div><b>ë ˆë“œí”Œë˜ê·¸ ê°€ëŠ¥ì„±</b> í‚¤ì›Œë“œ ê°ì§€ â†’ ì‘ê¸‰/ì¦‰ì‹œí‰ê°€ í•„ìš” ì—¬ë¶€ë¶€í„° í™•ì¸</div>
            <div class="muted" id="alertText" style="margin-top:6px;font-size:12px"></div>
          </div>

          <div class="outGrid">
            <div class="tile">
              <div class="thd">
                <h3>ê°ë³„ 3 (ì§ˆí™˜ + ICD-10)</h3>
                <button type="button" id="copyDxBtn">ë³µì‚¬</button>
              </div>
              <div class="tbd">
                <ul id="dxList"><li class="muted">â€˜ìƒì„±â€™ ëˆ„ë¥´ë©´ ì±„ì›Œì§</li></ul>
              </div>
            </div>

            <div class="tile">
              <div class="thd">
                <h3>ë†“ì¹˜ë©´ ìœ„í—˜í•œ ì§ˆë¬¸ 3</h3>
                <button type="button" id="copyQBtn">ë³µì‚¬</button>
              </div>
              <div class="tbd">
                <ul id="qList"><li class="muted">â€˜ìƒì„±â€™ ëˆ„ë¥´ë©´ ì±„ì›Œì§</li></ul>
              </div>
            </div>

            <div class="tile">
              <div class="thd">
                <h3>í™˜ìì—ê²Œ ë°”ë¡œ ì „ë‹¬(ì•ˆì „ë§) 3ì¤„</h3>
                <button type="button" id="copySNBtn">ë³µì‚¬</button>
              </div>
              <div class="tbd">
                <ul id="snList"><li class="muted">â€˜ìƒì„±â€™ ëˆ„ë¥´ë©´ ì±„ì›Œì§</li></ul>
              </div>
            </div>

            <div class="tile">
              <div class="thd">
                <h3>ë‹¤ìŒ ì•¡ì…˜(1ì°¨ ì§„ë£Œìš©) 3ì¤„</h3>
                <button type="button" id="copyNextBtn">ë³µì‚¬</button>
              </div>
              <div class="tbd">
                <ul id="nextList"><li class="muted">â€˜ìƒì„±â€™ ëˆ„ë¥´ë©´ ì±„ì›Œì§</li></ul>
              </div>
            </div>
          </div>

          <div style="margin-top:10px" class="tile">
            <div class="thd">
              <h3>EMRì— ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ê¸°</h3>
              <div style="display:flex; gap:8px; flex-wrap:wrap;">
                <button type="button" class="primary" id="copyNoteBtn">ë…¸íŠ¸ ë³µì‚¬</button>
                <button type="button" id="downloadBtn">.txt ì €ì¥</button>
              </div>
            </div>
            <div class="tbd">
              <pre id="noteOut" class="mono">(ì—¬ê¸°ì— ìƒì„±ë¨)</pre>
            </div>
          </div>

          <div class="footer">
            ë©´ì±…: ë³¸ í˜ì´ì§€ëŠ” ë¬¸êµ¬/ëˆ„ë½ ë°©ì§€ ë³´ì¡° ë„êµ¬ì´ë©° ì§„ë‹¨Â·ì¹˜ë£Œë¥¼ ëŒ€ì²´í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
let DETAIL = "short"; // short | detail
const $ = (id) => document.getElementById(id);

function toast(msg){
  const el = document.createElement("div");
  el.textContent = msg;
  el.style.position="fixed";
  el.style.bottom="18px";
  el.style.left="50%";
  el.style.transform="translateX(-50%)";
  el.style.padding="10px 12px";
  el.style.border="1px solid rgba(90,169,255,.35)";
  el.style.background="rgba(90,169,255,.12)";
  el.style.borderRadius="12px";
  el.style.color="white";
  el.style.zIndex=9999;
  el.style.fontSize="13px";
  el.style.boxShadow="0 10px 25px rgba(0,0,0,.35)";
  document.body.appendChild(el);
  setTimeout(()=>el.remove(), 1200);
}
function normalize(s){ return (s||"").toLowerCase(); }
function hasAny(text, kws){
  const t = normalize(text);
  return kws.some(k=>t.includes(normalize(k)));
}
function copyText(txt){
  navigator.clipboard.writeText(txt).then(()=>toast("ë³µì‚¬ ì™„ë£Œ")).catch(()=>alert("ë³µì‚¬ ì‹¤íŒ¨(ê¶Œí•œ í™•ì¸)"));
}
function downloadText(filename, txt){
  const blob = new Blob([txt], {type:"text/plain;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}
function setList(el, items){
  el.innerHTML="";
  items.forEach(x=>{
    const li=document.createElement("li");
    li.textContent=x;
    el.appendChild(li);
  });
}
function nowStamp(){
  const d = new Date();
  const pad = n => String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function sexK(sex){
  if(sex==="M") return "ë‚¨";
  if(sex==="F") return "ì—¬";
  return "ì„±ë³„ ë¯¸ìƒ";
}
function safe(v, fallback="ë¯¸ìƒ"){
  return (v && String(v).trim().length) ? String(v).trim() : fallback;
}

/* =========================
   ë‚´ë¶€ ì¹´í…Œê³ ë¦¬(ë…¸ì¶œì€ â€œì¹´í…Œê³ ë¦¬: ìë™â€ ì •ë„ë§Œ)
   dxëŠ” ë°˜ë“œì‹œ â€œì‹¤ì œ ì§ˆí™˜ + ICD-10â€ 3ê°œë¡œ êµ¬ì„±
   ========================= */
const CATS = [
  {
    id:"chest",
    name:"í‰í†µ/í‰ë¶€ë¶ˆí¸",
    match:["í‰í†µ","ê°€ìŠ´í†µì¦","ê°€ìŠ´ì´","ì¥ì–´ì§œ","ì••ë°•ê°","ë°©ì‚¬","ì‹ì€ë•€","chest pain","èƒ¸ç—›","í„±","ì™¼íŒ”"],
    red:["ì‹¤ì‹ ","ì˜ì‹ì €í•˜","í˜¸í¡ê³¤ë€","ì €í˜ˆì••","SpO2","ì²­ìƒ‰ì¦","ì‹ ê²½í•™ì ","ë§ˆë¹„"],
    dx:[
      {d:"ê¸‰ì„±ì‹¬ê·¼ê²½ìƒ‰(AMI)", icd:"I21.9"},
      {d:"íìƒ‰ì „ì¦(PE) (acute, w/o acute cor pulmonale)", icd:"I26.99"},
      {d:"ëŒ€ë™ë§¥ë°•ë¦¬(Dissection of aorta, unspecified site)", icd:"I71.00"},
    ],
    q:[
      "í†µì¦ ì‹œì‘: ê°‘ìê¸°? ìµœëŒ€ ê°•ë„ëŠ” ì–¸ì œ? (ë°•ë¦¬/AMI ìª½)", 
      "ë°©ì‚¬(í„±/íŒ”/ë“±)Â·ì‹ì€ë•€Â·êµ¬ì—­Â·ì‹¤ì‹ Â·í˜¸í¡ê³¤ë€ ë™ë°˜? (AMI/PE/ë°•ë¦¬)",
      "í˜ˆì „/ì‹¬í˜ˆê´€ ìœ„í—˜: ìµœê·¼ ìˆ˜ìˆ Â·ì¥ê±°ë¦¬Â·DVT, OCP/ì„ì‹ Â·ì‚°í›„, í¡ì—°, HTN/DM?"
    ],
    sn:(ctx)=>[
      `í˜„ì¬ ì¦ìƒì€ ì‹¬ì¥/í/ëŒ€í˜ˆê´€ ì›ì¸ ê°€ëŠ¥ì„±ì´ ìˆì–´ ${ctx.urgentWord} í‰ê°€ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`,
      "í˜¸í¡ê³¤ë€Â·ì‹¤ì‹ Â·ì§€ì†/ì•…í™”ë˜ëŠ” í‰í†µÂ·ì‹ì€ë•€Â·ì‹ ê²½í•™ì  ì¦ìƒì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì‘ê¸‰ì‹¤ë¡œ ê°€ì„¸ìš”.",
      "ê²€ì‚¬ê°€ ëŠ¦ì–´ì§€ë©´ ìœ„í—˜í•  ìˆ˜ ìˆì–´, ìƒíƒœê°€ ì• ë§¤í•´ë„ ì•…í™” ì‹œ ì§€ì²´í•˜ì§€ ë§ê³  ë°”ë¡œ ë°©ë¬¸í•˜ì„¸ìš”."
    ],
    next:(ctx)=>[
      `ìš°ì„ ìˆœìœ„: í™œë ¥/SpO2 í™•ì¸ â†’ ${ctx.urgentWord} ì‹¬ì „ë„/ì‹¬ê·¼íš¨ì†Œ/ì˜ìƒ í•„ìš” ì—¬ë¶€ íŒë‹¨.`,
      "PE/ë°•ë¦¬ ìœ„í—˜ ì‹ í˜¸ê°€ ìˆìœ¼ë©´ ì§€ì²´ ì—†ì´ ì‘ê¸‰ì‹¤/ìƒê¸‰ê¸°ê´€ ì˜ë¢°.",
      "ë¶ˆí™•ì‹¤í•˜ë©´ ë‹¨ê¸° ì¬í‰ê°€ ì‹œê°„(ì˜ˆ: 24h ì´ë‚´)ê³¼ ì•…í™” ê¸°ì¤€ì„ ëª…í™•íˆ ì•ˆë‚´."
    ]
  },
  {
    id:"dyspnea",
    name:"í˜¸í¡ê³¤ë€",
    match:["í˜¸í¡ê³¤ë€","ìˆ¨ì°¸","ìˆ¨ì´ ì°¨","dyspnea","ì²œëª…","wheezing","SpO2","ê°í˜ˆ","ê°€ë˜","ì²­ìƒ‰ì¦"],
    red:["SpO2","ì²­ìƒ‰ì¦","ì˜ì‹ì €í•˜","ì €í˜ˆì••","ê°í˜ˆ","í‰í†µ"],
    dx:[
      {d:"íë ´(Pneumonia, unspecified organism)", icd:"J18.9"},
      {d:"ì²œì‹ ê¸‰ì„± ì•…í™”(Asthma with acute exacerbation)", icd:"J45.901"},
      {d:"ì‹¬ë¶€ì „(Heart failure, unspecified)", icd:"I50.9"},
    ],
    q:[
      "SpO2/í˜¸í¡ìˆ˜/ë¬¸ì¥ ë§í•˜ê¸° ê°€ëŠ¥? ì²­ìƒ‰ì¦Â·ì˜ì‹ë³€í™”? (í˜¸í¡ë¶€ì „ ìŠ¤í¬ë¦¬ë‹)",
      "í‰í†µÂ·ê°í˜ˆÂ·ë‹¤ë¦¬ë¶€ì¢…/í†µì¦Â·ìµœê·¼ ìˆ˜ìˆ /ì¥ê±°ë¦¬Â·ì„ì‹ /ì‚°í›„? (PE/ìœ„í—˜)",
      "ë°œì—´Â·ê°€ë˜Â·í‰ë¶€í†µì¦/ì‹¬ë¶€ì „ ë³‘ë ¥Â·í¡ì—°ë ¥Â·ì²œì‹/COPD ë³‘ë ¥? (íë ´/ì²œì‹/ì‹¬ë¶€ì „)"
    ],
    sn:(ctx)=>[
      `í˜¸í¡ê³¤ë€ì€ ì•…í™” ì‹œ ìœ„í—˜í•  ìˆ˜ ìˆì–´ ${ctx.urgentWord} ì‚°ì†Œí¬í™”ë„/í™œë ¥ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.`,
      "ë§ì´ ëŠê¸¸ ì •ë„ ìˆ¨ì°¸, SpO2 ì €í•˜, í‰í†µÂ·ê°í˜ˆÂ·ì˜ì‹ë³€í™”ê°€ ìˆìœ¼ë©´ ì¦‰ì‹œ ì‘ê¸‰ì‹¤ë¡œ ê°€ì„¸ìš”.",
      "ì¦ìƒì´ ì§€ì†/ì•…í™”í•˜ë©´ ì§€ì²´í•˜ì§€ ë§ê³  ì¬ë‚´ì›í•˜ê±°ë‚˜ ì‘ê¸‰ì‹¤ í‰ê°€ê°€ í•„ìš”í•©ë‹ˆë‹¤."
    ],
    next:(ctx)=>[
      `ìš°ì„ ìˆœìœ„: SpO2/í˜¸í¡ìˆ˜ í™•ì¸ â†’ ${ctx.urgentWord} ì‚°ì†Œ/ê¸°ê´€ì§€í™•ì¥ì œ/í‰ë¶€í‰ê°€ í•„ìš” ì—¬ë¶€.`,
      "ê°ì—¼ ì˜ì‹¬ ì‹œ CXR/ê²€ì‚¬ ê³ ë ¤, ì‹¬ë¶€ì „ ì˜ì‹¬ ì‹œ ë¶€ì¢…/ì²­ì§„/ì²´ì¤‘ë³€í™” í™•ì¸.",
      "PE/ê¸‰ì„±ì•…í™” ì˜ì‹¬ ì‹œ ì¦‰ì‹œ ì˜ë¢° ê¸°ì¤€(SpO2â†“, í‰í†µ, ê°í˜ˆ ë“±) ëª…í™•í™”."
    ]
  },
  {
    id:"abd",
    name:"ë³µí†µ",
    match:["ë³µí†µ","ë°°ê°€","ë³µë¶€","abdominal","êµ¬í† ","í† í˜ˆ","í˜ˆë³€","í‘ìƒ‰ë³€","ë°˜ë°œí†µ","ì˜¤ë¥¸ìª½ì•„ë˜","ìš°í•˜ë³µë¶€"],
    red:["í† í˜ˆ","í˜ˆë³€","í‘ìƒ‰ë³€","ë³µë¶€ê°•ì§","ë°˜ë°œí†µ","ì €í˜ˆì••","ì˜ì‹ì €í•˜","ê³ ì—´","ì„ì‹ ","ì‚°í›„"],
    dx:[
      {d:"ê¸‰ì„± ì¶©ìˆ˜ì—¼(Acute appendicitis, unspecified)", icd:"K35.80"},
      {d:"ê¸‰ì„± ë‹´ë‚­ì—¼(Acute cholecystitis)", icd:"K81.0"},
      {d:"ìœ„ì¥ê´€ ì¶œí˜ˆ(GI hemorrhage, unspecified)", icd:"K92.2"},
    ],
    q:[
      "í†µì¦ ìœ„ì¹˜/ì´ë™(ìš°í•˜ë³µë¶€? RUQ?), ë°˜ë°œí†µÂ·ê°•ì§, ì§€ì† ì•…í™”? (ê¸‰ì„±ë³µì¦)",
      "êµ¬í† /ë°œì—´/í™©ë‹¬Â·í‘ìƒ‰ë³€Â·í˜ˆë³€Â·í† í˜ˆ ë™ë°˜? (ë‹´ë‚­ì—¼/ì¶œí˜ˆ)",
      "ì„ì‹  ê°€ëŠ¥/ì‚°í›„ ì—¬ë¶€ + í•­ì‘ê³ ì œ/NSAID ë³µìš© + ìˆ˜ìˆ ë ¥(ìœ ì°©) í™•ì¸?"
    ],
    sn:(ctx)=>[
      `ë³µí†µì€ ì›ì¸ì— ë”°ë¼ ìˆ˜ìˆ /ì¶œí˜ˆ ê°€ëŠ¥ì„±ì´ ìˆì–´ ${ctx.urgentWord} ê²½ê³  ì‹ í˜¸ í™•ì¸ì´ ì¤‘ìš”í•©ë‹ˆë‹¤.`,
      "ì§€ì†Â·ì•…í™” í†µì¦, ë°˜ë³µ êµ¬í† , ê³ ì—´, í‘ìƒ‰ë³€/í˜ˆë³€/í† í˜ˆ, ì‹¤ì‹ /ì €í˜ˆì••ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì‘ê¸‰ì‹¤ë¡œ ê°€ì„¸ìš”.",
      "ì˜¤ëŠ˜ ì¢‹ì•„ì ¸ë„ ë‹¤ì‹œ ì•…í™”í•˜ë©´ ë°”ë¡œ ì¬í‰ê°€ê°€ í•„ìš”í•©ë‹ˆë‹¤."
    ],
    next:(ctx)=>[
      `ìš°ì„ ìˆœìœ„: ë³µë¶€ì§„ì°° + ${ctx.urgentWord} ê¸‰ì„±ë³µì¦(ë°˜ë°œí†µ/ê°•ì§) ì—¬ë¶€ í™•ì¸.`,
      "ì¶œí˜ˆ ì˜ì‹¬(í‘ìƒ‰ë³€/í† í˜ˆ/ì–´ì§€ëŸ¼) ì‹œ ì¦‰ì‹œ ì‘ê¸‰ì‹¤/ìƒê¸‰ê¸°ê´€.",
      "ê²½ë¯¸í•´ë„ ì¬í‰ê°€ ì‹œê°„ê³¼ ì•…í™” ê¸°ì¤€ì„ ëª…í™•íˆ(íŠ¹íˆ ì•¼ê°„/ì£¼ë§)."
    ]
  },
  {
    id:"head",
    name:"ë‘í†µ",
    match:["ë‘í†µ","ë¨¸ë¦¬ê°€","headache","ë²ˆê°œ","ìµœì•…","ê²½ë¶€ê°•ì§","ì‹œì•¼","ë§ˆë¹„","ì˜ì‹","êµ¬í† ","ê²½ë ¨"],
    red:["ê°‘ìê¸°","ë²ˆê°œ","ìµœì•…","ê²½ë¶€ê°•ì§","ì˜ì‹ì €í•˜","ë§ˆë¹„","ì–¸ì–´","ì‹œì•¼","ê³ ì—´","ê²½ë ¨","ì„ì‹ ","ì‚°í›„"],
    dx:[
      {d:"ì§€ì£¼ë§‰í•˜ì¶œí˜ˆ(Subarachnoid hemorrhage, unspecified)", icd:"I60.9"},
      {d:"ìˆ˜ë§‰ì—¼(Meningitis, unspecified)", icd:"G03.9"},
      {d:"í¸ë‘í†µ(Migraine, unspecified, not intractable, w/o status)", icd:"G43.909"},
    ],
    q:[
      "ë°œë³‘ ì–‘ìƒ(ê°‘ìê¸°/ë²ˆê°œ)Â·â€˜í‰ìƒ ìµœì•…â€™Â·ì‹ ê²½í•™ì  ê²°ì†(ë§ˆë¹„/ì–¸ì–´/ì‹œì•¼)?",
      "ë°œì—´Â·ê²½ë¶€ê°•ì§Â·ì˜ì‹ë³€í™”Â·ê²½ë ¨Â·ë°œì§„ ë™ë°˜? (ìˆ˜ë§‰ì—¼/ì¤‘ì¦)",
      "ì„ì‹ /ì‚°í›„, í•­ì‘ê³ ì œ, ì™¸ìƒ, ë©´ì—­ì €í•˜/ì•” ë³‘ë ¥? (ê³ ìœ„í—˜)"
    ],
    sn:(ctx)=>[
      `ê°‘ìê¸° ì‹œì‘í•œ ì‹¬í•œ ë‘í†µì€ ${ctx.urgentWord} ì‘ê¸‰ í‰ê°€ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`,
      "ì˜ì‹ë³€í™”Â·ë§ˆë¹„Â·ì‹œì•¼ì¥ì• Â·ê²½ë ¨Â·ê³ ì—´Â·ê²½ë¶€ê°•ì§ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì‘ê¸‰ì‹¤ë¡œ ê°€ì„¸ìš”.",
      "í†µì¦ì´ ì§€ì†/ì•…í™”í•˜ê±°ë‚˜ ìƒˆ ì¦ìƒì´ ìƒê¸°ë©´ ë°”ë¡œ ì¬ë‚´ì›í•˜ì„¸ìš”."
    ],
    next:(ctx)=>[
      `ìš°ì„ ìˆœìœ„: ë ˆë“œí”Œë˜ê·¸(ê¸‰ì„±ë°œë³‘/ì‹ ê²½í•™ì  ê²°ì†/ë°œì—´) í™•ì¸ â†’ ${ctx.urgentWord} ì˜ìƒ/ì‘ê¸‰ ì˜ë¢° ê³ ë ¤.`,
      "ì§„í†µì œë¡œ í˜¸ì „ë¼ë„ â€˜íŒ¨í„´ ë³€í™”â€™ë©´ ì¬í‰ê°€ í•„ìš”.",
      "ì¬ë‚´ì› ê¸°ì¤€(ì‹ ê²½í•™ì  ì¦ìƒ/êµ¬í†  ì§€ì†/ì˜ì‹ë³€í™”)ì„ êµ¬ì²´ì ìœ¼ë¡œ ì œì‹œ."
    ]
  }
];

/* ê³µí†µ ë ˆë“œí”Œë˜ê·¸ í‚¤ì›Œë“œ */
const COMMON_RED = ["ì˜ì‹ì €í•˜","ì‹¤ì‹ ","ê²½ë ¨","ë§ˆë¹„","ë§ì´ ì–´ëˆŒ","ì²­ìƒ‰ì¦","ì €í˜ˆì••","SpO2","ê°í˜ˆ","í† í˜ˆ","í˜ˆë³€","í‘ìƒ‰ë³€","í‰í†µ","í˜¸í¡ê³¤ë€","ê°‘ìê¸°","ìµœì•…","ê²½ë¶€ê°•ì§","ê³ ì—´"];

/* =========================
   ì¹´í…Œê³ ë¦¬ ì„ íƒ + â€œì¦ìƒ-specificâ€ ë³´ê°•(íŒíŠ¸ ë‹¨ì–´)
   - urgentWord: â€œì¦‰ì‹œ/ë‹¹ì¼â€ ê°™ì€ í‘œí˜„ì„ ì…ë ¥ ë‹¨ì„œë¡œ ë°”ê¿ˆ
   ========================= */
function pickCategory(text){
  for(const c of CATS){
    if(hasAny(text, c.match)) return c;
  }
  return null;
}

function detectRed(text, cat){
  const hits = [];
  const pool = [...new Set([...(cat?.red||[]), ...COMMON_RED])];
  for(const k of pool){
    if(normalize(text).includes(normalize(k))) hits.push(k);
  }
  return hits;
}

/* ì¦ìƒë³„ urgency íŒíŠ¸(ì•„ì£¼ ë‹¨ìˆœí•˜ì§€ë§Œ ì¶œë ¥ì´ ë” specificí•˜ê²Œ ë³´ì´ë„ë¡) */
function deriveContext(fullText, vitalsText){
  const t = normalize(fullText + " " + vitalsText);
  const urgent = hasAny(t, ["ì €í˜ˆì••","spO2 9","spO2:9","90/","ì˜ì‹ì €í•˜","ì‹¤ì‹ ","ê²½ë ¨","ì²­ìƒ‰ì¦","ê°í˜ˆ","í† í˜ˆ","í˜ˆë³€","í‘ìƒ‰ë³€"]) ||
                 hasAny(t, ["ê°‘ìê¸°","ë²ˆê°œ","ìµœì•…"]);
  return { urgentWord: urgent ? "ì¦‰ì‹œ" : "ê°€ëŠ¥í•˜ë©´ ë‹¹ì¼" };
}

/* =========================
   Generic (ì¹´í…Œê³ ë¦¬ ëª» ì¡ì„ ë•Œë„ â€œì§ˆí™˜+ICD 3ê°œâ€ë¡œ ê°•ì œ)
   - í‚¤ì›Œë“œë¡œ ì•½ê°„ì´ë¼ë„ ë°©í–¥ì„ ì¡ìŒ
   ========================= */
function genericDx(full){
  const t = normalize(full);

  // ë°œì—´/ê¸°ì¹¨
  if(hasAny(t, ["ë°œì—´","ì—´","ì˜¤í•œ","ê¸°ì¹¨","ê°€ë˜","ì¸í›„","ëª©ì•„í””","sore throat"])){
    return [
      {d:"ê¸‰ì„± ìƒê¸°ë„ê°ì—¼(Acute URI)", icd:"J06.9"},
      {d:"ê¸‰ì„± ê¸°ê´€ì§€ì—¼(Acute bronchitis, unspecified)", icd:"J20.9"},
      {d:"íë ´(Pneumonia, unspecified organism)", icd:"J18.9"},
    ];
  }
  // ì–´ì§€ëŸ¼/ì‹¤ì‹ 
  if(hasAny(t, ["ì–´ì§€ëŸ¼","í˜„ê¸°ì¦","vertigo","ì‹¤ì‹ ","í•‘"])){
    return [
      {d:"ì‹¤ì‹  ë° í—ˆíƒˆ(Syncope and collapse)", icd:"R55"},
      {d:"ì–‘ì„± ëŒë°œì„± ì²´ìœ„ì„± í˜„í›ˆ(BPPV)", icd:"H81.10"},
      {d:"ì „ì •ì‹ ê²½ì—¼(Vestibular neuritis)", icd:"H81.20"},
    ];
  }
  // ìš”ë¡œì¦ìƒ
  if(hasAny(t, ["ë°°ë‡¨","ì†Œë³€","ë¹ˆë‡¨","ì ˆë°•ë‡¨","ë°°ë‡¨í†µ","í˜ˆë‡¨","ì˜†êµ¬ë¦¬"])){
    return [
      {d:"ê¸‰ì„± ë°©ê´‘ì—¼(Acute cystitis without hematuria)", icd:"N30.00"},
      {d:"ì‹ ìš°ì‹ ì—¼(Acute pyelonephritis)", icd:"N10"},
      {d:"ìš”ë¡œê²°ì„(Calculus of kidney, unspecified)", icd:"N20.0"},
    ];
  }
  // í‰í†µ/í˜¸í¡
  if(hasAny(t, ["ê°€ìŠ´","í‰","ìˆ¨","í˜¸í¡","dyspnea","chest"])){
    return [
      {d:"ê¸‰ì„±ì‹¬ê·¼ê²½ìƒ‰(AMI)", icd:"I21.9"},
      {d:"íìƒ‰ì „ì¦(PE)", icd:"I26.99"},
      {d:"íë ´(Pneumonia, unspecified organism)", icd:"J18.9"},
    ];
  }
  // ë³µí†µ/êµ¬í† 
  if(hasAny(t, ["ë³µí†µ","ë°°","êµ¬í† ","ì„¤ì‚¬","í˜ˆë³€","í† í˜ˆ"])){
    return [
      {d:"ê¸‰ì„± ìœ„ì¥ì—¼(Acute gastroenteritis, unspecified)", icd:"K52.9"},
      {d:"ê¸‰ì„± ì¶©ìˆ˜ì—¼(Acute appendicitis, unspecified)", icd:"K35.80"},
      {d:"ìœ„ì¥ê´€ ì¶œí˜ˆ(GI hemorrhage, unspecified)", icd:"K92.2"},
    ];
  }
  // ë‘í†µ
  if(hasAny(t, ["ë‘í†µ","ë¨¸ë¦¬","headache","ì‹œì•¼","ë§ˆë¹„","ê²½ë¶€"])){
    return [
      {d:"í¸ë‘í†µ(Migraine, unspecified)", icd:"G43.909"},
      {d:"ê¸´ì¥í˜• ë‘í†µ(Tension-type headache, unspecified)", icd:"G44.209"},
      {d:"ì§€ì£¼ë§‰í•˜ì¶œí˜ˆ(Subarachnoid hemorrhage, unspecified)", icd:"I60.9"},
    ];
  }

  // ì™„ì „ ì¼ë°˜
  return [
    {d:"ê¸‰ì„± í†µì¦(Acute pain, unspecified)", icd:"R52"},
    {d:"ê¸°íƒ€ ê¶Œíƒœê° ë° í”¼ë¡œ(Malaise and fatigue)", icd:"R53.81"},
    {d:"ìƒì„¸ë¶ˆëª… ì¦ìƒ/ì§•í›„(Other ill-defined symptoms)", icd:"R68.89"},
  ];
}

function genericQs(full){
  const t = normalize(full);
  // ì¦ìƒì— ë§ì¶° ì§ˆë¬¸ì„ ì¡°ê¸ˆ ë°”ê¿ˆ
  if(hasAny(t, ["ê°€ìŠ´","í‰","ìˆ¨","í˜¸í¡","dyspnea","chest"])){
    return [
      "ì‹¤ì‹ /ì˜ì‹ë³€í™”, í˜¸í¡ê³¤ë€, í‰í†µ ì§€ì†/ì•…í™”, ê°í˜ˆ/ì²­ìƒ‰ì¦ ìˆë‚˜ìš”?",
      "í†µì¦ì´ ê°‘ìê¸° ì‹œì‘í–ˆë‚˜ìš”? ë°©ì‚¬í†µ(íŒ”/í„±/ë“±)Â·ì‹ì€ë•€Â·êµ¬ì—­ ë™ë°˜?",
      "ìµœê·¼ ìˆ˜ìˆ /ì¥ê±°ë¦¬/ì„ì‹ Â·ì‚°í›„/í˜ˆì „ ë³‘ë ¥ ë˜ëŠ” HTN/DM/í¡ì—° ìœ„í—˜ì¸ì ìˆë‚˜ìš”?"
    ];
  }
  if(hasAny(t, ["ë³µí†µ","êµ¬í† ","ì„¤ì‚¬","í˜ˆë³€","í† í˜ˆ","í‘ìƒ‰ë³€"])){
    return [
      "ë°˜ë°œí†µ/ë³µë¶€ê°•ì§, ì§€ì† ì•…í™”, ì‹¤ì‹ /ì €í˜ˆì•• ì¦ìƒ ìˆë‚˜ìš”?",
      "í† í˜ˆ/í˜ˆë³€/í‘ìƒ‰ë³€, ë°˜ë³µ êµ¬í† , ê³ ì—´ ë™ë°˜í•˜ë‚˜ìš”?",
      "NSAID/í•­ì‘ê³ ì œ ë³µìš©, ì„ì‹  ê°€ëŠ¥/ì‚°í›„, ìˆ˜ìˆ ë ¥(ìœ ì°©) ìˆë‚˜ìš”?"
    ];
  }
  if(hasAny(t, ["ë‘í†µ","ë¨¸ë¦¬","ê²½ë¶€","ì‹œì•¼","ë§ˆë¹„","ê²½ë ¨","ë²ˆê°œ","ìµœì•…"])){
    return [
      "ê°‘ì‘/ë²ˆê°œë‘í†µ ë˜ëŠ” â€˜í‰ìƒ ìµœì•…â€™ì¸ê°€ìš”? ì‹ ê²½í•™ì  ê²°ì†(ë§ˆë¹„/ì–¸ì–´/ì‹œì•¼) ìˆë‚˜ìš”?",
      "ë°œì—´Â·ê²½ë¶€ê°•ì§Â·ì˜ì‹ë³€í™”Â·ê²½ë ¨ ë™ë°˜í•˜ë‚˜ìš”?",
      "ì™¸ìƒ/í•­ì‘ê³ ì œ/ì„ì‹ Â·ì‚°í›„/ë©´ì—­ì €í•˜Â·ì•” ë³‘ë ¥ ìˆë‚˜ìš”?"
    ];
  }
  return [
    "ì˜ì‹ë³€í™”/ì‹¤ì‹ /í˜¸í¡ê³¤ë€/í‰í†µ/ì¶œí˜ˆ(í† í˜ˆÂ·í˜ˆë³€)/ì‹ ê²½í•™ì  ì¦ìƒ(ë§ˆë¹„Â·ì–¸ì–´Â·ì‹œì•¼) ìˆë‚˜ìš”?",
    "ì¦ìƒì´ ê°‘ìê¸° ì‹œì‘í–ˆë‚˜ìš”? ë¹ ë¥´ê²Œ ì•…í™”í•˜ë‚˜ìš”? í˜„ì¬ ë³´í–‰/ëŒ€í™” ê°€ëŠ¥í•œê°€ìš”?",
    "ê³ ìœ„í—˜ ìš”ì¸(ì„ì‹ Â·ì‚°í›„, í•­ì‘ê³ ì œ, ë©´ì—­ì €í•˜/ì•”, ìµœê·¼ ìˆ˜ìˆ Â·ì¥ê±°ë¦¬, í° ì™¸ìƒ) ìˆë‚˜ìš”?"
  ];
}

function genericSN(ctx){
  return [
    `í˜„ì¬ ì¦ìƒì€ ì›ì¸ì´ í™•ì •ë˜ì§€ ì•Šì•„ ${ctx.urgentWord} ì¬í‰ê°€/ì¶”ê°€ í‰ê°€ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`,
    "í˜¸í¡ê³¤ë€Â·ì‹¤ì‹ Â·ì˜ì‹ë³€í™”Â·ì§€ì† ì•…í™” í†µì¦Â·ì¶œí˜ˆÂ·ì‹ ê²½í•™ì  ì¦ìƒì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì‘ê¸‰ì‹¤ë¡œ ê°€ì„¸ìš”.",
    "ì¦ìƒì´ ì§€ì†/ì•…í™”í•˜ê±°ë‚˜ ìƒˆ ì¦ìƒì´ ìƒê¸°ë©´ ì§€ì²´í•˜ì§€ ë§ê³  ì¬ë‚´ì›í•˜ì„¸ìš”."
  ];
}

function genericNext(ctx){
  return [
    `ìš°ì„ ìˆœìœ„: í™œë ¥/SpO2 í™•ì¸ â†’ ${ctx.urgentWord} ë ˆë“œí”Œë˜ê·¸ ì—¬ë¶€ë¶€í„° ì •ë¦¬.`,
    "ê²€ì‚¬/ì˜ë¢°ê°€ í•„ìš”í•œì§€ íŒë‹¨í•˜ê³ , ë¶ˆí™•ì‹¤í•˜ë©´ ë‹¨ê¸° ì¬í‰ê°€ ì‹œê°„ì„ ì¡ê¸°.",
    "ì•…í™” ê¸°ì¤€(ì‘ê¸‰ì‹¤/ì¦‰ì‹œ ë‚´ì›)ì„ í™˜ìì—ê²Œ ë¬¸ì¥ìœ¼ë¡œ ëª…í™•íˆ ì „ë‹¬."
  ];
}

/* =========================
   í‘œì‹œìš© í¬ë§·
   ========================= */
function dxToLines(dxObjs){
  return dxObjs.map((x)=>`${x.d} (ICD-10: ${x.icd})`);
}
function dxToCopy(dxObjs){
  return dxObjs.map((x,i)=>`#${i+1} ${x.d} (ICD-10: ${x.icd})`).join("\n");
}

/* =========================
   EMR ë…¸íŠ¸ ìƒì„± (ë°”ë¡œ ë¶™ì—¬ë„£ê¸°ìš©)
   ========================= */
function buildNote(input, cat, dxObjs, qs, sn, next){
  const ts = nowStamp();
  const age = safe(input.age, "ë‚˜ì´ ë¯¸ìƒ");
  const sex = sexK(input.sex);
  const cc = safe(input.cc, "ì£¼ì¦ìƒ ë¯¸ìƒ");

  const duration = safe(input.duration, "ë¯¸ìƒ");
  const vitals = safe(input.vitals, "ë¯¸ìƒ");
  const pmh = safe(input.pmh, "ë¯¸ìƒ");
  const preg = input.preg ? (input.preg==="pregnant" ? "ì„ì‹  ì¤‘" : "ì‚°í›„(6ì£¼ ì´ë‚´)") : "ë¯¸ìƒ/í•´ë‹¹ ì—†ìŒ";
  const memo = safe(input.memo, "ì—†ìŒ/ë¯¸ìƒ");
  const catName = cat ? cat.name : "ì¼ë°˜(ë²”ìš©)";

  const ddxBlock = dxObjs.map((x,i)=>`- #${i+1} ${x.d} (ICD-10: ${x.icd})`).join("\n");
  const qBlock = qs.map((q,i)=>`- Q${i+1}) ${q}  [ ]ì˜ˆ  [ ]ì•„ë‹ˆì˜¤  [ ]ë¯¸ìƒ`).join("\n");
  const snBlock = sn.map((s)=>`- ${s}`).join("\n");
  const nextBlock = next.map((s)=>`- ${s}`).join("\n");

  const base = [
    `=== Encounter Note (paste-ready) ===`,
    `Timestamp: ${ts}`,
    `Category: ${catName}`,
    ``,
    `[Chief Complaint]`,
    `- ${age}ì„¸ ${sex} / ì£¼ì¦ìƒ: ${cc}`,
    ``,
    `[HPI]`,
    `- ì‹œì‘/ê¸°ê°„: ${duration}`,
    `- ì¶”ê°€ ë©”ëª¨/ë™ë°˜: ${memo}`,
    ``,
    `[Vitals/Key Data]`,
    `- ${vitals}`,
    ``,
    `[PMH/Meds / Pregnancy]`,
    `- ê¸°ì €ì§ˆí™˜/ì•½ë¬¼: ${pmh}`,
    `- ì„ì‹ /ì‚°í›„: ${preg}`,
    ``,
    `[Assessment - Differential (Top 3, ICD-10 included)]`,
    `${ddxBlock}`,
    ``,
    `[High-risk screen (asked)]`,
    `${qBlock}`,
    ``,
    `[Plan / Next steps]`,
    `${nextBlock}`,
    ``,
    `[Safety-net (patient instructions)]`,
    `${snBlock}`,
    ``,
    `[Patient understanding]`,
    `- ì„¤ëª… ë° ì£¼ì˜ì‚¬í•­ ì•ˆë‚´í–ˆê³ , í™˜ì ì´í•´/ë™ì˜ ì—¬ë¶€: [ ]ì´í•´í•¨  [ ]ì¶”ê°€ì„¤ëª… í•„ìš”  [ ]ë¯¸ìƒ`,
  ];

  if(DETAIL==="detail"){
    base.push(
      ``,
      `[Documentation add-on]`,
      `- í™˜ì ì„ íƒ(ê²€ì‚¬/ì´ì†¡/ì‘ê¸‰ì‹¤ ë°©ë¬¸) ë° ê±°ë¶€/ì§€ì—° ì‹œ ì‚¬ìœ : [ ]ì—†ìŒ  [ ]ìˆìŒ( )  [ ]ë¯¸ìƒ`,
      `- ì¶”ì  ê³„íš(ì¬í‰ê°€/ê²€ì‚¬ ê²°ê³¼ í™•ì¸/ì—°ë½): [ ]ì•ˆë‚´í•¨  [ ]ë¯¸ìƒ`
    );
  }

  return base.join("\n");
}

/* =========================
   ë Œë”
   ========================= */
function renderAll(){
  const input = {
    age: $("age").value,
    sex: $("sex").value,
    cc: $("cc").value,
    duration: $("duration").value,
    vitals: $("vitals").value,
    pmh: $("pmh").value,
    preg: $("preg").value,
    memo: $("memo").value,
  };

  const fullText = `${input.age} ${input.sex} ${input.cc} ${input.duration} ${input.pmh} ${input.preg} ${input.memo}`.trim();
  const ctx = deriveContext(fullText, input.vitals || "");

  const cat = pickCategory(fullText);
  $("categoryPill").textContent = `ì¹´í…Œê³ ë¦¬: ${cat ? cat.name : "ì¼ë°˜(ë²”ìš©)"}`;

  const redHits = detectRed(fullText + " " + (input.vitals||""), cat);
  if(redHits.length){
    $("alertBox").classList.add("show");
    $("alertText").textContent = `ê°ì§€ í‚¤ì›Œë“œ: ${redHits.slice(0,8).join(", ")}${redHits.length>8?" ...":""}`;
  }else{
    $("alertBox").classList.remove("show");
    $("alertText").textContent = "";
  }

  // dx/qs/sn/next ìƒì„± (í•­ìƒ specific & í•­ìƒ 3ê°œ)
  const dxObjs = cat ? cat.dx.slice(0,3) : genericDx(fullText);
  const qs = cat ? cat.q.slice(0,3) : genericQs(fullText);

  let sn = cat ? cat.sn(ctx).slice(0,3) : genericSN(ctx);
  let next = cat ? cat.next(ctx).slice(0,3) : genericNext(ctx);

  if(DETAIL==="detail"){
    // detail ëª¨ë“œì—ì„œ 1ì¤„ì”©ë§Œ â€œì¡°ê¸ˆ ë”â€ êµ¬ì²´í™”
    sn = [...sn];
    next = [...next];
    sn[0] = sn[0] + " (ê°€ëŠ¥í•˜ë©´ í™˜ìì—ê²Œ â€˜ì§€ê¸ˆ ë¬´ì—‡ì„ í•˜ë©´ ë˜ëŠ”ì§€â€™ í•œ ë¬¸ì¥ìœ¼ë¡œ ë°˜ë³µ í™•ì¸)";
    next[0] = next[0] + " (ê¸°ë¡: ë ˆë“œí”Œë˜ê·¸ ìŒì„±/ì–‘ì„± í•­ëª©ì„ ë¬¸ì¥ìœ¼ë¡œ ë‚¨ê¹€)";
  }

  setList($("dxList"), dxToLines(dxObjs));
  setList($("qList"), qs);
  setList($("snList"), sn);
  setList($("nextList"), next);

  const note = buildNote(input, cat, dxObjs, qs, sn, next);
  $("noteOut").textContent = note;

  localStorage.setItem("pcp_cds_last_v3", JSON.stringify(input));
}

function resetAll(){
  ["age","cc","duration","vitals","pmh","memo"].forEach(id=>$(id).value="");
  $("sex").value="";
  $("preg").value="";
  $("dxList").innerHTML = `<li class="muted">â€˜ìƒì„±â€™ ëˆ„ë¥´ë©´ ì±„ì›Œì§</li>`;
  $("qList").innerHTML  = `<li class="muted">â€˜ìƒì„±â€™ ëˆ„ë¥´ë©´ ì±„ì›Œì§</li>`;
  $("snList").innerHTML = `<li class="muted">â€˜ìƒì„±â€™ ëˆ„ë¥´ë©´ ì±„ì›Œì§</li>`;
  $("nextList").innerHTML = `<li class="muted">â€˜ìƒì„±â€™ ëˆ„ë¥´ë©´ ì±„ì›Œì§</li>`;
  $("noteOut").textContent="(ì—¬ê¸°ì— ìƒì„±ë¨)";
  $("categoryPill").textContent="ì¹´í…Œê³ ë¦¬: ìë™";
  $("alertBox").classList.remove("show");
  localStorage.removeItem("pcp_cds_last_v3");
}

$("genBtn").addEventListener("click", ()=>{
  if(!$("age").value.trim() || !$("sex").value || !$("cc").value.trim()){
    toast("í•„ìˆ˜ ì…ë ¥ì´ ì¼ë¶€ ë¹„ì–´ìˆì–´ë„ â€˜ë¯¸ìƒâ€™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤");
  }
  renderAll();
});

$("copyNoteBtn").addEventListener("click", ()=>copyText($("noteOut").textContent));
$("copyAllBtn").addEventListener("click", ()=>copyText($("noteOut").textContent));

$("downloadBtn").addEventListener("click", ()=>{
  downloadText(`emr_note_${new Date().toISOString().slice(0,10)}.txt`, $("noteOut").textContent);
});

$("resetBtn").addEventListener("click", ()=>{
  if(!confirm("ì…ë ¥/ì¶œë ¥ì„ ì´ˆê¸°í™”í• ê¹Œìš”?")) return;
  resetAll();
  toast("ì´ˆê¸°í™” ì™„ë£Œ");
});

$("copyDxBtn").addEventListener("click", ()=>{
  const items=[...document.querySelectorAll("#dxList li")].map(li=>li.textContent);
  copyText(items.map((x,i)=>`#${i+1} ${x}`).join("\n"));
});
$("copyQBtn").addEventListener("click", ()=>{
  const items=[...document.querySelectorAll("#qList li")].map(li=>li.textContent);
  copyText(items.map((x,i)=>`Q${i+1}. ${x}`).join("\n"));
});
$("copySNBtn").addEventListener("click", ()=>{
  const items=[...document.querySelectorAll("#snList li")].map(li=>li.textContent);
  copyText(items.map(x=>`- ${x}`).join("\n"));
});
$("copyNextBtn").addEventListener("click", ()=>{
  const items=[...document.querySelectorAll("#nextList li")].map(li=>li.textContent);
  copyText(items.map(x=>`- ${x}`).join("\n"));
});

/* detail toggle */
$("shortBtn").addEventListener("click", ()=>{
  DETAIL="short";
  $("shortBtn").classList.add("active");
  $("detailBtn").classList.remove("active");
  toast("ì§§ê²Œ ëª¨ë“œ");
  if($("noteOut").textContent && $("noteOut").textContent !== "(ì—¬ê¸°ì— ìƒì„±ë¨)") renderAll();
});
$("detailBtn").addEventListener("click", ()=>{
  DETAIL="detail";
  $("detailBtn").classList.add("active");
  $("shortBtn").classList.remove("active");
  toast("ì¡°ê¸ˆ ë” ëª¨ë“œ");
  if($("noteOut").textContent && $("noteOut").textContent !== "(ì—¬ê¸°ì— ìƒì„±ë¨)") renderAll();
});

/* ì´ˆê¸° ë¡œë”©: ë§ˆì§€ë§‰ ì…ë ¥ ë³µì› */
(function init(){
  try{
    const raw = localStorage.getItem("pcp_cds_last_v3");
    if(raw){
      const d = JSON.parse(raw);
      $("age").value = d.age || "";
      $("sex").value = d.sex || "";
      $("cc").value = d.cc || "";
      $("duration").value = d.duration || "";
      $("vitals").value = d.vitals || "";
      $("pmh").value = d.pmh || "";
      $("preg").value = d.preg || "";
      $("memo").value = d.memo || "";
    }
  }catch(e){}
})();
</script>
</body>
</html>
