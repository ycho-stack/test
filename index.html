<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>1ì°¨ ì˜ë£Œìš©: ê°ë³„(ê°€ëŠ¥ì„± TOP3+ICD)Â·ìœ„í—˜ì§ˆí™˜ ì§ˆë¬¸Â·ì•ˆì „ë§Â·EMR</title>
  <style>
    :root{
      --text:#e8eef6; --muted:#9bb0c6; --line:#1d2a3a;
      --shadow: 0 10px 30px rgba(0,0,0,.35); --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Apple SD Gothic Neo, Arial, "Helvetica Neue", Helvetica, sans-serif;
    }
    *{box-sizing:border-box}
    body{margin:0; background:linear-gradient(180deg,#070a0f 0%, #0b0f14 55%, #070a0f 100%); color:var(--text); font-family:var(--sans);}
    .wrap{max-width:1200px; margin:0 auto; padding:20px 16px 46px;}
    .topbar{display:flex; gap:12px; align-items:flex-start; justify-content:space-between; margin-bottom:12px; flex-wrap:wrap}
    h1{font-size:18px; margin:0 0 6px}
    .sub{color:var(--muted); font-size:13px; line-height:1.45}
    .badge{font-size:12px; padding:6px 10px; border:1px solid var(--line); border-radius:999px; background:rgba(255,255,255,.02); color:var(--muted)}
    .grid{display:grid; grid-template-columns: 1fr 1.1fr; gap:12px; align-items:start}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.03) 0%, rgba(255,255,255,.015) 100%);
      border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden;
    }
    .hd{padding:12px 14px; border-bottom:1px solid var(--line); background:rgba(0,0,0,.12); display:flex; align-items:center; justify-content:space-between; gap:10px}
    .hd h2{font-size:14px; margin:0}
    .bd{padding:14px}

    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    input, select, textarea{
      width:100%; color:var(--text); background:rgba(0,0,0,.22);
      border:1px solid var(--line); border-radius:12px; padding:10px 11px; outline:none; font-size:13px;
    }
    textarea{min-height:110px; resize:vertical; line-height:1.45}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    @media (max-width: 560px){ .row{grid-template-columns:1fr;} }

    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    button{
      border:1px solid var(--line); background:rgba(255,255,255,.03);
      color:var(--text); padding:10px 12px; border-radius:12px;
      cursor:pointer; font-size:13px;
    }
    button.primary{border-color:rgba(90,169,255,.35); background:rgba(90,169,255,.12)}
    button.danger{border-color:rgba(255,90,106,.35); background:rgba(255,90,106,.10)}
    button:hover{filter:brightness(1.08)}

    details{
      border:1px dashed rgba(155,176,198,.35);
      border-radius:14px; padding:10px 12px; background:rgba(0,0,0,.10);
      margin-top:10px;
    }
    summary{cursor:pointer; color:var(--muted); font-size:12px}

    .pill{display:inline-flex; gap:8px; align-items:center; font-size:12px; padding:6px 10px; border:1px solid var(--line); border-radius:999px; color:var(--muted); background:rgba(255,255,255,.02)}
    .alert{
      border:1px solid rgba(255,90,106,.35);
      background:rgba(255,90,106,.10);
      padding:10px 12px; border-radius:14px; margin:0 0 12px;
      display:none;
    }
    .alert.show{display:block}
    .alert b{color:#ffd2d7}

    .outGrid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width: 700px){ .outGrid{grid-template-columns:1fr;} }

    .tile{
      border:1px solid var(--line);
      border-radius:16px;
      background:linear-gradient(180deg, rgba(255,255,255,.02) 0%, rgba(0,0,0,.08) 100%);
      overflow:hidden;
    }
    .tile .thd{padding:10px 12px; border-bottom:1px solid var(--line); background:rgba(0,0,0,.10); display:flex; justify-content:space-between; align-items:center; gap:8px}
    .tile .thd h3{margin:0; font-size:13px}
    .tile .tbd{padding:10px 12px}
    ul{margin:0; padding-left:18px}
    li{margin:6px 0; font-size:13px; line-height:1.45}
    .muted{color:var(--muted)}
    .mono{font-family:var(--mono)}
    pre{
      white-space:pre-wrap; margin:0; padding:12px;
      background:rgba(0,0,0,.22); border:1px solid var(--line);
      border-radius:14px; min-height:220px; font-size:12.5px; line-height:1.45;
    }
    .toggleRow{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .seg{display:inline-flex; border:1px solid var(--line); border-radius:999px; overflow:hidden; background:rgba(255,255,255,.02)}
    .seg button{border:0; border-right:1px solid var(--line); border-radius:0; padding:7px 10px; background:transparent; color:var(--muted); font-size:12px;}
    .seg button:last-child{border-right:0}
    .seg button.active{background:rgba(90,169,255,.12); color:var(--text)}
    .footer{margin-top:10px; color:var(--muted); font-size:12px; line-height:1.5}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>ê°ë³„(ê°€ëŠ¥ì„± TOP3+ICD) Â· ìœ„í—˜ì§ˆí™˜ ì§ˆë¬¸ Â· ì•ˆì „ë§ Â· ë‹¤ìŒì•¡ì…˜(ê°€ëŠ¥ì„± #1 ê¸°ì¤€)</h1>
        <div class="sub">
          í•„ìˆ˜ ì…ë ¥ì€ <b>ë‚˜ì´Â·ì„±ë³„Â·ì£¼ì¦ìƒ</b>ë§Œ. â€œê°ë³„ 3â€ì€ í”í•œ ì§„ë‹¨ ì¤‘ì‹¬, â€œì§ˆë¬¸/ì•ˆì „ë§â€ì€ ë†“ì¹˜ë©´ ìœ„í—˜í•œ 3ê°œ ì¤‘ì‹¬.
        </div>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
        <span class="badge">âš ï¸ ì§„ë‹¨/ì¹˜ë£Œ ëŒ€ì²´ ì•„ë‹˜</span>
        <span class="badge">ğŸ”’ PHI ìµœì†Œ ì…ë ¥</span>
        <span class="badge">ğŸ“ ë³µì‚¬ 1í´ë¦­</span>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="hd">
          <h2>ì…ë ¥</h2>
          <div class="toggleRow">
            <span class="pill" id="modePill">ìë™ ìƒì„±</span>
            <div class="seg">
              <button id="shortBtn" class="active" type="button">ì§§ê²Œ</button>
              <button id="detailBtn" type="button">ì¡°ê¸ˆ ë”</button>
            </div>
          </div>
        </div>
        <div class="bd">
          <div class="row">
            <div>
              <label>ë‚˜ì´ (í•„ìˆ˜)</label>
              <input id="age" type="number" min="0" placeholder="ì˜ˆ: 42" />
            </div>
            <div>
              <label>ì„±ë³„ (í•„ìˆ˜)</label>
              <select id="sex">
                <option value="">ì„ íƒ</option>
                <option value="F">ì—¬</option>
                <option value="M">ë‚¨</option>
                <option value="O">ê¸°íƒ€/ë¯¸ìƒ</option>
              </select>
            </div>
          </div>

          <div style="margin-top:10px">
            <label>ì£¼ì¦ìƒ/ìƒí™© (í•„ìˆ˜)</label>
            <textarea id="cc" placeholder="ì˜ˆ: 'ê°€ìŠ´ì´ ì¥ì–´ì§œë“¯ ì•„í”„ê³  ì‹ì€ë•€ì´ ë‚˜ìš”. 2ì‹œê°„ ì „ë¶€í„°. ìˆ¨ë„ ì°¨ìš”.'"></textarea>
          </div>

          <details>
            <summary>ì¶”ê°€ ì •ë³´(ì„ íƒ) â€” ìˆìœ¼ë©´ ë” specificí•˜ê²Œ</summary>
            <div class="row" style="margin-top:10px">
              <div>
                <label>ì¦ìƒ ì‹œì‘/ê¸°ê°„</label>
                <input id="duration" placeholder="ì˜ˆ: 2ì‹œê°„ ì „ / 3ì¼ì§¸" />
              </div>
              <div>
                <label>í™œë ¥ì§•í›„/SpO2</label>
                <input id="vitals" placeholder="ì˜ˆ: BP 90/60 HR 120 SpO2 90%" />
              </div>
            </div>
            <div class="row" style="margin-top:10px">
              <div>
                <label>ê¸°ì €ì§ˆí™˜/ì•½ë¬¼</label>
                <input id="pmh" placeholder="ì˜ˆ: HTN, DM / í•­ì‘ê³ ì œ ë³µìš©" />
              </div>
              <div>
                <label>ì„ì‹ /ì‚°í›„</label>
                <select id="preg">
                  <option value="">í•´ë‹¹ ì—†ìŒ/ë¯¸ìƒ</option>
                  <option value="pregnant">ì„ì‹  ì¤‘</option>
                  <option value="postpartum">ì‚°í›„(6ì£¼ ì´ë‚´)</option>
                </select>
              </div>
            </div>
            <div style="margin-top:10px">
              <label>ì¶”ê°€ ë©”ëª¨</label>
              <input id="memo" placeholder="ì˜ˆ: ëˆŒë €ì„ ë•Œ ì•„í””, ì‹í›„ ì•…í™”, ë°œì—´, ê°í˜ˆ, í‘ìƒ‰ë³€, í¸ì¸¡ ë§ˆë¹„ ë“±" />
            </div>
          </details>

          <div class="btns">
            <button class="primary" id="genBtn">ìƒì„±</button>
            <button id="copyAllBtn">EMR ë…¸íŠ¸ ë³µì‚¬</button>
            <button class="danger" id="resetBtn">ì´ˆê¸°í™”</button>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="hd">
          <h2>ì¶œë ¥</h2>
          <span class="pill" id="categoryPill">ì¹´í…Œê³ ë¦¬: ìë™</span>
        </div>
        <div class="bd">
          <div class="alert" id="alertBox">
            <div><b>ë ˆë“œí”Œë˜ê·¸ ê°€ëŠ¥ì„±</b> í‚¤ì›Œë“œ ê°ì§€ â†’ â€œìœ„í—˜ì§ˆí™˜ ë°°ì œâ€ ìš°ì„ </div>
            <div class="muted" id="alertText" style="margin-top:6px;font-size:12px"></div>
          </div>

          <div class="outGrid">
            <div class="tile">
              <div class="thd">
                <h3>ê°ë³„ 3 (ê°€ì¥ ê°€ëŠ¥ì„± ë†’ì€ ì§ˆí™˜ + ICD-10)</h3>
                <button type="button" id="copyDxBtn">ë³µì‚¬</button>
              </div>
              <div class="tbd"><ul id="dxList"><li class="muted">â€˜ìƒì„±â€™ ëˆ„ë¥´ë©´ ì±„ì›Œì§</li></ul></div>
            </div>

            <div class="tile">
              <div class="thd">
                <h3>ë†“ì¹˜ë©´ ìœ„í—˜í•œ ì§ˆë¬¸ 3 (ìœ„í—˜ì§ˆí™˜ 3ê°œ ê¸°ì¤€)</h3>
                <button type="button" id="copyQBtn">ë³µì‚¬</button>
              </div>
              <div class="tbd"><ul id="qList"><li class="muted">â€˜ìƒì„±â€™ ëˆ„ë¥´ë©´ ì±„ì›Œì§</li></ul></div>
            </div>

            <div class="tile">
              <div class="thd">
                <h3>í™˜ìì—ê²Œ ë°”ë¡œ ì „ë‹¬(ì•ˆì „ë§) 3ì¤„ (ìœ„í—˜ì§ˆí™˜ 3ê°œ ê¸°ì¤€)</h3>
                <button type="button" id="copySNBtn">ë³µì‚¬</button>
              </div>
              <div class="tbd"><ul id="snList"><li class="muted">â€˜ìƒì„±â€™ ëˆ„ë¥´ë©´ ì±„ì›Œì§</li></ul></div>
            </div>

            <div class="tile">
              <div class="thd">
                <h3>ë‹¤ìŒ ì•¡ì…˜ 3ì¤„ (ê°€ëŠ¥ì„± #1 ì§„ë‹¨ ê¸°ì¤€)</h3>
                <button type="button" id="copyNextBtn">ë³µì‚¬</button>
              </div>
              <div class="tbd"><ul id="nextList"><li class="muted">â€˜ìƒì„±â€™ ëˆ„ë¥´ë©´ ì±„ì›Œì§</li></ul></div>
            </div>
          </div>

          <div style="margin-top:10px" class="tile">
            <div class="thd">
              <h3>EMRì— ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ê¸°</h3>
              <div style="display:flex; gap:8px; flex-wrap:wrap;">
                <button type="button" class="primary" id="copyNoteBtn">ë…¸íŠ¸ ë³µì‚¬</button>
                <button type="button" id="downloadBtn">.txt ì €ì¥</button>
              </div>
            </div>
            <div class="tbd"><pre id="noteOut" class="mono">(ì—¬ê¸°ì— ìƒì„±ë¨)</pre></div>
          </div>

          <div class="footer">ë©´ì±…: ë¬¸êµ¬/ëˆ„ë½ ë°©ì§€ ë³´ì¡° ë„êµ¬ì´ë©° ì§„ë‹¨Â·ì¹˜ë£Œë¥¼ ëŒ€ì²´í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
        </div>
      </div>
    </div>
  </div>

<script>
let DETAIL = "short";
const $ = (id) => document.getElementById(id);

function toast(msg){
  const el = document.createElement("div");
  el.textContent = msg;
  el.style.position="fixed"; el.style.bottom="18px"; el.style.left="50%";
  el.style.transform="translateX(-50%)"; el.style.padding="10px 12px";
  el.style.border="1px solid rgba(90,169,255,.35)";
  el.style.background="rgba(90,169,255,.12)";
  el.style.borderRadius="12px"; el.style.color="white"; el.style.zIndex=9999;
  el.style.fontSize="13px"; el.style.boxShadow="0 10px 25px rgba(0,0,0,.35)";
  document.body.appendChild(el); setTimeout(()=>el.remove(), 1200);
}
function normalize(s){ return (s||"").toLowerCase(); }
function hasAny(text, kws){
  const t = normalize(text);
  return kws.some(k=>t.includes(normalize(k)));
}
function copyText(txt){
  navigator.clipboard.writeText(txt).then(()=>toast("ë³µì‚¬ ì™„ë£Œ")).catch(()=>alert("ë³µì‚¬ ì‹¤íŒ¨(ê¶Œí•œ í™•ì¸)"));
}
function downloadText(filename, txt){
  const blob = new Blob([txt], {type:"text/plain;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}
function setList(el, items){
  el.innerHTML="";
  items.forEach(x=>{ const li=document.createElement("li"); li.textContent=x; el.appendChild(li); });
}
function nowStamp(){
  const d = new Date();
  const pad = n => String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function sexK(sex){ if(sex==="M") return "ë‚¨"; if(sex==="F") return "ì—¬"; return "ì„±ë³„ ë¯¸ìƒ"; }
function safe(v, fallback="ë¯¸ìƒ"){ return (v && String(v).trim().length) ? String(v).trim() : fallback; }

function dxLine(x){ return `${x.d} (ICD-10: ${x.icd})`; }
function dxCopy(dx){ return dx.map((x,i)=>`#${i+1} ${dxLine(x)}`).join("\n"); }

// ê³µí†µ ë ˆë“œí”Œë˜ê·¸
const COMMON_RED = ["ì˜ì‹ì €í•˜","ì‹¤ì‹ ","ê²½ë ¨","ë§ˆë¹„","ë§ì´ ì–´ëˆŒ","ì²­ìƒ‰ì¦","ì €í˜ˆì••","spO2","ê°í˜ˆ","í† í˜ˆ","í˜ˆë³€","í‘ìƒ‰ë³€","í‰í†µ","í˜¸í¡ê³¤ë€","ê°‘ìê¸°","ë²ˆê°œ","ìµœì•…","ê²½ë¶€ê°•ì§","ê³ ì—´"];

// â€œì¦‰ì‹œ/ë‹¹ì¼â€ ê°™ì€ í‘œí˜„ ìë™ ë³´ì • (ë ˆë“œ í”Œë˜ê·¸/í™œë ¥ ê¸°ë°˜)
function deriveUrgency(fullText, vitalsText){
  const t = normalize(fullText + " " + vitalsText);
  const urgent = hasAny(t, ["ì €í˜ˆì••","ì˜ì‹ì €í•˜","ì‹¤ì‹ ","ê²½ë ¨","ì²­ìƒ‰ì¦","ê°í˜ˆ","í† í˜ˆ","í˜ˆë³€","í‘ìƒ‰ë³€"]) ||
                 hasAny(t, ["ê°‘ìê¸°","ë²ˆê°œ","ìµœì•…"]) ||
                 hasAny(t, ["spO2 8","spO2 7","spO2 6","spO2:8","spO2:7","spO2:6"]) ||
                 hasAny(t, ["bp 8","bp 7"]) ||
                 /spO2\s*[:=]?\s*8\d/.test(t) || /spo2\s*[:=]?\s*7\d/.test(t);
  return urgent ? "ì¦‰ì‹œ" : "ê°€ëŠ¥í•˜ë©´ ë‹¹ì¼";
}

function detectRed(fullText){
  const t = normalize(fullText);
  const hits = [];
  for(const k of COMMON_RED){ if(t.includes(normalize(k))) hits.push(k); }
  return [...new Set(hits)];
}

/* =========================
   ì¹´í…Œê³ ë¦¬ + ë¡œì§
   - likelyDx: í”í•œ/ê°€ëŠ¥ì„± ë†’ì€ 3ê°œ (ì§ˆí™˜+ICD)
   - dangerDx: ë†“ì¹˜ë©´ ìœ„í—˜í•œ 3ê°œ (ì§ˆí™˜+ICD)
   - q/sn: dangerDx 3ê°œì— 1:1 ëŒ€ì‘
   - next: likely #1 ê¸°ì¤€
   ========================= */

const CATS = [
  {
    id:"chest",
    name:"í‰í†µ/í‰ë¶€ë¶ˆí¸",
    match:["í‰í†µ","ê°€ìŠ´í†µì¦","ê°€ìŠ´ì´","ì••ë°•ê°","ì¥ì–´ì§œ","ë°©ì‚¬","ì‹ì€ë•€","chest pain","èƒ¸ç—›","í„±","ì™¼íŒ”","ë“±ìœ¼ë¡œ"],
    // ê°€ëŠ¥ì„± ë†’ì€(í”í•œ) í›„ë³´ 3ê°œ(ìˆœì„œëŠ” ìƒí™©ì— ë”°ë¼ ë°”ë€œ)
    likelyVariants: [
      {
        id:"msk",
        when:["ëˆŒëŸ¬","ì••í†µ","ì›€ì§","ìì„¸","ê·¼ìœ¡","ê°ˆë¹„","ê¸°ì¹¨í• ë•Œ","ê¹Šê²Œìˆ¨"],
        dx:[
          {d:"ëŠ‘ì—°ê³¨ì—¼/ëŠ‘ê³¨ì—°ê³¨ ì¦í›„êµ°(Costochondritis/Tietze)", icd:"M94.0"},
          {d:"í‰ë²½ ê·¼ìœ¡/ê±´ ì†ìƒ(Thoracic wall muscle strain)", icd:"S29.011A"},
          {d:"ìœ„ì‹ë„ì—­ë¥˜ì§ˆí™˜(GERD)", icd:"K21.9"},
        ],
        next:(u)=>[
          `ì¬í˜„ì„± í†µì¦(ì••í†µ/ì›€ì§ì„/í˜¸í¡)ì— ì¼ì¹˜í•˜ë©´ ê·¼ê³¨ê²© ê°€ëŠ¥ì„±â†‘ â†’ NSAID/êµ­ì†Œì˜¨ì—´/í™œë™ì¡°ì ˆ ê³ ë ¤.`,
          `ë‹¤ë§Œ ìœ„í—˜ ì‹ í˜¸(í˜¸í¡ê³¤ë€Â·ì‹¤ì‹ Â·ì§€ì† ì•…í™”Â·ëƒ‰í•œÂ·ë°©ì‚¬í†µ) ìˆìœ¼ë©´ ${u} ì‹¬ì¥/í ì›ì¸ ë°°ì œ ìš°ì„ .`,
          `48â€“72ì‹œê°„ ë‚´ í˜¸ì „ ì—†ê±°ë‚˜ ì•…í™” ì‹œ ì¬í‰ê°€(ECG/í‰ë¶€í‰ê°€ í¬í•¨) ê³„íš ì¡ê¸°.`
        ]
      },
      {
        id:"gerd",
        when:["ì†ì“°ë¦¼","ì‹ ë¬¼","íŠ¸ë¦¼","ì‹í›„","ëˆ„ìš°ë©´","ê°€ìŠ´ì“°ë¦¼","ëª…ì¹˜","ì‚°"],
        dx:[
          {d:"ìœ„ì‹ë„ì—­ë¥˜ì§ˆí™˜(GERD)", icd:"K21.9"},
          {d:"ê¸‰ì„±/ë§Œì„± ìœ„ì—¼(Gastritis, unspecified)", icd:"K29.70"},
          {d:"ëŠ‘ì—°ê³¨ì—¼/í‰ë²½í†µì¦(Costochondritis)", icd:"M94.0"},
        ],
        next:(u)=>[
          `ì‹í›„/ëˆ„ìš°ë©´ ì•…í™”Â·ì†ì“°ë¦¼ ë™ë°˜ì´ë©´ GERD ê°€ëŠ¥ì„±â†‘ â†’ PPI/H2 blocker + ìƒí™œìš”ë²•(ì‹ì‚¬/ì¹´í˜ì¸/ì•¼ì‹) ì•ˆë‚´.`,
          `í‰í†µì€ ìœ„í—˜ ì›ì¸ê³¼ ê²¹ì¹  ìˆ˜ ìˆì–´ ìœ„í—˜ ì‹ í˜¸ ìˆìœ¼ë©´ ${u} ECG ë“±ìœ¼ë¡œ ìš°ì„  ë°°ì œ.`,
          `2â€“4ì£¼ ë°˜ì‘ ì—†ê±°ë‚˜ ì—°í•˜ê³¤ë€/ì²´ì¤‘ê°ì†Œ/í‘ìƒ‰ë³€ ë“± ê²½ê³ ì¦ìƒ ì‹œ ìƒë¶€ìœ„ì¥ê´€ í‰ê°€ ê³ ë ¤.`
        ]
      },
      {
        id:"anxiety",
        when:["ë¶ˆì•ˆ","ê³µí™©","ê³¼í˜¸í¡","ì†ì €ë¦¼","ê°€ìŠ´ë‘ê·¼","ì£½ì„ê²ƒê°™","í˜¸í¡ì´ë¹ ë¥´","ìŠ¤íŠ¸ë ˆìŠ¤"],
        dx:[
          {d:"ê³µí™©ì¥ì• (Panic disorder)", icd:"F41.0"},
          {d:"ë¶ˆì•ˆì¥ì• (Anxiety disorder, unspecified)", icd:"F41.9"},
          {d:"ìœ„ì‹ë„ì—­ë¥˜ì§ˆí™˜(GERD)", icd:"K21.9"},
        ],
        next:(u)=>[
          `ê³µí™©/ê³¼í˜¸í¡ ì–‘ìƒì´ë©´ ë¶ˆì•ˆ/ê³µí™© ê°€ëŠ¥ì„±â†‘ â†’ í˜¸í¡ì¡°ì ˆ, íŠ¸ë¦¬ê±°, ë‹¨ê¸° ì¶”ì  ë° í•„ìš” ì‹œ ì•½ë¬¼/ì •ì‹ ê±´ê°• ì—°ê³„.`,
          `ë‹¨, í‰í†µ ì²« ë°œìƒ/ìœ„í—˜ì¸ì/ë ˆë“œí”Œë˜ê·¸ ìˆìœ¼ë©´ ${u} ì‹¬ì¥/í ì›ì¸ ë°°ì œ í›„ ì§„ë‹¨.`,
          `ì¬ë°œ ì‹œ ì„ ë³„(PHQ-4/GAD-7 ë“±) + ì•ˆì „ë§(ì‘ê¸‰ ì¦ìƒ ì‹œ ì¦‰ì‹œ ë‚´ì›) ì œê³µ.`
        ]
      }
    ],
    dangerDx:[
      {d:"ê¸‰ì„±ì‹¬ê·¼ê²½ìƒ‰(AMI)", icd:"I21.9"},
      {d:"íìƒ‰ì „ì¦(PE)", icd:"I26.99"},
      {d:"ëŒ€ë™ë§¥ë°•ë¦¬(Aortic dissection)", icd:"I71.00"},
    ],
    dangerQ:(u)=>[
      `AMI ë°°ì œ: ìš´ë™ ì‹œ ì•…í™”/íœ´ì‹ ì‹œ ì™„í™”? ë°©ì‚¬í†µ(íŒ”Â·í„±)Â·ì‹ì€ë•€Â·êµ¬ì—­Â·ì‹¤ì‹  ë™ë°˜?`,
      `PE ë°°ì œ: ê°‘ì‘ í˜¸í¡ê³¤ë€/í‰í†µ(í¡ê¸° ì‹œ ì•…í™”)? ë‹¤ë¦¬ ë¶€ì¢…Â·í†µì¦? ìµœê·¼ ìˆ˜ìˆ /ì¥ê±°ë¦¬/ì„ì‹ Â·ì‚°í›„?`,
      `ë°•ë¦¬ ë°°ì œ: â€œì°¢ì–´ì§€ëŠ”â€ ê°‘ì‘ ê·¹ì‹¬ í†µì¦(í‰ë¶€/ë“±)? ì‹ ê²½í•™ì  ì¦ìƒÂ·ì‹¤ì‹ Â·í˜ˆì••ì°¨ ëŠë‚Œ?`
    ],
    dangerSN:(u)=>[
      `ì‹¬ì¥ ê´€ë ¨ ìœ„í—˜(AMI) ì˜ì‹¬ ì¦ìƒ(ì§€ì† í‰í†µ, ì‹ì€ë•€, ë°©ì‚¬í†µ, ì‹¤ì‹ )ì´ ìˆìœ¼ë©´ ${u} ì‘ê¸‰ì‹¤ë¡œ ê°€ì„¸ìš”.`,
      `íìƒ‰ì „ì¦ ìœ„í—˜(ê°‘ì‘ ìˆ¨ì°¸, í‰í†µ+ê°í˜ˆ, ë‹¤ë¦¬ë¶€ì¢…/í†µì¦)ì´ ìˆìœ¼ë©´ ${u} ì‘ê¸‰ì‹¤ë¡œ ê°€ì„¸ìš”.`,
      `ëŒ€ë™ë§¥ë°•ë¦¬ ì˜ì‹¬(ê°‘ì‘ â€˜ì°¢ì–´ì§€ëŠ”â€™ í†µì¦, ì‹ ê²½í•™ì  ì¦ìƒ/ì‹¤ì‹ )ì´ ìˆìœ¼ë©´ ${u} ì¦‰ì‹œ 119/ì‘ê¸‰ì‹¤.`
    ],
    baseDx:[ // fallback
      {d:"ìœ„ì‹ë„ì—­ë¥˜ì§ˆí™˜(GERD)", icd:"K21.9"},
      {d:"ëŠ‘ì—°ê³¨ì—¼(Costochondritis)", icd:"M94.0"},
      {d:"ê³µí™©ì¥ì• (Panic disorder)", icd:"F41.0"},
    ],
    pickVariant(full){
      const t = normalize(full);
      // msk > gerd > anxiety ìˆœìœ¼ë¡œ ì¡ë˜, ì—†ìœ¼ë©´ null
      if(hasAny(t, this.likelyVariants[0].when)) return this.likelyVariants[0];
      if(hasAny(t, this.likelyVariants[1].when)) return this.likelyVariants[1];
      if(hasAny(t, this.likelyVariants[2].when)) return this.likelyVariants[2];
      return null;
    }
  },

  {
    id:"dyspnea",
    name:"í˜¸í¡ê³¤ë€",
    match:["í˜¸í¡ê³¤ë€","ìˆ¨ì°¸","ìˆ¨ì´ ì°¨","dyspnea","ì²œëª…","wheezing","spO2","ê°í˜ˆ","ì²­ìƒ‰ì¦","ê¸°ì¹¨","ê°€ë˜"],
    likelyVariants:[
      {
        id:"uri",
        when:["ê¸°ì¹¨","ê°€ë˜","ì¸í›„","ì½§ë¬¼","ê°ê¸°","ë¯¸ì—´","ëª©ì•„í””"],
        dx:[
          {d:"ê¸‰ì„± ê¸°ê´€ì§€ì—¼(Acute bronchitis, unspecified)", icd:"J20.9"},
          {d:"ìƒê¸°ë„ê°ì—¼(Acute URI)", icd:"J06.9"},
          {d:"ì²œì‹(Asthma with acute exacerbation)", icd:"J45.901"},
        ],
        next:(u)=>[
          `ìƒê¸°ë„/ê¸°ê´€ì§€ì—¼ ì–‘ìƒì´ë©´ ë³´ì¡´ì  ì¹˜ë£Œ(ìˆ˜ë¶„, ëŒ€ì¦) + íë ´ ê²½ê³ ì¦ìƒ(ê³ ì—´Â·í˜¸í¡ìˆ˜â†‘Â·í‰í†µ) ì²´í¬.`,
          `ì²œëª…/ê¸°ê´€ì§€ê²½ë ¨ ìˆìœ¼ë©´ í¡ì…ê¸°ê´€ì§€í™•ì¥ì œ ê³ ë ¤, SpO2 ë‚®ìœ¼ë©´ ${u} ì¦‰ì‹œ í‰ê°€.`,
          `48â€“72ì‹œê°„ ë‚´ ì•…í™”/í˜¸ì „ ì—†ìœ¼ë©´ ì¬í‰ê°€(CXR ë“±) ê³„íš.`
        ]
      },
      {
        id:"asthma",
        when:["ì²œëª…","ìŒ•ìŒ•","í¡ì…ê¸°","ì•Œë ˆë¥´ê¸°","ì•¼ê°„ì•…í™”"],
        dx:[
          {d:"ì²œì‹(Asthma with acute exacerbation)", icd:"J45.901"},
          {d:"ê¸‰ì„± ê¸°ê´€ì§€ì—¼(Acute bronchitis)", icd:"J20.9"},
          {d:"íë ´(Pneumonia, unspecified organism)", icd:"J18.9"},
        ],
        next:(u)=>[
          `ì²œëª…/ê¸°ê´€ì§€ê²½ë ¨ ì¤‘ì‹¬ì´ë©´ ì²œì‹ ì•…í™” ê°€ëŠ¥ì„±â†‘ â†’ SABA, í•„ìš” ì‹œ ì „ì‹  ìŠ¤í…Œë¡œì´ë“œ/í”¼í¬í”Œë¡œìš° ì¶”ì .`,
          `SpO2â†“, ë¬¸ì¥ ë§í•˜ê¸° ì–´ë ¤ì›€, ë³´ì¡°ê·¼ ì‚¬ìš©ì´ë©´ ${u} ì‘ê¸‰ í‰ê°€/ì‚°ì†Œ.`,
          `ê°ì—¼ ë™ë°˜ ì˜ì‹¬(ë°œì—´Â·êµ­ì†Œ í‰ë¶€í†µì¦) ì‹œ CXR ë° í•­ìƒì œ ì ì‘ì¦ í‰ê°€.`
        ]
      },
      {
        id:"pna",
        when:["ê³ ì—´","ë°œì—´","ì˜¤í•œ","í‰í†µ","ëˆ„ëŸ°ê°€ë˜","íë ´"],
        dx:[
          {d:"íë ´(Pneumonia, unspecified organism)", icd:"J18.9"},
          {d:"ê¸‰ì„± ê¸°ê´€ì§€ì—¼(Acute bronchitis)", icd:"J20.9"},
          {d:"ì²œì‹(Asthma with acute exacerbation)", icd:"J45.901"},
        ],
        next:(u)=>[
          `ë°œì—´/ê°€ë˜/í‰í†µì´ë©´ íë ´ ê°€ëŠ¥ì„±â†‘ â†’ í™œë ¥/SpO2 ê¸°ë°˜ ì¤‘ì¦ë„ íŒë‹¨ + CXR ê³ ë ¤.`,
          `ì €ì‚°ì†Œ/ë¹ˆí˜¸í¡/ì €í˜ˆì••ì´ë©´ ${u} ì¦‰ì‹œ ìƒê¸‰ í‰ê°€(ì‘ê¸‰ì‹¤).`,
          `ì™¸ë˜ ê°€ëŠ¥ ì‹œ í•­ìƒì œ ì ì‘ì¦ + 24â€“48ì‹œê°„ ë‚´ ì•…í™” ì‹œ ì¬í‰ê°€ ì•ˆì „ë§.`
        ]
      },
      {
        id:"hf",
        when:["ëˆ„ìš°ë©´","ê¸°ì¹¨","ì•¼ê°„í˜¸í¡ê³¤ë€","ë‹¤ë¦¬ë¶€ì¢…","ì²´ì¤‘ì¦ê°€","ê±°í’ˆê°€ë˜","ì‹¬ë¶€ì „"],
        dx:[
          {d:"ì‹¬ë¶€ì „(Heart failure, unspecified)", icd:"I50.9"},
          {d:"ê¸‰ì„± íë¶€ì¢…(Acute pulmonary edema)", icd:"J81.0"},
          {d:"íë ´(Pneumonia, unspecified organism)", icd:"J18.9"},
        ],
        next:(u)=>[
          `ê¸°ì¢Œí˜¸í¡/ì•¼ê°„í˜¸í¡ê³¤ë€/ë¶€ì¢…ì´ë©´ ì‹¬ë¶€ì „ ê°€ëŠ¥ì„±â†‘ â†’ ì²­ì§„/ë¶€ì¢…/ì²´ì¤‘ë³€í™” í™•ì¸, í•„ìš” ì‹œ í‰ë¶€ì˜ìƒ/BNP ê³ ë ¤.`,
          `SpO2â†“, ì²­ìƒ‰ì¦, ê±°í’ˆê°€ë˜, ì €í˜ˆì••ì´ë©´ ${u} ì¦‰ì‹œ ì‘ê¸‰ì‹¤/ì‚°ì†Œ/ì´ë‡¨ì œ í‰ê°€.`,
          `ì™¸ë˜ ê´€ì°°ì´ë©´ ë‹¨ê¸° ì¶”ì (24â€“48h)ê³¼ ì•…í™” ê¸°ì¤€ì„ ëª…í™•íˆ.`
        ]
      }
    ],
    dangerDx:[
      {d:"íìƒ‰ì „ì¦(PE)", icd:"I26.99"},
      {d:"ê¸°í‰(Pneumothorax)", icd:"J93.9"},
      {d:"ê¸‰ì„± íë¶€ì¢…(Acute pulmonary edema)", icd:"J81.0"},
    ],
    dangerQ:(u)=>[
      `PE ë°°ì œ: ê°‘ì‘ ìˆ¨ì°¸/í‰í†µ? ë‹¤ë¦¬ ë¶€ì¢…Â·í†µì¦? ìµœê·¼ ìˆ˜ìˆ /ì¥ê±°ë¦¬/ì„ì‹ Â·ì‚°í›„/í˜¸ë¥´ëª¬?`,
      `ê¸°í‰ ë°°ì œ: ê°‘ì‘ í¸ì¸¡ í‰í†µ+ìˆ¨ì°¸? í•œìª½ í˜¸í¡ìŒ ê°ì†Œ ëŠë‚Œ? (ì™¸ìƒ/ê¸°ì € íì§ˆí™˜)`,
      `íë¶€ì¢… ë°°ì œ: ëˆ„ìš°ë©´ ì•…í™”(ê¸°ì¢Œí˜¸í¡), ì•¼ê°„ í˜¸í¡ê³¤ë€, ë‹¤ë¦¬ë¶€ì¢…/ì²´ì¤‘ì¦ê°€ ë™ë°˜?`
    ],
    dangerSN:(u)=>[
      `PE ì˜ì‹¬(ê°‘ì‘ ìˆ¨ì°¸+í‰í†µ/ê°í˜ˆ/ë‹¤ë¦¬ë¶€ì¢…)ì´ë©´ ${u} ì‘ê¸‰ì‹¤ë¡œ ê°€ì„¸ìš”.`,
      `ê¸°í‰ ì˜ì‹¬(ê°‘ì‘ í¸ì¸¡ í‰í†µ+ìˆ¨ì°¸)ì´ë©´ ${u} ì‘ê¸‰ì‹¤ë¡œ ê°€ì„¸ìš”.`,
      `íë¶€ì¢…/ì‹¬ë¶€ì „ ì˜ì‹¬(ëˆ„ìš°ë©´ ìˆ¨ì°¸, ì•¼ê°„ ì•…í™”, ì²­ìƒ‰ì¦/SpO2â†“)ì´ë©´ ${u} ì¦‰ì‹œ ë‚´ì›/ì‘ê¸‰ì‹¤.`
    ],
    baseDx:[
      {d:"ê¸‰ì„± ê¸°ê´€ì§€ì—¼(Acute bronchitis)", icd:"J20.9"},
      {d:"ì²œì‹ ì•…í™”(Asthma with acute exacerbation)", icd:"J45.901"},
      {d:"íë ´(Pneumonia, unspecified organism)", icd:"J18.9"},
    ],
    pickVariant(full){
      const t = normalize(full);
      // hf > pna > asthma > uri ìˆœ (ì‘ê¸‰ ë†“ì¹˜ê¸° ì¤„ì´ë©´ì„œë„ í”í•œ íŒ¨í„´)
      if(hasAny(t, this.likelyVariants[3].when)) return this.likelyVariants[3];
      if(hasAny(t, this.likelyVariants[2].when)) return this.likelyVariants[2];
      if(hasAny(t, this.likelyVariants[1].when)) return this.likelyVariants[1];
      if(hasAny(t, this.likelyVariants[0].when)) return this.likelyVariants[0];
      return null;
    }
  },

  {
    id:"abd",
    name:"ë³µí†µ",
    match:["ë³µí†µ","ë°°ê°€","ë³µë¶€","abdominal","êµ¬í† ","ì„¤ì‚¬","í† í˜ˆ","í˜ˆë³€","í‘ìƒ‰ë³€","ì˜¤ë¥¸ìª½ì•„ë˜","ìš°í•˜ë³µë¶€","ëª…ì¹˜","ìš°ìƒë³µë¶€","ì˜†êµ¬ë¦¬","ë°°ë‡¨í†µ"],
    likelyVariants:[
      {
        id:"ge",
        when:["ì„¤ì‚¬","êµ¬í† ","ë³µí†µ+ì„¤ì‚¬","ë¨¹ì€ë’¤","ì¥ì—¼","íƒˆìˆ˜"],
        dx:[
          {d:"ê¸‰ì„± ìœ„ì¥ì—¼/ì¥ì—¼(Gastroenteritis, unspecified)", icd:"K52.9"},
          {d:"ê¸°ëŠ¥ì„± ì†Œí™”ë¶ˆëŸ‰(Functional dyspepsia)", icd:"K30"},
          {d:"ë³€ë¹„(Constipation, unspecified)", icd:"K59.00"},
        ],
        next:(u)=>[
          `ì¥ì—¼ ì–‘ìƒì´ë©´ ìˆ˜ë¶„/ì „í•´ì§ˆ + ëŒ€ì¦ì¹˜ë£Œ, íƒˆìˆ˜/ê³ ì—´/í˜ˆë³€ ì—¬ë¶€ í™•ì¸.`,
          `í˜ˆë³€/ê³ ì—´/ì§€ì† êµ¬í† /ì‹¬í•œ êµ­ì†Œ ì••í†µ ìˆìœ¼ë©´ ${u} ì‘ê¸‰ ì›ì¸ ë°°ì œ ìš°ì„ .`,
          `24â€“48ì‹œê°„ ë‚´ ì•…í™”/í˜¸ì „ ì—†ìœ¼ë©´ ì¬í‰ê°€(ë³µë¶€ì§„ì°°/ê²€ì‚¬) ê³„íš.`
        ]
      },
      {
        id:"const",
        when:["ë³€ë¹„","ë³€ì„ ëª»","ê°€ìŠ¤ê°€","ë”±ë”±í•œë³€","ë°°ë³€í›„ í˜¸ì „"],
        dx:[
          {d:"ë³€ë¹„(Constipation, unspecified)", icd:"K59.00"},
          {d:"ê³¼ë¯¼ì„±ì¥ì¦í›„êµ°(IBS, without diarrhea)", icd:"K58.9"},
          {d:"ê¸°ëŠ¥ì„± ì†Œí™”ë¶ˆëŸ‰(Functional dyspepsia)", icd:"K30"},
        ],
        next:(u)=>[
          `ë³€ë¹„ íŒ¨í„´ì´ë©´ ì‹ì´/ìˆ˜ë¶„/ì™„í•˜ì œ(PEG ë“±) + ê²½ê³ ì¦ìƒ(í˜ˆë³€/ì²´ì¤‘ê°ì†Œ/ì•¼ê°„í†µì¦) í™•ì¸.`,
          `êµ­ì†Œ ë°˜ë°œí†µ/ë°œì—´/ì§€ì† ì•…í™”ë©´ ${u} ê¸‰ì„±ë³µì¦ ë°°ì œ ìš°ì„ .`,
          `1ì£¼ ë‚´ í˜¸ì „ ì—†ê±°ë‚˜ ì¬ë°œí•˜ë©´ ì›ì¸í‰ê°€(ì•½ë¬¼, ë‚´ë¶„ë¹„, ëŒ€ì¥í‰ê°€) ê³ ë ¤.`
        ]
      },
      {
        id:"gastritis",
        when:["ëª…ì¹˜","ì†ì“°ë¦¼","ì‹ ë¬¼","ì‹í›„","NSAID","ìˆ ","ì»¤í”¼","ê³µë³µí†µ"],
        dx:[
          {d:"ìœ„ì‹ë„ì—­ë¥˜ì§ˆí™˜(GERD)", icd:"K21.9"},
          {d:"ê¸‰ì„±/ë§Œì„± ìœ„ì—¼(Gastritis, unspecified)", icd:"K29.70"},
          {d:"ì†Œí™”ì„±ê¶¤ì–‘(Peptic ulcer, site unspecified)", icd:"K27.9"},
        ],
        next:(u)=>[
          `ìƒë³µë¶€ ì‘ì—´ê°/NSAID ì—°ê´€ì´ë©´ GERD/ìœ„ì—¼/ê¶¤ì–‘ ê°€ëŠ¥ì„±â†‘ â†’ PPI + NSAID ì¤‘ë‹¨/ìœ„í—˜ì•½ í™•ì¸.`,
          `í‘ìƒ‰ë³€/í† í˜ˆ/ì–´ì§€ëŸ¼/ì €í˜ˆì••ì´ë©´ ${u} ì¶œí˜ˆ ë°°ì œ ìœ„í•´ ì¦‰ì‹œ ì˜ë¢°.`,
          `2â€“4ì£¼ ë°˜ì‘ ì—†ê±°ë‚˜ ì¬ë°œ/ì²´ì¤‘ê°ì†Œ/ì—°í•˜ê³¤ë€ ì‹œ H. pylori/ë‚´ì‹œê²½ í‰ê°€ ê³ ë ¤.`
        ]
      },
      {
        id:"uti",
        when:["ë°°ë‡¨í†µ","ë¹ˆë‡¨","ì ˆë°•ë‡¨","í˜ˆë‡¨","ì˜†êµ¬ë¦¬í†µ"],
        dx:[
          {d:"ê¸‰ì„± ë°©ê´‘ì—¼(Acute cystitis without hematuria)", icd:"N30.00"},
          {d:"ì‹ ìš°ì‹ ì—¼(Acute pyelonephritis)", icd:"N10"},
          {d:"ìš”ë¡œê²°ì„(Calculus of kidney)", icd:"N20.0"},
        ],
        next:(u)=>[
          `ë°°ë‡¨ì¦ìƒ ì¤‘ì‹¬ì´ë©´ UTI ê°€ëŠ¥ì„±â†‘ â†’ UA/ë°°ì–‘(í•„ìš” ì‹œ) í›„ í•­ìƒì œ ì ì‘ì¦ íŒë‹¨.`,
          `ë°œì—´Â·ì˜†êµ¬ë¦¬í†µÂ·ì˜¤í•œì´ë©´ ì‹ ìš°ì‹ ì—¼ ê°€ëŠ¥ì„± â†’ ${u} ì¤‘ì¦ë„ í‰ê°€/í•„ìš” ì‹œ ì˜ë¢°.`,
          `í˜ˆë‡¨/ì‚°í†µì´ë©´ ê²°ì„ í‰ê°€(ì˜ìƒ/í†µì¦ì¡°ì ˆ) ë° ì•…í™” ì‹œ ì¬ë‚´ì› ê¸°ì¤€ ì œì‹œ.`
        ]
      }
    ],
    // ìœ„í—˜ì§ˆí™˜ 3ê°œ(ë³µí†µì€ ì„±ë³„/ê°€ì„ê¸° ë”°ë¼ í•˜ë‚˜ ë°”ë€œ)
    dangerDxByCtx:(ctx)=> {
      if(ctx.isReproF){
        return [
          {d:"ê¸‰ì„± ì¶©ìˆ˜ì—¼(Acute appendicitis)", icd:"K35.80"},
          {d:"ê¸‰ì„± ë‹´ë‚­ì—¼(Acute cholecystitis)", icd:"K81.0"},
          {d:"ìê¶ì™¸ì„ì‹ (Ectopic pregnancy, unspecified)", icd:"O00.9"},
        ];
      }
      return [
        {d:"ê¸‰ì„± ì¶©ìˆ˜ì—¼(Acute appendicitis)", icd:"K35.80"},
        {d:"ê¸‰ì„± ë‹´ë‚­ì—¼(Acute cholecystitis)", icd:"K81.0"},
        {d:"ìœ„ì¥ê´€ ì¶œí˜ˆ(GI hemorrhage, unspecified)", icd:"K92.2"},
      ];
    },
    dangerQ:(u,ctx)=> {
      const third = ctx.isReproF
        ? "ìê¶ì™¸ì„ì‹  ë°°ì œ: ì„ì‹  ê°€ëŠ¥/ìƒë¦¬ ì§€ì—°? ì§ˆì¶œí˜ˆÂ·ì–´ì§€ëŸ¼/ì‹¤ì‹ ? (ì†Œë³€/í˜ˆì²­ hCG í™•ì¸)"
        : "GI ì¶œí˜ˆ ë°°ì œ: í‘ìƒ‰ë³€/í˜ˆë³€/í† í˜ˆ, ì–´ì§€ëŸ¼Â·ì‹¤ì‹ , í•­ì‘ê³ ì œ/NSAID ë³µìš©?";
      return [
        "ì¶©ìˆ˜ì—¼ ë°°ì œ: í†µì¦ì´ ë°°ê¼½â†’ìš°í•˜ë³µë¶€ë¡œ ì´ë™? ê¸°ì¹¨/ë³´í–‰ ì‹œ ì•…í™”? ë°˜ë°œí†µ/ë°œì—´?",
        "ë‹´ë‚­ì—¼ ë°°ì œ: ìš°ìƒë³µë¶€ í†µì¦+ë°œì—´? ì‹í›„(ê¸°ë¦„ì§„ ìŒì‹) ì•…í™”? í™©ë‹¬/ì§„í•œ ì†Œë³€?",
        third
      ];
    },
    dangerSN:(u,ctx)=> {
      const third = ctx.isReproF
        ? `ê°€ì„ê¸° ì—¬ì„±ì—ì„œ ì„ì‹  ê°€ëŠ¥ + ë³µí†µ/ì§ˆì¶œí˜ˆ/ì‹¤ì‹ ì´ ìˆìœ¼ë©´ ${u} ì¦‰ì‹œ ì‘ê¸‰ì‹¤(ìê¶ì™¸ì„ì‹  ë°°ì œ).`
        : `í‘ìƒ‰ë³€/í† í˜ˆ/ì–´ì§€ëŸ¼/ì‹¤ì‹ (ì¶œí˜ˆ ì˜ì‹¬)ì´ ìˆìœ¼ë©´ ${u} ì¦‰ì‹œ ì‘ê¸‰ì‹¤ë¡œ ê°€ì„¸ìš”.`;
      return [
        `ìš°í•˜ë³µë¶€ êµ­ì†Œ ì••í†µ/ë°˜ë°œí†µÂ·ë°œì—´Â·ì§€ì† ì•…í™”(ì¶©ìˆ˜ì—¼ ì˜ì‹¬)ì´ë©´ ${u} ì‘ê¸‰ì‹¤ë¡œ ê°€ì„¸ìš”.`,
        `ìš°ìƒë³µë¶€ í†µì¦+ë°œì—´/í™©ë‹¬(ë‹´ë‚­ì—¼/ë‹´ë„ ë¬¸ì œ ì˜ì‹¬)ì´ë©´ ${u} ì‘ê¸‰ì‹¤ë¡œ ê°€ì„¸ìš”.`,
        third
      ];
    },
    baseDx:[
      {d:"ê¸‰ì„± ìœ„ì¥ì—¼/ì¥ì—¼(Gastroenteritis)", icd:"K52.9"},
      {d:"ë³€ë¹„(Constipation)", icd:"K59.00"},
      {d:"ìœ„ì‹ë„ì—­ë¥˜ì§ˆí™˜(GERD)", icd:"K21.9"},
    ],
    pickVariant(full){
      const t = normalize(full);
      // uti > gastritis > const > ge
      if(hasAny(t, this.likelyVariants[3].when)) return this.likelyVariants[3];
      if(hasAny(t, this.likelyVariants[2].when)) return this.likelyVariants[2];
      if(hasAny(t, this.likelyVariants[1].when)) return this.likelyVariants[1];
      if(hasAny(t, this.likelyVariants[0].when)) return this.likelyVariants[0];
      return null;
    }
  },

  {
    id:"head",
    name:"ë‘í†µ",
    match:["ë‘í†µ","ë¨¸ë¦¬ê°€","headache","í¸ì¸¡","ë°•ë™","ì˜¤ì‹¬","êµ¬í† ","ë¹›","ì†Œë¦¬","ê²½ë¶€","ì½”ë§‰í˜","ë¶€ë¹„ë™","ë²ˆê°œ","ìµœì•…","ë§ˆë¹„","ì‹œì•¼","ê²½ë ¨"],
    likelyVariants:[
      {
        id:"tension",
        when:["ë ","ì¡°ì´ëŠ”","ì–‘ì¸¡","ê·¼ìœ¡","ëª©","ìŠ¤íŠ¸ë ˆìŠ¤","ì–´ê¹¨ê²°ë¦¼"],
        dx:[
          {d:"ê¸´ì¥í˜• ë‘í†µ(Tension-type headache, unspecified)", icd:"G44.209"},
          {d:"ê²½ì¶”ì„± ë‘í†µ/ê²½ì¶”í†µ(Cervicalgia)", icd:"M54.2"},
          {d:"í¸ë‘í†µ(Migraine, unspecified)", icd:"G43.909"},
        ],
        next:(u)=>[
          `ë  ì¡°ì´ëŠ” ì–‘ìƒ/ê·¼ê¸´ì¥ ë™ë°˜ì´ë©´ ê¸´ì¥í˜• ë‘í†µ ê°€ëŠ¥ì„±â†‘ â†’ ì§„í†µì œ + ìˆ˜ë©´/ìì„¸/ê·¼ìœ¡ì´ì™„ êµìœ¡.`,
          `ìƒˆë¡œìš´ ì–‘ìƒ/ë ˆë“œí”Œë˜ê·¸(ê¸‰ì„±ë°œë³‘Â·ì‹ ê²½í•™ì  ê²°ì†Â·ë°œì—´/ê²½ë¶€ê°•ì§) ìˆìœ¼ë©´ ${u} ì˜ìƒ/ì‘ê¸‰ í‰ê°€.`,
          `1â€“2ì£¼ ë‚´ ì¬ë°œ/ì§€ì† ì‹œ ì›ì¸í‰ê°€(ì•½ë¬¼ê³¼ìš©, ì‹œë ¥/í˜ˆì••, 2ì°¨ì„±) ê³„íš.`
        ]
      },
      {
        id:"migraine",
        when:["í¸ì¸¡","ë°•ë™","ì˜¤ì‹¬","êµ¬í† ","ë¹›","ì†Œë¦¬","ì „ì¡°","ë‘ê·¼","ì›€ì§ì´ë©´ì•…í™”"],
        dx:[
          {d:"í¸ë‘í†µ(Migraine, unspecified)", icd:"G43.909"},
          {d:"ê¸´ì¥í˜• ë‘í†µ(Tension-type headache)", icd:"G44.209"},
          {d:"ê¸‰ì„± ë¶€ë¹„ë™ì—¼(Acute sinusitis, unspecified)", icd:"J01.90"},
        ],
        next:(u)=>[
          `í¸ì¸¡ ë°•ë™ì„±+ì˜¤ì‹¬/ê´‘ê³¼ë¯¼ì´ë©´ í¸ë‘í†µ ê°€ëŠ¥ì„±â†‘ â†’ ê¸‰ì„±ê¸° ì¹˜ë£Œ(íŠ¸ë¦½íƒ„/NSAID) ë° íŠ¸ë¦¬ê±° êµìœ¡.`,
          `ì‹ ê²½í•™ì  ê²°ì†/ê¸‰ì„± ìµœì•… ë‘í†µì´ë©´ ${u} ì¦‰ì‹œ 2ì°¨ì„± ë°°ì œ(ì˜ìƒ).`,
          `ë¹ˆë²ˆ ì¬ë°œì´ë©´ ì˜ˆë°©ì¹˜ë£Œ ê³ ë ¤ + ì•½ë¬¼ê³¼ìš© ë‘í†µ ì²´í¬.`
        ]
      },
      {
        id:"sinus",
        when:["ì½”ë§‰í˜","ëˆ„ëŸ°ì½§ë¬¼","ì–¼êµ´í†µì¦","ë¶€ë¹„ë™","ì•ì´ë§ˆ","ìˆ™ì´ë©´ì•…í™”","ì¹˜í†µ"],
        dx:[
          {d:"ê¸‰ì„± ë¶€ë¹„ë™ì—¼(Acute sinusitis, unspecified)", icd:"J01.90"},
          {d:"ê¸´ì¥í˜• ë‘í†µ(Tension-type headache)", icd:"G44.209"},
          {d:"í¸ë‘í†µ(Migraine, unspecified)", icd:"G43.909"},
        ],
        next:(u)=>[
          `ë¹„ê°• ì¦ìƒ+ì–¼êµ´í†µ/ìˆ™ì´ë©´ ì•…í™”ë©´ ë¶€ë¹„ë™ì—¼ ê°€ëŠ¥ì„±â†‘ â†’ ëŒ€ì¦ì¹˜ë£Œ, ì„¸ê· ì„± ê¸°ì¤€ì´ë©´ í•­ìƒì œ í‰ê°€.`,
          `ì‹œë ¥/ì˜ì‹ë³€í™”/ê³ ì—´/ê²½ë¶€ê°•ì§ì´ë©´ ${u} í•©ë³‘ì¦/ì¤‘ì¦ ê°ì—¼ ë°°ì œ ìœ„í•´ ì¦‰ì‹œ í‰ê°€.`,
          `1ì£¼ ì´ìƒ ì§€ì†/ì•…í™” ì‹œ ì¬í‰ê°€(ì§„ì°°/ì˜ìƒ í•„ìš”ì„±) ê³„íš.`
        ]
      }
    ],
    dangerDx:[
      {d:"ì§€ì£¼ë§‰í•˜ì¶œí˜ˆ(Subarachnoid hemorrhage)", icd:"I60.9"},
      {d:"ìˆ˜ë§‰ì—¼(Meningitis, unspecified)", icd:"G03.9"},
      {d:"ë‡Œê²½ìƒ‰(Cerebral infarction, unspecified)", icd:"I63.9"},
    ],
    dangerQ:(u)=>[
      "SAH ë°°ì œ: ê°‘ìê¸°(ë²ˆê°œ) ì‹œì‘? â€˜í‰ìƒ ìµœì•…â€™ ë‘í†µ? ìš´ë™/ì„±í–‰ìœ„/ê¸°ì¹¨ í›„ ë°œìƒ?",
      "ìˆ˜ë§‰ì—¼ ë°°ì œ: ë°œì—´+ê²½ë¶€ê°•ì§+ì˜ì‹ë³€í™”/ê´‘ê³¼ë¯¼/ë°œì§„ ë™ë°˜?",
      "ë‡Œì¡¸ì¤‘ ë°°ì œ: í¸ì¸¡ ë§ˆë¹„/ê°ê°ì €í•˜, ë§ ì–´ëˆŒí•¨, ì‹œì•¼ì¥ì• , ë³´í–‰ì¥ì•  ë™ë°˜?"
    ],
    dangerSN:(u)=>[
      `ê°‘ì‘ â€˜ë²ˆê°œ/ìµœì•…â€™ ë‘í†µì´ë©´ ${u} ì¦‰ì‹œ ì‘ê¸‰ì‹¤(ì¶œí˜ˆ ë°°ì œ)ë¡œ ê°€ì„¸ìš”.`,
      `ë°œì—´Â·ê²½ë¶€ê°•ì§Â·ì˜ì‹ë³€í™”ê°€ ìˆìœ¼ë©´ ${u} ì¦‰ì‹œ ì‘ê¸‰ì‹¤(ìˆ˜ë§‰ì—¼ ë°°ì œ)ë¡œ ê°€ì„¸ìš”.`,
      `í¸ì¸¡ ë§ˆë¹„/ì–¸ì–´Â·ì‹œì•¼ ì¥ì• ê°€ ìˆìœ¼ë©´ ${u} ì¦‰ì‹œ 119/ì‘ê¸‰ì‹¤(ë‡Œì¡¸ì¤‘)ë¡œ ê°€ì„¸ìš”.`
    ],
    baseDx:[
      {d:"ê¸´ì¥í˜• ë‘í†µ(Tension-type headache)", icd:"G44.209"},
      {d:"í¸ë‘í†µ(Migraine)", icd:"G43.909"},
      {d:"ê¸‰ì„± ë¶€ë¹„ë™ì—¼(Acute sinusitis)", icd:"J01.90"},
    ],
    pickVariant(full){
      const t = normalize(full);
      if(hasAny(t, this.likelyVariants[2].when)) return this.likelyVariants[2];
      if(hasAny(t, this.likelyVariants[1].when)) return this.likelyVariants[1];
      if(hasAny(t, this.likelyVariants[0].when)) return this.likelyVariants[0];
      return null;
    }
  },
];

function pickCategory(full){
  for(const c of CATS){ if(hasAny(full, c.match)) return c; }
  return null;
}

function buildCtx(input){
  const ageN = parseInt(input.age || "", 10);
  const isReproF = input.sex==="F" && !Number.isNaN(ageN) && ageN >= 12 && ageN <= 55;
  return { isReproF };
}

/* =========================
   EMR note
   ========================= */
function buildNote(input, catName, likelyDx, dangerDx, qs, sn, next){
  const ts = nowStamp();
  const age = safe(input.age, "ë‚˜ì´ ë¯¸ìƒ");
  const sex = sexK(input.sex);
  const cc = safe(input.cc, "ì£¼ì¦ìƒ ë¯¸ìƒ");

  const duration = safe(input.duration, "ë¯¸ìƒ");
  const vitals = safe(input.vitals, "ë¯¸ìƒ");
  const pmh = safe(input.pmh, "ë¯¸ìƒ");
  const preg = input.preg ? (input.preg==="pregnant" ? "ì„ì‹  ì¤‘" : "ì‚°í›„(6ì£¼ ì´ë‚´)") : "ë¯¸ìƒ/í•´ë‹¹ ì—†ìŒ";
  const memo = safe(input.memo, "ì—†ìŒ/ë¯¸ìƒ");

  const ddxLikely = likelyDx.map((x,i)=>`- #${i+1} ${dxLine(x)}`).join("\n");
  const ddxDanger = dangerDx.map((x,i)=>`- *Danger#${i+1} ${dxLine(x)}`).join("\n");

  const qBlock = qs.map((q,i)=>`- Q${i+1}) ${q}  [ ]ì˜ˆ  [ ]ì•„ë‹ˆì˜¤  [ ]ë¯¸ìƒ`).join("\n");
  const snBlock = sn.map(s=>`- ${s}`).join("\n");
  const nextBlock = next.map(s=>`- ${s}`).join("\n");

  const base = [
    `=== Encounter Note (paste-ready) ===`,
    `Timestamp: ${ts}`,
    `Category: ${catName}`,
    ``,
    `[Chief Complaint]`,
    `- ${age}ì„¸ ${sex} / ì£¼ì¦ìƒ: ${cc}`,
    ``,
    `[HPI]`,
    `- ì‹œì‘/ê¸°ê°„: ${duration}`,
    `- ì¶”ê°€ ë©”ëª¨/ë™ë°˜: ${memo}`,
    ``,
    `[Vitals/Key Data]`,
    `- ${vitals}`,
    ``,
    `[PMH/Meds / Pregnancy]`,
    `- ê¸°ì €ì§ˆí™˜/ì•½ë¬¼: ${pmh}`,
    `- ì„ì‹ /ì‚°í›„: ${preg}`,
    ``,
    `[Assessment - Likely Dx (Top 3, ICD-10)]`,
    `${ddxLikely}`,
    ``,
    `[Must-not-miss (Danger Dx, ICD-10) - used for questions/safety-net]`,
    `${ddxDanger}`,
    ``,
    `[High-risk screen (asked)]`,
    `${qBlock}`,
    ``,
    `[Plan / Next steps (based on Likely #1)]`,
    `${nextBlock}`,
    ``,
    `[Safety-net (patient instructions)]`,
    `${snBlock}`,
    ``,
    `[Patient understanding]`,
    `- ì„¤ëª… ë° ì£¼ì˜ì‚¬í•­ ì•ˆë‚´í–ˆê³ , í™˜ì ì´í•´/ë™ì˜ ì—¬ë¶€: [ ]ì´í•´í•¨  [ ]ì¶”ê°€ì„¤ëª… í•„ìš”  [ ]ë¯¸ìƒ`,
  ];

  if(DETAIL==="detail"){
    base.push(
      ``,
      `[Documentation add-on]`,
      `- í™˜ì ì„ íƒ(ê²€ì‚¬/ì´ì†¡/ì‘ê¸‰ì‹¤ ë°©ë¬¸) ë° ê±°ë¶€/ì§€ì—° ì‹œ ì‚¬ìœ : [ ]ì—†ìŒ  [ ]ìˆìŒ( )  [ ]ë¯¸ìƒ`,
      `- ì¶”ì  ê³„íš(ì¬í‰ê°€/ê²€ì‚¬ ê²°ê³¼ í™•ì¸/ì—°ë½): [ ]ì•ˆë‚´í•¨  [ ]ë¯¸ìƒ`
    );
  }
  return base.join("\n");
}

/* =========================
   render
   ========================= */
function renderAll(){
  const input = {
    age: $("age").value,
    sex: $("sex").value,
    cc: $("cc").value,
    duration: $("duration").value,
    vitals: $("vitals").value,
    pmh: $("pmh").value,
    preg: $("preg").value,
    memo: $("memo").value,
  };

  const fullText = `${input.age} ${input.sex} ${input.cc} ${input.duration} ${input.vitals} ${input.pmh} ${input.preg} ${input.memo}`.trim();
  const urgencyWord = deriveUrgency(fullText, input.vitals || "");
  const cat = pickCategory(fullText);

  const catName = cat ? cat.name : "ì¼ë°˜(ë²”ìš©)";
  $("categoryPill").textContent = `ì¹´í…Œê³ ë¦¬: ${catName}`;

  const redHits = detectRed(fullText);
  if(redHits.length){
    $("alertBox").classList.add("show");
    $("alertText").textContent = `ê°ì§€ í‚¤ì›Œë“œ: ${redHits.slice(0,8).join(", ")}${redHits.length>8?" ...":""}`;
  }else{
    $("alertBox").classList.remove("show");
    $("alertText").textContent = "";
  }

  // === í•µì‹¬ ë¡œì§ ===
  let likelyDx, dangerDx, qs, sn, next;

  const ctx = buildCtx(input);

  if(cat){
    const v = cat.pickVariant(fullText);
    // ê°ë³„(ê°€ëŠ¥ì„± ë†’ì€ 3) = variant ìˆìœ¼ë©´ variant.dx, ì—†ìœ¼ë©´ baseDx
    likelyDx = v ? v.dx : cat.baseDx;

    // ìœ„í—˜ì§ˆí™˜ 3 = catì˜ dangerDx (ë³µí†µì€ ë§¥ë½ ë”°ë¼ ë³€í•¨)
    if(cat.id==="abd"){
      dangerDx = cat.dangerDxByCtx(ctx);
      qs = cat.dangerQ(urgencyWord, ctx);
      sn = cat.dangerSN(urgencyWord, ctx);
    }else{
      dangerDx = cat.dangerDx;
      qs = cat.dangerQ(urgencyWord);
      sn = cat.dangerSN(urgencyWord);
    }

    // ë‹¤ìŒ ì•¡ì…˜ = ê°€ëŠ¥ì„± #1 ê¸°ë°˜ (variant ìˆìœ¼ë©´ variant.next)
    if(v && typeof v.next === "function"){
      next = v.next(urgencyWord);
    }else{
      // variant ëª» ì¡ì•„ë„, baseDx[0] ê¸°ì¤€ìœ¼ë¡œ ìµœì†Œ ì•¡ì…˜
      next = [
        `ê°€ëŠ¥ì„± ë†’ì€ ì§„ë‹¨(#1: ${dxLine(likelyDx[0])}) ê¸°ì¤€ìœ¼ë¡œ 1ì°¨ ì²˜ì¹˜/ëŒ€ì¦ì¹˜ë£Œ í›„ ë‹¨ê¸° ì¶”ì  ê³„íš.`,
        `ë ˆë“œí”Œë˜ê·¸/í™œë ¥ ì´ìƒ ì‹œ ${urgencyWord} ìœ„í—˜ì§ˆí™˜ ë°°ì œ(ê²€ì‚¬/ì˜ë¢°/ì‘ê¸‰ì‹¤).`,
        `í˜¸ì „ ì—†ê±°ë‚˜ ì•…í™” ì‹œ ì¬í‰ê°€(ì¶”ê°€ ê²€ì‚¬/ì˜ë¢°) ê¸°ì¤€ì„ í™˜ìì—ê²Œ ë¬¸ì¥ìœ¼ë¡œ ì•ˆë‚´.`
      ];
    }

    // ì•ˆì „ë§/ì§ˆë¬¸ ë¬¸êµ¬ì— urgencyWord ì‚½ì…ë˜ë„ë¡ sn/qsëŠ” ì´ë¯¸ ë°˜ì˜ë¨
  } else {
    // ì¹´í…Œê³ ë¦¬ ëª» ì¡ìœ¼ë©´ â€œë²”ìš©â€: í”í•œ 3ê°œ(ì¦ìƒ ê¸°ë°˜) + ìœ„í—˜ì§ˆí™˜ ì§ˆë¬¸/ì•ˆì „ë§(ë²”ìš©)
    likelyDx = [
      {d:"ìƒê¸°ë„ê°ì—¼(Acute URI)", icd:"J06.9"},
      {d:"ê¸‰ì„± ê¸°ê´€ì§€ì—¼(Acute bronchitis)", icd:"J20.9"},
      {d:"ê¸‰ì„± ìœ„ì¥ì—¼/ì¥ì—¼(Gastroenteritis)", icd:"K52.9"},
    ];
    dangerDx = [
      {d:"ê¸‰ì„±ì‹¬ê·¼ê²½ìƒ‰(AMI)", icd:"I21.9"},
      {d:"ë‡Œì¡¸ì¤‘(ë‡Œê²½ìƒ‰, unspecified)", icd:"I63.9"},
      {d:"ìœ„ì¥ê´€ ì¶œí˜ˆ(GI hemorrhage)", icd:"K92.2"},
    ];
    qs = [
      "ì‹¬ì¥/í˜¸í¡ ì‘ê¸‰: ì§€ì† í‰í†µÂ·í˜¸í¡ê³¤ë€Â·ì‹¤ì‹ /ì˜ì‹ë³€í™” ìˆë‚˜ìš”?",
      "ì‹ ê²½í•™ì  ì‘ê¸‰: í¸ì¸¡ ë§ˆë¹„Â·ë§ ì–´ëˆŒí•¨Â·ì‹œì•¼ì¥ì•  ìˆë‚˜ìš”?",
      "ì¶œí˜ˆ/ì‡¼í¬: í† í˜ˆ/í˜ˆë³€/í‘ìƒ‰ë³€Â·ì–´ì§€ëŸ¼Â·ì‹¤ì‹  ìˆë‚˜ìš”?"
    ];
    sn = [
      `ì§€ì† í‰í†µ/í˜¸í¡ê³¤ë€/ì‹¤ì‹ Â·ì˜ì‹ë³€í™”ê°€ ìˆìœ¼ë©´ ${urgencyWord} ì‘ê¸‰ì‹¤ë¡œ ê°€ì„¸ìš”.`,
      `í¸ì¸¡ ë§ˆë¹„/ì–¸ì–´Â·ì‹œì•¼ ì¥ì• ê°€ ìˆìœ¼ë©´ ${urgencyWord} 119/ì‘ê¸‰ì‹¤ë¡œ ê°€ì„¸ìš”.`,
      `í† í˜ˆ/í˜ˆë³€/í‘ìƒ‰ë³€Â·ì‹¤ì‹ ì´ ìˆìœ¼ë©´ ${urgencyWord} ì‘ê¸‰ì‹¤ë¡œ ê°€ì„¸ìš”.`
    ];
    next = [
      `ê°€ëŠ¥ì„± ë†’ì€ ì§„ë‹¨(#1: ${dxLine(likelyDx[0])}) ì¤‘ì‹¬ìœ¼ë¡œ ëŒ€ì¦ì¹˜ë£Œ + ë‹¨ê¸° ì¶”ì .`,
      `ë ˆë“œí”Œë˜ê·¸/í™œë ¥ ì´ìƒ ì‹œ ${urgencyWord} ìœ„í—˜ì§ˆí™˜ ë°°ì œ(ê²€ì‚¬/ì˜ë¢°).`,
      `í˜¸ì „ ì—†ê±°ë‚˜ ì•…í™” ì‹œ ì¬í‰ê°€ ê³„íšê³¼ ì‘ê¸‰ ê¸°ì¤€ì„ ëª…í™•íˆ ì•ˆë‚´.`
    ];
  }

  // DETAIL ëª¨ë“œë©´ 1ì¤„ì”©ë§Œ ë³´ê°• (ê¸¸ì–´ì§€ì§€ ì•Šê²Œ)
  if(DETAIL==="detail"){
    next = [...next];
    next[0] = next[0] + " (ê¸°ë¡: í˜¸ì „/ì•…í™” ê¸°ì¤€, ì¶”ì  ì‹œê°„ í¬í•¨)";
  }

  // Render
  setList($("dxList"), likelyDx.map(dxLine));
  setList($("qList"), qs);
  setList($("snList"), sn);
  setList($("nextList"), next);

  $("noteOut").textContent = buildNote(input, catName, likelyDx, dangerDx, qs, sn, next);

  localStorage.setItem("pcp_cds_last_v4", JSON.stringify(input));
}

function resetAll(){
  ["age","cc","duration","vitals","pmh","memo"].forEach(id=>$(id).value="");
  $("sex").value=""; $("preg").value="";
  $("dxList").innerHTML = `<li class="muted">â€˜ìƒì„±â€™ ëˆ„ë¥´ë©´ ì±„ì›Œì§</li>`;
  $("qList").innerHTML  = `<li class="muted">â€˜ìƒì„±â€™ ëˆ„ë¥´ë©´ ì±„ì›Œì§</li>`;
  $("snList").innerHTML = `<li class="muted">â€˜ìƒì„±â€™ ëˆ„ë¥´ë©´ ì±„ì›Œì§</li>`;
  $("nextList").innerHTML = `<li class="muted">â€˜ìƒì„±â€™ ëˆ„ë¥´ë©´ ì±„ì›Œì§</li>`;
  $("noteOut").textContent="(ì—¬ê¸°ì— ìƒì„±ë¨)";
  $("categoryPill").textContent="ì¹´í…Œê³ ë¦¬: ìë™";
  $("alertBox").classList.remove("show");
  localStorage.removeItem("pcp_cds_last_v4");
}

// Events
$("genBtn").addEventListener("click", ()=>{
  if(!$("age").value.trim() || !$("sex").value || !$("cc").value.trim()){
    toast("í•„ìˆ˜ ì…ë ¥ ì¼ë¶€ê°€ ë¹„ì–´ ìˆì–´ë„ â€˜ë¯¸ìƒâ€™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤");
  }
  renderAll();
});
$("copyNoteBtn").addEventListener("click", ()=>copyText($("noteOut").textContent));
$("copyAllBtn").addEventListener("click", ()=>copyText($("noteOut").textContent));
$("downloadBtn").addEventListener("click", ()=>downloadText(`emr_note_${new Date().toISOString().slice(0,10)}.txt`, $("noteOut").textContent));

$("resetBtn").addEventListener("click", ()=>{
  if(!confirm("ì…ë ¥/ì¶œë ¥ì„ ì´ˆê¸°í™”í• ê¹Œìš”?")) return;
  resetAll(); toast("ì´ˆê¸°í™” ì™„ë£Œ");
});

$("copyDxBtn").addEventListener("click", ()=>{
  const items=[...document.querySelectorAll("#dxList li")].map(li=>li.textContent);
  copyText(items.map((x,i)=>`#${i+1} ${x}`).join("\n"));
});
$("copyQBtn").addEventListener("click", ()=>{
  const items=[...document.querySelectorAll("#qList li")].map(li=>li.textContent);
  copyText(items.map((x,i)=>`Q${i+1}. ${x}`).join("\n"));
});
$("copySNBtn").addEventListener("click", ()=>{
  const items=[...document.querySelectorAll("#snList li")].map(li=>li.textContent);
  copyText(items.map(x=>`- ${x}`).join("\n"));
});
$("copyNextBtn").addEventListener("click", ()=>{
  const items=[...document.querySelectorAll("#nextList li")].map(li=>li.textContent);
  copyText(items.map(x=>`- ${x}`).join("\n"));
});

$("shortBtn").addEventListener("click", ()=>{
  DETAIL="short";
  $("shortBtn").classList.add("active");
  $("detailBtn").classList.remove("active");
  toast("ì§§ê²Œ ëª¨ë“œ");
  if($("noteOut").textContent && $("noteOut").textContent !== "(ì—¬ê¸°ì— ìƒì„±ë¨)") renderAll();
});
$("detailBtn").addEventListener("click", ()=>{
  DETAIL="detail";
  $("detailBtn").classList.add("active");
  $("shortBtn").classList.remove("active");
  toast("ì¡°ê¸ˆ ë” ëª¨ë“œ");
  if($("noteOut").textContent && $("noteOut").textContent !== "(ì—¬ê¸°ì— ìƒì„±ë¨)") renderAll();
});

// init restore
(function init(){
  try{
    const raw = localStorage.getItem("pcp_cds_last_v4");
    if(raw){
      const d = JSON.parse(raw);
      $("age").value = d.age || "";
      $("sex").value = d.sex || "";
      $("cc").value = d.cc || "";
      $("duration").value = d.duration || "";
      $("vitals").value = d.vitals || "";
      $("pmh").value = d.pmh || "";
      $("preg").value = d.preg || "";
      $("memo").value = d.memo || "";
    }
  }catch(e){}
})();
</script>
</body>
</html>
