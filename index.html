<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì¦ìƒ ê¸°ë°˜ ê°ë³„Â·ë ˆë“œí”Œë˜ê·¸ ì§ˆë¬¸Â·ê¸°ë¡(ë²•ì  ë°©ì–´) ì§€ì›</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1620; --panel2:#0c121a;
      --text:#e8eef6; --muted:#9bb0c6; --line:#1d2a3a;
      --accent:#5aa9ff; --ok:#4fd1c5; --warn:#ffb020; --danger:#ff5a6a;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Apple SD Gothic Neo, Arial, "Helvetica Neue", Helvetica, sans-serif;
    }
    *{box-sizing:border-box}
    body{margin:0; background:linear-gradient(180deg,#070a0f 0%, #0b0f14 55%, #070a0f 100%); color:var(--text); font-family:var(--sans);}
    a{color:var(--accent); text-decoration:none}
    .wrap{max-width:1200px; margin:0 auto; padding:22px 18px 48px;}
    .topbar{
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
      margin-bottom:14px;
    }
    .title h1{font-size:18px; margin:0 0 6px; letter-spacing:.2px}
    .title p{margin:0; color:var(--muted); font-size:13px; line-height:1.4}
    .badges{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .badge{font-size:12px; padding:6px 10px; border:1px solid var(--line); border-radius:999px; background:rgba(255,255,255,.02)}
    .badge b{font-weight:700}
    .grid{display:grid; grid-template-columns: 1.05fr .95fr; gap:14px; align-items:start}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr; } .badges{justify-content:flex-start}}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.03) 0%, rgba(255,255,255,.015) 100%);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 12px;
      border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.12);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card .hd h2{font-size:14px; margin:0; letter-spacing:.2px}
    .card .bd{padding:14px}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    @media (max-width: 560px){ .row{grid-template-columns:1fr;} }
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    input, select, textarea{
      width:100%; color:var(--text); background:rgba(0,0,0,.22);
      border:1px solid var(--line); border-radius:12px; padding:10px 11px;
      outline:none; font-size:13px;
    }
    textarea{min-height:120px; resize:vertical; line-height:1.45}
    .help{font-size:12px; color:var(--muted); margin-top:8px; line-height:1.45}
    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    button{
      border:1px solid var(--line); background:rgba(255,255,255,.03);
      color:var(--text); padding:10px 12px; border-radius:12px;
      cursor:pointer; font-size:13px;
    }
    button.primary{border-color:rgba(90,169,255,.35); background:rgba(90,169,255,.12)}
    button.danger{border-color:rgba(255,90,106,.35); background:rgba(255,90,106,.10)}
    button:hover{filter:brightness(1.08)}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--line); background:rgba(255,255,255,.02);
      color:var(--muted);
    }
    .alert{
      border:1px solid rgba(255,90,106,.35);
      background:rgba(255,90,106,.10);
      padding:10px 12px; border-radius:14px; margin-bottom:12px;
      display:none;
    }
    .alert.show{display:block}
    .alert h3{margin:0 0 4px; font-size:13px; color:#ffd2d7}
    .alert p{margin:0; font-size:12px; color:#ffd2d7; line-height:1.45}
    .cols{display:grid; grid-template-columns:1fr; gap:12px}
    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.02) 0%, rgba(0,0,0,.08) 100%);
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
    }
    .panel .phd{
      padding:12px 12px 10px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background:rgba(0,0,0,.10);
    }
    .panel .phd h3{margin:0; font-size:13px}
    .panel .pbd{padding:12px}
    ul{margin:0; padding-left:18px}
    li{margin:6px 0; color:var(--text); font-size:13px; line-height:1.45}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .mono{font-family:var(--mono)}
    .kvs{display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px}
    @media (max-width: 560px){ .kvs{grid-template-columns:1fr;} }
    .kv{border:1px solid var(--line); border-radius:14px; padding:10px 10px; background:rgba(0,0,0,.16)}
    .kv .k{font-size:12px; color:var(--muted)}
    .kv .v{font-size:13px; margin-top:4px}
    .footer{
      margin-top:14px; color:var(--muted); font-size:12px; line-height:1.5
    }
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{padding:7px 10px; border-radius:999px; border:1px solid var(--line); background:rgba(255,255,255,.02); font-size:12px; color:var(--muted); cursor:pointer}
    .tab.active{border-color:rgba(90,169,255,.35); background:rgba(90,169,255,.12); color:var(--text)}
    .hidden{display:none !important}
    .hr{height:1px; background:var(--line); margin:10px 0}
    .rightNote{
      font-size:12px; color:var(--muted); line-height:1.45;
      padding:10px 12px; border:1px dashed rgba(155,176,198,.35);
      border-radius:14px; background:rgba(0,0,0,.10);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <h1>ì¦ìƒ ê¸°ë°˜ ê°ë³„Â·ë ˆë“œí”Œë˜ê·¸ ì§ˆë¬¸Â·ê¸°ë¡(ë²•ì  ë°©ì–´) ì§€ì›</h1>
        <p>
          ì…ë ¥ëœ ì¦ìƒ/ìƒí™©ì„ ë°”íƒ•ìœ¼ë¡œ <b>ê°ë³„ 3ê°œ</b>, <b>ë†“ì¹˜ë©´ ìœ„í—˜í•œ ì§ˆë¬¸ 3ê°œ</b>, <b>ê¸°ë¡Â·ì•ˆì „ë§Â·ì„¤ëª…(ë°©ì–´) ë¬¸êµ¬</b>ë¥¼ í…œí”Œë¦¿ìœ¼ë¡œ ì œì•ˆí•©ë‹ˆë‹¤.
          <span class="muted">ì„œë²„ ì „ì†¡ ì—†ì´ ë¸Œë¼ìš°ì € ë¡œì»¬ì—ì„œë§Œ ë™ì‘(ì˜µì…˜: ë¡œì»¬ ì €ì¥).</span>
        </p>
      </div>
      <div class="badges">
        <span class="badge"><b>âš ï¸</b> CDS: ì„ìƒíŒë‹¨ ëŒ€ì²´ ì•„ë‹˜</span>
        <span class="badge"><b>ğŸ”’</b> PHI ì…ë ¥ ê¸ˆì§€ ê¶Œì¥</span>
        <span class="badge"><b>ğŸ“</b> í…ìŠ¤íŠ¸ ë³µì‚¬/ë‚´ë³´ë‚´ê¸°</span>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Input -->
      <div class="card">
        <div class="hd">
          <h2>1) ì…ë ¥</h2>
          <div class="tabs" id="modeTabs">
            <div class="tab active" data-tab="triage">íŠ¸ë¦¬ì•„ì§€</div>
            <div class="tab" data-tab="chat">ì± íŒ… ë¡œê·¸</div>
            <div class="tab" data-tab="rules">ë£° í¸ì§‘</div>
          </div>
        </div>

        <div class="bd">
          <!-- TRIAGE TAB -->
          <div id="tab-triage">
            <div class="alert" id="redAlert">
              <h3>ì¦‰ì‹œ í‰ê°€ê°€ í•„ìš”í•œ â€œë ˆë“œ í”Œë˜ê·¸â€ ê°€ëŠ¥ì„±</h3>
              <p id="redAlertText">ì…ë ¥ ë‚´ìš©ì— ê³ ìœ„í—˜ í‚¤ì›Œë“œê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì‘ê¸‰ ëŒ€ì‘/ì¦‰ì‹œ ì§„ë£Œ í•„ìš” ì—¬ë¶€ë¥¼ ìš°ì„  í™•ì¸í•˜ì„¸ìš”.</p>
            </div>

            <div class="row">
              <div>
                <label>ì£¼ì¦ìƒ(ììœ ì„œìˆ )</label>
                <textarea id="symptoms" placeholder="ì˜ˆ: 3ì‹œê°„ ì „ë¶€í„° ì‹œì‘ëœ í‰í†µ, ì‹ì€ë•€, ìˆ¨ì°¸. ê¸°ì €ì§ˆí™˜: HTN."></textarea>
                <div class="help">íŒ: ì‹œê°„(ì–¸ì œë¶€í„°), ê°•ë„/ì–‘ìƒ, ë™ë°˜ì¦ìƒ, ìœ ë°œ/ì™„í™”ìš”ì¸, ê¸°ì €ì§ˆí™˜Â·ì•½ë¬¼Â·ì„ì‹ /ìˆ˜ìˆ Â·ì™¸ìƒ ì—¬ë¶€ë¥¼ ê°™ì´ ì¨ë‘ë©´ ë£° ë§¤ì¹­ì´ ì˜ ë©ë‹ˆë‹¤.</div>
              </div>
              <div>
                <label>ì»¨í…ìŠ¤íŠ¸(ê°„ë‹¨)</label>
                <div class="row">
                  <div>
                    <label class="small">ë‚˜ì´</label>
                    <input id="age" type="number" min="0" placeholder="ì˜ˆ: 42" />
                  </div>
                  <div>
                    <label class="small">ì„±ë³„</label>
                    <select id="sex">
                      <option value="">ì„ íƒ</option>
                      <option value="F">ì—¬</option>
                      <option value="M">ë‚¨</option>
                      <option value="O">ê¸°íƒ€/ë¯¸ìƒ</option>
                    </select>
                  </div>
                </div>
                <div class="row" style="margin-top:10px">
                  <div>
                    <label class="small">ì„ì‹ /ì‚°í›„</label>
                    <select id="preg">
                      <option value="">í•´ë‹¹ ì—†ìŒ/ë¯¸ìƒ</option>
                      <option value="pregnant">ì„ì‹  ì¤‘</option>
                      <option value="postpartum">ì‚°í›„(6ì£¼ ì´ë‚´)</option>
                    </select>
                  </div>
                  <div>
                    <label class="small">ì¦ìƒ ì§€ì†</label>
                    <input id="duration" placeholder="ì˜ˆ: 3ì‹œê°„ / 2ì¼ / 2ì£¼" />
                  </div>
                </div>

                <div class="kvs">
                  <div class="kv">
                    <div class="k">í™œë ¥ì§•í›„(ì„ íƒ)</div>
                    <div class="v muted small">BP / HR / RR / Temp / SpO2</div>
                  </div>
                  <div class="kv">
                    <div class="k">ê³¼ê±°ë ¥/ì•½ë¬¼(ì„ íƒ)</div>
                    <div class="v muted small">DM/HTN/í¡ì—°/í•­ì‘ê³ ì œ/ë©´ì—­ì €í•˜ ë“±</div>
                  </div>
                </div>

                <div class="row" style="margin-top:10px">
                  <div>
                    <label class="small">í™œë ¥/ìœ„í—˜ ë©”ëª¨</label>
                    <input id="vitals" placeholder="ì˜ˆ: BP 90/60 HR 120 SpO2 90%" />
                  </div>
                  <div>
                    <label class="small">ê³¼ê±°ë ¥/ì•½ë¬¼ ë©”ëª¨</label>
                    <input id="pmh" placeholder="ì˜ˆ: DM, Warfarin ë³µìš©" />
                  </div>
                </div>

                <div class="btns">
                  <button class="primary" id="analyzeBtn">ë¶„ì„/í…œí”Œë¦¿ ìƒì„±</button>
                  <button id="newSessionBtn">ìƒˆ ì„¸ì…˜</button>
                  <button class="danger" id="clearBtn">ì „ì²´ ì´ˆê¸°í™”</button>
                </div>
                <div class="help">
                  âš ï¸ <b>ê°œì¸ì •ë³´(PHI)</b>ëŠ” ì…ë ¥í•˜ì§€ ì•ŠëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤. (ì´ í˜ì´ì§€ëŠ” ì„œë²„ ì „ì†¡ì€ ì—†ì§€ë§Œ, ê¸°ê¸°/ë¸Œë¼ìš°ì € ì €ì¥ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤.)
                </div>
              </div>
            </div>
          </div>

          <!-- CHAT TAB -->
          <div id="tab-chat" class="hidden">
            <div class="rightNote">
              ì—¬ê¸°ëŠ” â€œì˜ë£Œ ìƒë‹´ ì± íŒ… ê¸°ë¡â€ì„ <b>ë°©ì–´ì— ìœ ë¦¬í•œ í˜•íƒœë¡œ ì •ë¦¬</b>í•˜ëŠ” íƒ­ì…ë‹ˆë‹¤.  
              í™˜ì ë°œì–¸/ì˜ì‚¬ ì„¤ëª…/í™˜ì ì´í•´ í™•ì¸/ì•ˆì „ë§(ì¬ë‚´ì› ê¸°ì¤€)/ì¶”ì  ê³„íšì„ ë¹ ì§ì—†ì´ ë‚¨ê¸°ê²Œ ì„¤ê³„í–ˆìŠµë‹ˆë‹¤.
            </div>
            <div style="margin-top:12px">
              <label>í™˜ì ë©”ì‹œì§€(ìš”ì•½)</label>
              <textarea id="ptMsg" placeholder="í™˜ìê°€ í•œ ë§(ìš”ì•½) â€” ì˜ˆ: 'ê°€ìŠ´ì´ ì¥ì–´ì§œë“¯ ì•„í”„ê³  ìˆ¨ì´ ì°¨ìš”. ì˜¤ëŠ˜ ì²˜ìŒì´ì—ìš”.'"></textarea>
            </div>
            <div style="margin-top:10px">
              <label>ì˜ì‚¬ ë‹µë³€(ì„¤ëª…/ê³„íš/ì•ˆì „ë§ í¬í•¨)</label>
              <textarea id="mdMsg" placeholder="ì˜ì‚¬ê°€ í•œ ë§(ìš”ì•½) â€” ìœ„í—˜ ì„¤ëª…, ê¶Œê³ , ëŒ€ì•ˆ, follow-up, ì‘ê¸‰ ì‹œ í–‰ë™ ì§€ì¹¨ ë“±"></textarea>
            </div>
            <div class="btns">
              <button class="primary" id="addChatBtn">ë¡œê·¸ì— ì¶”ê°€</button>
              <button id="copyChatBtn">ì± íŒ… ë¡œê·¸ ë³µì‚¬</button>
              <button id="downloadChatBtn">ì± íŒ… ë¡œê·¸ .txt ì €ì¥</button>
              <button class="danger" id="clearChatBtn">ì± íŒ… ë¡œê·¸ ì‚­ì œ</button>
            </div>
            <div class="hr"></div>
            <div>
              <div class="pill">ì„¸ì…˜ ë¡œê·¸ (ë¡œì»¬ ì €ì¥ ì˜µì…˜)</div>
              <pre id="chatLog" class="mono" style="white-space:pre-wrap; margin:10px 0 0; padding:12px; background:rgba(0,0,0,.22); border:1px solid var(--line); border-radius:14px; min-height:120px;">(ì•„ì§ ì—†ìŒ)</pre>
              <div class="help">
                ë¬¸ì„œí™”ëŠ” ì†Œì†¡ ë°©ì–´ì—ì„œ â€œíƒ€ì„ë¼ì¸/ì˜ì‚¬ê²°ì •/í™˜ì ë°˜ì‘â€ì„ ë³´ì—¬ì£¼ëŠ” í•µì‹¬ ê·¼ê±°ê°€ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. :contentReference[oaicite:3]{index=3}  
              </div>
            </div>
          </div>

          <!-- RULES TAB -->
          <div id="tab-rules" class="hidden">
            <div class="rightNote">
              ë£°ì€ <b>í‚¤ì›Œë“œ ê¸°ë°˜</b>ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤. (ê°„ë‹¨/ë¹ ë¦„)  
              ë³‘ì› í”„ë¡œí† ì½œ/ê°€ì´ë“œë¼ì¸ì— ë§ì¶° í‚¤ì›Œë“œÂ·ì¶œë ¥ í…œí”Œë¦¿ì„ ë°”ê¾¸ë©´ ì‹¤ì œ ì‚¬ìš©ì„±ì´ ì˜¬ë¼ê°‘ë‹ˆë‹¤.
            </div>
            <div style="margin-top:12px">
              <label>ë£° JSON (í¸ì§‘ ê°€ëŠ¥)</label>
              <textarea id="rulesJson" class="mono" style="min-height:260px"></textarea>
              <div class="btns">
                <button class="primary" id="applyRulesBtn">ë£° ì ìš©</button>
                <button id="resetRulesBtn">ê¸°ë³¸ ë£°ë¡œ ë˜ëŒë¦¬ê¸°</button>
                <button id="copyRulesBtn">ë£° JSON ë³µì‚¬</button>
              </div>
              <div class="help">
                âš ï¸ ì´ ë£°ì€ â€œì˜ˆì‹œâ€ì…ë‹ˆë‹¤. ì§„ë‹¨/ì¹˜ë£Œ ì§€ì¹¨ì´ ì•„ë‹ˆë¼ <b>ê¸°ë¡ê³¼ ì§ˆë¬¸ ëˆ„ë½ ë°©ì§€</b>ë¥¼ ë•ëŠ” í…œí”Œë¦¿ìœ¼ë¡œ ì“°ì„¸ìš”. CDSëŠ” ì„ìƒíŒë‹¨ì„ ëŒ€ì²´í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. :contentReference[oaicite:4]{index=4}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT: Output -->
      <div class="card">
        <div class="hd">
          <h2>2) ì¶œë ¥</h2>
          <div class="pill" id="matchInfo">ë£° ë§¤ì¹­: -</div>
        </div>

        <div class="bd">
          <div class="cols">
            <div class="panel">
              <div class="phd">
                <h3>ìë™ ê°ë³„ 3ê°œ (í…œí”Œë¦¿)</h3>
                <div class="btns" style="margin:0">
                  <button id="copyDxBtn">ë³µì‚¬</button>
                </div>
              </div>
              <div class="pbd">
                <ul id="dxList"><li class="muted">ì…ë ¥ í›„ â€œë¶„ì„/í…œí”Œë¦¿ ìƒì„±â€ì„ ëˆ„ë¥´ì„¸ìš”.</li></ul>
                <div class="help">* â€œìƒìœ„ 3ê°œâ€ëŠ” ë£° ê¸°ë°˜ ì œì•ˆì…ë‹ˆë‹¤. ì‹¤ì œ ìš°ì„ ìˆœìœ„ëŠ” vital/ìœ„í—˜ì¸ì/ì§„ì°°/ê²€ì‚¬ë¡œ ì¬ì •ë ¬í•˜ì„¸ìš”.</div>
              </div>
            </div>

            <div class="panel">
              <div class="phd">
                <h3>ë†“ì¹˜ë©´ ìœ„í—˜í•œ ì§ˆë¬¸ 3ê°œ</h3>
                <div class="btns" style="margin:0">
                  <button id="copyQBtn">ë³µì‚¬</button>
                </div>
              </div>
              <div class="pbd">
                <ul id="qList"><li class="muted">ì…ë ¥ í›„ ìë™ ìƒì„±ë©ë‹ˆë‹¤.</li></ul>
                <div class="help">
                  â€œì•ˆì „ë§(safety-netting)â€ì€ ë¶ˆí™•ì‹¤ì„± ìƒí™©ì—ì„œ íŠ¹íˆ ì¤‘ìš”í•˜ê³ , <b>ì–´ë–¤ ê²½ê³  ì¦ìƒ ì‹œ ì–´ë–»ê²Œ í–‰ë™í•´ì•¼ í•˜ëŠ”ì§€</b>ë¥¼ ëª…ì‹œí•˜ëŠ” ê²ƒì´ í•µì‹¬ì…ë‹ˆë‹¤. :contentReference[oaicite:5]{index=5}
                </div>
              </div>
            </div>

            <div class="panel">
              <div class="phd">
                <h3>ê¸°ë¡/ì± íŒ…(ë²•ì  ë°©ì–´ì— ë„ì›€) ë¬¸êµ¬</h3>
                <div class="btns" style="margin:0">
                  <button id="copyDocBtn">ë³µì‚¬</button>
                  <button id="downloadNoteBtn">ë…¸íŠ¸ .txt ì €ì¥</button>
                </div>
              </div>
              <div class="pbd">
                <ul id="docList"><li class="muted">ì…ë ¥ í›„ ìë™ ìƒì„±ë©ë‹ˆë‹¤.</li></ul>
                <div class="help">
                  ê¸°ë¡ì€ â€œë¬´ì—‡ì„/ì™œ/ì–¸ì œ/ëˆ„ê°€/ì–´ë–»ê²Œ í–ˆê³  í™˜ìê°€ ì–´ë–»ê²Œ ë°˜ì‘í–ˆëŠ”ì§€â€ê°€ ë¶„ëª…í•´ì•¼ í•©ë‹ˆë‹¤. :contentReference[oaicite:6]{index=6}  
                  ê°ê´€ì  ì‚¬ì‹¤ ìœ„ì£¼ë¡œ, ë¹„ë‚œ/ì¶”ì¸¡/ì‚¬ê³ ë³´ê³ ì„œ ì–¸ê¸‰ ë“±ì€ í”¼í•˜ëŠ” ê²ƒì´ ì¼ë°˜ì ì¸ ë¦¬ìŠ¤í¬ê´€ë¦¬ ì›ì¹™ì…ë‹ˆë‹¤. :contentReference[oaicite:7]{index=7}
                </div>
              </div>
            </div>

            <div class="panel">
              <div class="phd">
                <h3>í•œ ë²ˆì— ë¶™ì—¬ë„£ëŠ” â€œì§„ë£Œ ë…¸íŠ¸â€ í…ìŠ¤íŠ¸</h3>
                <div class="btns" style="margin:0">
                  <button class="primary" id="copyNoteBtn">ë…¸íŠ¸ ë³µì‚¬</button>
                </div>
              </div>
              <div class="pbd">
                <pre id="noteOut" class="mono" style="white-space:pre-wrap; margin:0; padding:12px; background:rgba(0,0,0,.22); border:1px solid var(--line); border-radius:14px; min-height:180px;">(ë…¸íŠ¸ê°€ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤)</pre>
                <div class="help">
                  í¬í•¨ ìš”ì†Œ: ì¦ìƒìš”ì•½/ìœ„í—˜ì¸ì/í•µì‹¬ ê°ë³„/ë ˆë“œí”Œë˜ê·¸ ìŒì„±Â·ì–‘ì„±/ì„¤ëª…Â·ê³µìœ ì˜ì‚¬ê²°ì •/ì•ˆì „ë§/ì¶”ì  ê³„íš/í™˜ì ì´í•´ í™•ì¸.
                </div>
              </div>
            </div>
          </div>

          <div class="footer">
            <b>ë©´ì±…</b>: ë³¸ í˜ì´ì§€ëŠ” â€œì˜ë£Œ í…œí”Œë¦¿/ë¬¸ì„œí™” ë³´ì¡°(CDS)â€ì´ë©°, ì§„ë‹¨Â·ì¹˜ë£Œë¥¼ ì§€ì‹œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìµœì¢… ì˜ì‚¬ê²°ì •ì€ ì„ìƒì˜ ì±…ì„ í•˜ì— ì´ë£¨ì–´ì ¸ì•¼ í•©ë‹ˆë‹¤. :contentReference[oaicite:8]{index=8}
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   1) ê¸°ë³¸ ë£°(ì˜ˆì‹œ) â€” ë³‘ì› ë§ì¶¤ìœ¼ë¡œ ë°”ê¾¸ëŠ” ìš©ë„
   ========================= */

const DEFAULT_RULES = [
  {
    id: "chest_pain",
    name: "í‰í†µ/í‰ë¶€ë¶ˆí¸",
    keywords: ["í‰í†µ","ê°€ìŠ´í†µì¦","ê°€ìŠ´ì´","ì¥ì–´ì§œ","ì••ë°•ê°","èƒ¸ç—›","chest pain","ë°©ì‚¬í†µ","ì‹ì€ë•€"],
    redFlags: ["ì‹ì€ë•€","ì‹¤ì‹ ","í˜¸í¡ê³¤ë€","SpO2","ì €í˜ˆì••","ì²­ìƒ‰ì¦","ì˜ì‹ì €í•˜"],
    topDx: [
      "ê¸‰ì„±ê´€ìƒë™ë§¥ì¦í›„êµ°(ACS) ê°€ëŠ¥ì„±",
      "íìƒ‰ì „ì¦(PE) ê°€ëŠ¥ì„±",
      "ëŒ€ë™ë§¥ë°•ë¦¬(Aortic dissection) ê°€ëŠ¥ì„±"
    ],
    mustAsk: [
      "í†µì¦ ì–‘ìƒ/ë°©ì‚¬/ì‹œì‘ ì‹œì /ìµœëŒ€ê°•ë„(ê°‘ìê¸°? ì ì§„?) + ë™ë°˜(í˜¸í¡ê³¤ë€/ì‹¤ì‹ /ë°œí•œ/êµ¬ì—­)",
      "ìœ„í—˜ì¸ì: í¡ì—°, HTN/DM, ê°€ì¡±ë ¥, ìµœê·¼ ìˆ˜ìˆ /ì¥ê±°ë¦¬, OCP/ì„ì‹ Â·ì‚°í›„, DVT ë³‘ë ¥",
      "í˜„ì¬ í™œë ¥ì§•í›„/SpO2/ì˜ì‹ ìƒíƒœ + ìš´ë™ ì‹œ ì•…í™”/ì•ˆì • ì‹œ í˜¸ì „ ì—¬ë¶€"
    ],
    docPrompts: [
      "ì¤‘ì¦ ê°€ëŠ¥ì„±ì„ ì„¤ëª…í–ˆê³ (ACS/PE/ë°•ë¦¬ ë“±), ì¦‰ì‹œ í‰ê°€(ì‘ê¸‰ì‹¤/ê²€ì‚¬) í•„ìš”ì„±ì„ ê¶Œê³ í•¨.",
      "í™˜ì ì´í•´ ì—¬ë¶€ë¥¼ í™•ì¸í–ˆê³ , ë™ì˜/ê±°ë¶€(ê±°ë¶€ ì‹œ ì´ìœ ) ë° ëŒ€ì•ˆ(ê´€ì°°/ì¶”ì )ê³¼ ìœ„í—˜ì„ ê¸°ë¡í•¨.",
      "ì•…í™”/ê²½ê³  ì¦ìƒ(í˜¸í¡ê³¤ë€, ì‹¤ì‹ , ì§€ì†/ì•…í™”ë˜ëŠ” í‰í†µ, ì‹ ê²½í•™ì  ì¦ìƒ ë“±) ì‹œ ì¦‰ì‹œ ì‘ê¸‰ì‹¤ ë°©ë¬¸ ì•ˆë‚´(safety-netting) ê¸°ë¡."
    ]
  },
  {
    id: "dyspnea",
    name: "í˜¸í¡ê³¤ë€",
    keywords: ["í˜¸í¡ê³¤ë€","ìˆ¨ì°¸","ìˆ¨ì´ ì°¨","dyspnea","wheezing","ì²œëª…","SpO2","ê¸°ì¹¨","ê°í˜ˆ"],
    redFlags: ["SpO2","ì²­ìƒ‰ì¦","ì˜ì‹ì €í•˜","í‰í†µ","ì €í˜ˆì••","ê°í˜ˆ","í˜¸í¡ìˆ˜"],
    topDx: [
      "ì²œì‹/ê¸°ê´€ì§€ê²½ë ¨ í˜¹ì€ COPD ì•…í™”",
      "íë ´/ê°ì—¼ì„± í˜¸í¡ê¸° ì§ˆí™˜",
      "íìƒ‰ì „ì¦(PE) ë˜ëŠ” ì‹¬ë¶€ì „ ì•…í™”"
    ],
    mustAsk: [
      "SpO2/í˜¸í¡ìˆ˜/ë§í•˜ëŠ” ë¬¸ì¥ ê°€ëŠ¥ ì—¬ë¶€ + ì²­ìƒ‰ì¦/ì˜ì‹ì €í•˜ ì—¬ë¶€",
      "í‰í†µ/ê°í˜ˆ/ë‹¤ë¦¬ë¶€ì¢…Â·í†µì¦/ìµœê·¼ ìˆ˜ìˆ Â·ì¥ê±°ë¦¬Â·ì„ì‹ Â·ì‚°í›„ ë“± í˜ˆì „ ìœ„í—˜",
      "ë°œì—´/ì˜¤í•œ/ê°€ë˜/ë…¸ì¶œë ¥ + ê¸°ì € íì§ˆí™˜/ì‹¬ë¶€ì „/í¡ì—°ë ¥"
    ],
    docPrompts: [
      "ì´ˆê¸° ì¤‘ì¦ë„(í™œë ¥Â·SpO2Â·í˜¸í¡ìˆ˜) í‰ê°€ ë° ì¬í‰ê°€ ê²°ê³¼ë¥¼ ê¸°ë¡í•¨.",
      "ì‘ê¸‰ ì§•í›„ê°€ ì˜ì‹¬ë  ê²½ìš° ì¦‰ì‹œ ìƒê¸‰ì˜ë£Œê¸°ê´€/ì‘ê¸‰ì‹¤ í‰ê°€ ê¶Œê³  ë° í™˜ì ë°˜ì‘ì„ ê¸°ë¡í•¨.",
      "ì¹˜ë£Œ/ì²˜ì¹˜ í›„ ë°˜ì‘(ì¦ìƒ ë³€í™”, SpO2 ë³€í™” ë“±)ê³¼ ì¶”ì  ê³„íšì„ ê¸°ë¡í•¨."
    ]
  },
  {
    id: "abdominal_pain",
    name: "ë³µí†µ",
    keywords: ["ë³µí†µ","ë°°ê°€","ë³µë¶€","abdominal pain","êµ¬í† ","í˜ˆë³€","í† í˜ˆ","ì„¤ì‚¬","ë³€ë¹„","ë°˜ë°œí†µ"],
    redFlags: ["í† í˜ˆ","í˜ˆë³€","ë°˜ë°œí†µ","ë³µë¶€ê°•ì§","ì˜ì‹ì €í•˜","ì €í˜ˆì••","ê³ ì—´","ì„ì‹ ","ì‚°í›„"],
    topDx: [
      "ê¸‰ì„±ë³µì¦(ì¶©ìˆ˜ì—¼/ë‹´ë‚­ì—¼/ì²œê³µ/ì¥íìƒ‰ ë“±) ê°€ëŠ¥ì„±",
      "ìœ„ì¥ê´€ ì¶œí˜ˆ(í† í˜ˆ/í˜ˆë³€ ë™ë°˜ ì‹œ) ê°€ëŠ¥ì„±",
      "ì‚°ë¶€ì¸ê³¼ì  ì‘ê¸‰(ì„ì‹  ê°€ëŠ¥ì„±/ì‚°í›„) í¬í•¨ ê°ë³„ í•„ìš”"
    ],
    mustAsk: [
      "í†µì¦ ìœ„ì¹˜/ì´ë™/ë°˜ë°œí†µÂ·ê°•ì§ ì—¬ë¶€ + êµ¬í† /í˜ˆë³€/í† í˜ˆ/ë°œì—´ ë™ë°˜ ì—¬ë¶€",
      "ì„ì‹  ê°€ëŠ¥ì„±/ë§ˆì§€ë§‰ ìƒë¦¬/ì‚°í›„ ì—¬ë¶€ + ê³¨ë°˜í†µ/ì§ˆì¶œí˜ˆ ì—¬ë¶€",
      "ìˆ˜ìˆ ë ¥(ìœ ì°©), í•­ì‘ê³ ì œ/NSAID, ë©´ì—­ì €í•˜, íƒˆìˆ˜, ì†Œë³€ì¦ìƒ(ì˜†êµ¬ë¦¬í†µ) ì—¬ë¶€"
    ],
    docPrompts: [
      "ê¸‰ì„±ë³µì¦/ì¶œí˜ˆ/ì„ì‹  ê´€ë ¨ ì‘ê¸‰ ê°€ëŠ¥ì„±ì„ ì„¤ëª…í•˜ê³ , í•„ìš”í•œ ê²€ì‚¬Â·ì´ì†¡ ê¶Œê³ ë¥¼ ê¸°ë¡í•¨.",
      "ë³µë¶€ì§„ì°° ì†Œê²¬(êµ­ì†Œ ì••í†µ/ë°˜ë°œí†µ/ê°•ì§ ë“±)ê³¼ í™œë ¥ì§•í›„ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ê¸°ë¡í•¨.",
      "ì•ˆì „ë§: ì•…í™”, ì§€ì† êµ¬í† , í˜ˆë³€/í† í˜ˆ, ê³ ì—´, ì‹¤ì‹ /ì €í˜ˆì•• ì‹œ ì¦‰ì‹œ ë‚´ì›/ì‘ê¸‰ì‹¤ ë°©ë¬¸ ì•ˆë‚´ ê¸°ë¡."
    ]
  },
  {
    id: "headache",
    name: "ë‘í†µ",
    keywords: ["ë‘í†µ","ë¨¸ë¦¬ê°€","headache","ë²ˆê°œ","ìµœì•…","ê²½ë¶€ê°•ì§","ì‹œì•¼","ë§ˆë¹„","ì‹¤ì‹ ","êµ¬í† "],
    redFlags: ["ê°‘ìê¸°","ìµœì•…","ë²ˆê°œ","ê²½ë¶€ê°•ì§","ì‹ ê²½í•™ì ","ì˜ì‹ì €í•˜","ë°œì—´","ì‹œì•¼ì¥ì• ","ì„ì‹ ","ì‚°í›„"],
    topDx: [
      "ì§€ì£¼ë§‰í•˜ì¶œí˜ˆ/ë‡Œí˜ˆê´€ì„± ì›ì¸(ë²ˆê°œë‘í†µ/ì‹ ê²½í•™ì  ì§•í›„ ì‹œ)",
      "ë‡Œìˆ˜ë§‰ì—¼/ê°ì—¼(ë°œì—´+ê²½ë¶€ê°•ì§ ë“±)",
      "í¸ë‘í†µ/ê¸´ì¥ì„± ë‘í†µ(ë ˆë“œí”Œë˜ê·¸ ì—†ì„ ë•Œ)"
    ],
    mustAsk: [
      "ë°œë³‘ ì–‘ìƒ(ê°‘ìê¸°/ë²ˆê°œ), 'í‰ìƒ ìµœì•…' ì—¬ë¶€ + ì‹ ê²½í•™ì  ê²°ì†(ë§ˆë¹„/ì–¸ì–´/ì‹œì•¼) í™•ì¸",
      "ë°œì—´/ê²½ë¶€ê°•ì§/ì˜ì‹ë³€í™”/ê´‘ê³¼ë¯¼/ë°œì§„ ë“± ê°ì—¼ ì§•í›„",
      "ì„ì‹ Â·ì‚°í›„/ê³ í˜ˆì••/í•­ì‘ê³ ì œ/ì™¸ìƒ/ì•”/ë©´ì—­ì €í•˜ ë“± ìœ„í—˜ì¸ì"
    ],
    docPrompts: [
      "ë ˆë“œí”Œë˜ê·¸(ê¸‰ì„±ë°œë³‘, ì‹ ê²½í•™ì  ê²°ì†, ë°œì—´/ê²½ë¶€ê°•ì§ ë“±) ìœ ë¬´ë¥¼ ë¬¸ì„œí™”í•¨.",
      "ê³ ìœ„í—˜ ì†Œê²¬ ì‹œ ì¦‰ì‹œ í‰ê°€(ì˜ìƒ/ì‘ê¸‰ì‹¤) í•„ìš”ì„±ì„ ì„¤ëª…í•˜ê³  í™˜ì ë°˜ì‘(ìˆ˜ìš©/ê±°ë¶€)ì„ ê¸°ë¡í•¨.",
      "ì•ˆì „ë§: ì‹ ê²½í•™ì  ì¦ìƒ, ì˜ì‹ë³€í™”, ì•…í™”, ì§€ì† êµ¬í† /ê³ ì—´ ì‹œ ì¦‰ì‹œ ë‚´ì› ì•ˆë‚´ ê¸°ë¡."
    ]
  }
];

// ì „ì—­ ìƒíƒœ
let RULES = loadRules();
let currentMatch = null;
let chatEntries = loadChat();

/* =========================
   2) íƒ­ UI
   ========================= */
const tabs = document.querySelectorAll("#modeTabs .tab");
tabs.forEach(t => t.addEventListener("click", () => {
  tabs.forEach(x => x.classList.remove("active"));
  t.classList.add("active");
  const tab = t.dataset.tab;
  document.getElementById("tab-triage").classList.toggle("hidden", tab !== "triage");
  document.getElementById("tab-chat").classList.toggle("hidden", tab !== "chat");
  document.getElementById("tab-rules").classList.toggle("hidden", tab !== "rules");
}));

/* =========================
   3) ìœ í‹¸
   ========================= */
function nowStamp(){
  const d = new Date();
  const pad = n => String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}
function normalize(s){ return (s||"").toLowerCase(); }
function containsAny(text, arr){
  const t = normalize(text);
  return arr.some(k => t.includes(normalize(k)));
}
function top3(arr){
  return arr.slice(0,3);
}
function copyText(txt){
  navigator.clipboard.writeText(txt).then(()=>{
    toast("ë³µì‚¬í–ˆìŠµë‹ˆë‹¤");
  }).catch(()=>{
    alert("ë³µì‚¬ ì‹¤íŒ¨. ë¸Œë¼ìš°ì € ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.");
  });
}
function downloadText(filename, txt){
  const blob = new Blob([txt], {type:"text/plain;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
function toast(msg){
  const el = document.createElement("div");
  el.textContent = msg;
  el.style.position="fixed";
  el.style.bottom="18px";
  el.style.left="50%";
  el.style.transform="translateX(-50%)";
  el.style.padding="10px 12px";
  el.style.border="1px solid rgba(90,169,255,.35)";
  el.style.background="rgba(90,169,255,.12)";
  el.style.borderRadius="12px";
  el.style.color="white";
  el.style.zIndex=9999;
  el.style.fontSize="13px";
  el.style.boxShadow="0 10px 25px rgba(0,0,0,.35)";
  document.body.appendChild(el);
  setTimeout(()=>el.remove(), 1200);
}

/* =========================
   4) ë£° ë¡œë”©/ì €ì¥
   ========================= */
function loadRules(){
  try{
    const raw = localStorage.getItem("cds_rules_v1");
    if(!raw) return DEFAULT_RULES;
    const parsed = JSON.parse(raw);
    if(Array.isArray(parsed) && parsed.length) return parsed;
    return DEFAULT_RULES;
  }catch(e){
    return DEFAULT_RULES;
  }
}
function saveRules(rules){
  localStorage.setItem("cds_rules_v1", JSON.stringify(rules, null, 2));
}
function loadChat(){
  try{
    const raw = localStorage.getItem("cds_chat_v1");
    if(!raw) return [];
    const parsed = JSON.parse(raw);
    return Array.isArray(parsed) ? parsed : [];
  }catch(e){ return []; }
}
function saveChat(){
  localStorage.setItem("cds_chat_v1", JSON.stringify(chatEntries, null, 2));
}

/* =========================
   5) ë¶„ì„ ì—”ì§„(í‚¤ì›Œë“œ ê¸°ë°˜)
   ========================= */
function matchRule(symText, ctxText){
  const full = `${symText}\n${ctxText}`;
  let best = null;
  let bestScore = 0;

  for(const r of RULES){
    const hits = r.keywords.filter(k => normalize(full).includes(normalize(k)));
    const score = hits.length;
    if(score > bestScore){
      bestScore = score;
      best = { rule:r, hits };
    }
  }
  return bestScore > 0 ? best : null;
}

function detectRedFlags(rule, fullText){
  // ë£°ë³„ redFlags + ê³µí†µ ë ˆë“œ í”Œë˜ê·¸ í‚¤ì›Œë“œ
  const common = ["ì˜ì‹ì €í•˜","ì‹¤ì‹ ","ê²½ë ¨","ë§ˆë¹„","ë§ì´ ì–´ëˆŒ","ì²­ìƒ‰ì¦","í† í˜ˆ","í˜ˆë³€","ê°‘ìê¸°","ìµœì•…","ê²½ë¶€ê°•ì§","SpO2","ì €í˜ˆì••","í˜¸í¡ê³¤ë€","í‰í†µ"];
  const flags = [...new Set([...(rule?.redFlags||[]), ...common])];
  const hit = flags.filter(k => normalize(fullText).includes(normalize(k)));
  return hit;
}

function buildOutputs(sym, age, sex, preg, dur, vitals, pmh){
  const ctx = `age:${age||"-"} sex:${sex||"-"} preg:${preg||"-"} duration:${dur||"-"} vitals:${vitals||"-"} pmh:${pmh||"-"}`;
  const match = matchRule(sym, ctx);
  currentMatch = match;

  const full = `${sym}\n${ctx}`;

  const redHits = detectRedFlags(match?.rule, full);
  renderRedAlert(redHits);

  const rule = match?.rule;
  const dx = rule ? top3(rule.topDx) : [
    "ë£° ë¯¸ë§¤ì¹­: í•µì‹¬ ì¦ìƒ/ì‹œê°„ê²½ê³¼/ë™ë°˜ì¦ìƒ/ìœ„í—˜ì¸ìë¥¼ ë” êµ¬ì²´ì ìœ¼ë¡œ ì…ë ¥í•´ ë³´ì„¸ìš”.",
    "ë£° ë¯¸ë§¤ì¹­: ë³‘ì› í”„ë¡œí† ì½œì— ë§ëŠ” í‚¤ì›Œë“œ ë£°ì„ ì¶”ê°€/í¸ì§‘í•˜ì„¸ìš”.",
    "ë£° ë¯¸ë§¤ì¹­: ê°ë³„ì€ í™œë ¥ì§•í›„Â·ì§„ì°°Â·ê²€ì‚¬ ê¸°ë°˜ìœ¼ë¡œ ì¬ì •ë ¬ì´ í•„ìš”í•©ë‹ˆë‹¤."
  ];
  const qs = rule ? top3(rule.mustAsk) : [
    "ë ˆë“œí”Œë˜ê·¸(ì˜ì‹/í˜¸í¡/í‰í†µ/ì‹ ê²½í•™ì  ê²°ì†/ì¶œí˜ˆ/ê³ ì—´) ì—¬ë¶€ë¥¼ ë¨¼ì € í™•ì¸í–ˆë‚˜ìš”?",
    "í˜„ì¬ í™œë ¥ì§•í›„(SpO2 í¬í•¨)ì™€ ì•…í™” ì†ë„ë¥¼ í™•ì¸í–ˆë‚˜ìš”?",
    "ìœ„í—˜ì¸ì(ì„ì‹ Â·ì‚°í›„/í•­ì‘ê³ ì œ/ë©´ì—­ì €í•˜/ìµœê·¼ ìˆ˜ìˆ Â·ì¥ê±°ë¦¬ ë“±)ë¥¼ í™•ì¸í–ˆë‚˜ìš”?"
  ];
  const docs = rule ? top3(rule.docPrompts) : [
    "í™˜ì ì„œìˆ /í•µì‹¬ ì†Œê²¬/ë ˆë“œí”Œë˜ê·¸ ìœ ë¬´ë¥¼ ê°ê´€ì ìœ¼ë¡œ ê¸°ë¡í•¨.",
    "ë¶ˆí™•ì‹¤ì„±ê³¼ ê³ ìœ„í—˜ ê°€ëŠ¥ì„±ì„ ì„¤ëª…í–ˆê³ , ê¶Œê³ (ê²€ì‚¬/ì´ì†¡/ê´€ì°°) ë° í™˜ì ë°˜ì‘ì„ ê¸°ë¡í•¨.",
    "ì•ˆì „ë§: ì•…í™”/ê²½ê³  ì¦ìƒ ì‹œ ì¦‰ì‹œ ë‚´ì›(ì‘ê¸‰ì‹¤) + ì¶”ì  ê³„íš(ì¬í‰ê°€/ê²€ì‚¬ ê²°ê³¼ í™•ì¸) ê¸°ë¡."
  ];

  // note í…ìŠ¤íŠ¸ êµ¬ì„±(SOAP-ish)
  const note = [
    `=== ë°©ë¬¸ ìš”ì•½ (ìë™ í…œí”Œë¦¿) ===`,
    `Timestamp: ${nowStamp()}`,
    ``,
    `[S] ì£¼í˜¸ì†Œ/ê²½ê³¼`,
    `- ${sym || "(ë¯¸ì…ë ¥)"}`,
    `- Duration: ${dur || "-"}`,
    ``,
    `[Context]`,
    `- Age/Sex: ${age || "-"} / ${sex || "-"}`,
    `- Pregnancy/Postpartum: ${preg || "-"}`,
    `- Vitals: ${vitals || "-"}`,
    `- PMH/Meds: ${pmh || "-"}`,
    ``,
    `[Assessment] í•µì‹¬ ê°ë³„(í…œí”Œë¦¿)`,
    ...dx.map((d,i)=>`- #${i+1} ${d}`),
    ``,
    `[Risk check] ë†“ì¹˜ë©´ ìœ„í—˜í•œ í™•ì¸ ì§ˆë¬¸(í…œí”Œë¦¿)`,
    ...qs.map((q,i)=>`- Q${i+1}. ${q}`),
    ``,
    `[Plan/Documentation prompts] ê¸°ë¡Â·ì„¤ëª…Â·ì•ˆì „ë§`,
    ...docs.map((d,i)=>`- ${d}`),
    ``,
    `[Safety-netting] (ê¶Œì¥ ë¬¸êµ¬ ì˜ˆì‹œ)`,
    `- â€œí˜„ì¬ë¡œì„œëŠ” ì›ì¸ì´ í™•ì •ë˜ì§€ ì•Šì•„ ê²½ê³¼ ê´€ì°°/ì¶”ê°€ í‰ê°€ê°€ í•„ìš”í•©ë‹ˆë‹¤.â€`,
    `- â€œì•„ë˜ ê²½ê³  ì¦ìƒ(ì˜ˆ: ì˜ì‹ë³€í™”/í˜¸í¡ê³¤ë€/ì§€ì†Â·ì•…í™” í†µì¦/ì¶œí˜ˆ/ì‹ ê²½í•™ì  ì¦ìƒ)ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì‘ê¸‰ì‹¤ë¡œ ê°€ì„¸ìš”.â€`,
    `- â€œì¶”ì  ê³„íš: ì¬í‰ê°€ ì‹œì /ê²€ì‚¬ ê²°ê³¼ í™•ì¸ ë°©ë²•/ì—°ë½ ê²½ë¡œë¥¼ ì•ˆë‚´í–ˆìŠµë‹ˆë‹¤.â€`,
  ].join("\n");

  return { match, dx, qs, docs, note, redHits };
}

/* =========================
   6) ë Œë”
   ========================= */
function renderList(el, items){
  el.innerHTML = "";
  items.forEach(x=>{
    const li = document.createElement("li");
    li.textContent = x;
    el.appendChild(li);
  });
}
function renderMatchInfo(match){
  const el = document.getElementById("matchInfo");
  if(!match){
    el.textContent = "ë£° ë§¤ì¹­: ì—†ìŒ";
    return;
  }
  const { rule, hits } = match;
  el.textContent = `ë£° ë§¤ì¹­: ${rule.name} (hits: ${hits.length})`;
}
function renderRedAlert(redHits){
  const box = document.getElementById("redAlert");
  const txt = document.getElementById("redAlertText");
  if(redHits.length){
    box.classList.add("show");
    txt.textContent = `ê°ì§€ëœ í‚¤ì›Œë“œ: ${redHits.slice(0,8).join(", ")}${redHits.length>8?" ...":""}  â†’ ì‘ê¸‰/ì¦‰ì‹œí‰ê°€ í•„ìš” ì—¬ë¶€ë¥¼ ìš°ì„  í™•ì¸í•˜ì„¸ìš”.`;
  }else{
    box.classList.remove("show");
  }
}
function renderChat(){
  const pre = document.getElementById("chatLog");
  if(!chatEntries.length){
    pre.textContent = "(ì•„ì§ ì—†ìŒ)";
    return;
  }
  const text = chatEntries.map((e,i)=>(
`[${i+1}] ${e.time}
- í™˜ì: ${e.patient}
- ì˜ì‚¬: ${e.doctor}
`)).join("\n");
  pre.textContent = text.trim();
}

/* =========================
   7) ì´ë²¤íŠ¸
   ========================= */
document.getElementById("analyzeBtn").addEventListener("click", ()=>{
  const sym = document.getElementById("symptoms").value.trim();
  const age = document.getElementById("age").value.trim();
  const sex = document.getElementById("sex").value;
  const preg = document.getElementById("preg").value;
  const dur = document.getElementById("duration").value.trim();
  const vitals = document.getElementById("vitals").value.trim();
  const pmh = document.getElementById("pmh").value.trim();

  const out = buildOutputs(sym, age, sex, preg, dur, vitals, pmh);

  renderMatchInfo(out.match);
  renderList(document.getElementById("dxList"), out.dx);
  renderList(document.getElementById("qList"), out.qs);
  renderList(document.getElementById("docList"), out.docs);
  document.getElementById("noteOut").textContent = out.note;

  // ì„¸ì…˜ ìë™ ì €ì¥(ì…ë ¥ë§Œ)
  localStorage.setItem("cds_last_input_v1", JSON.stringify({sym, age, sex, preg, dur, vitals, pmh}));
});

document.getElementById("copyDxBtn").addEventListener("click", ()=>{
  const items = [...document.querySelectorAll("#dxList li")].map(li=>li.textContent);
  copyText(items.map((x,i)=>`#${i+1} ${x}`).join("\n"));
});
document.getElementById("copyQBtn").addEventListener("click", ()=>{
  const items = [...document.querySelectorAll("#qList li")].map(li=>li.textContent);
  copyText(items.map((x,i)=>`Q${i+1}. ${x}`).join("\n"));
});
document.getElementById("copyDocBtn").addEventListener("click", ()=>{
  const items = [...document.querySelectorAll("#docList li")].map(li=>li.textContent);
  copyText(items.map((x,i)=>`- ${x}`).join("\n"));
});
document.getElementById("copyNoteBtn").addEventListener("click", ()=>{
  copyText(document.getElementById("noteOut").textContent);
});
document.getElementById("downloadNoteBtn").addEventListener("click", ()=>{
  downloadText(`visit-note_${new Date().toISOString().slice(0,10)}.txt`, document.getElementById("noteOut").textContent);
});

document.getElementById("newSessionBtn").addEventListener("click", ()=>{
  document.getElementById("symptoms").value = "";
  document.getElementById("duration").value = "";
  document.getElementById("vitals").value = "";
  document.getElementById("pmh").value = "";
  toast("ìƒˆ ì„¸ì…˜ ì‹œì‘");
});

document.getElementById("clearBtn").addEventListener("click", ()=>{
  if(!confirm("ì…ë ¥/ì¶œë ¥/ì €ì¥ëœ ë§ˆì§€ë§‰ ì…ë ¥ì„ ì´ˆê¸°í™”í• ê¹Œìš”?")) return;
  ["symptoms","age","duration","vitals","pmh"].forEach(id=>document.getElementById(id).value="");
  document.getElementById("sex").value="";
  document.getElementById("preg").value="";
  document.getElementById("dxList").innerHTML = `<li class="muted">ì…ë ¥ í›„ â€œë¶„ì„/í…œí”Œë¦¿ ìƒì„±â€ì„ ëˆ„ë¥´ì„¸ìš”.</li>`;
  document.getElementById("qList").innerHTML = `<li class="muted">ì…ë ¥ í›„ ìë™ ìƒì„±ë©ë‹ˆë‹¤.</li>`;
  document.getElementById("docList").innerHTML = `<li class="muted">ì…ë ¥ í›„ ìë™ ìƒì„±ë©ë‹ˆë‹¤.</li>`;
  document.getElementById("noteOut").textContent = "(ë…¸íŠ¸ê°€ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤)";
  document.getElementById("matchInfo").textContent = "ë£° ë§¤ì¹­: -";
  document.getElementById("redAlert").classList.remove("show");
  localStorage.removeItem("cds_last_input_v1");
  toast("ì´ˆê¸°í™” ì™„ë£Œ");
});

/* CHAT */
document.getElementById("addChatBtn").addEventListener("click", ()=>{
  const p = document.getElementById("ptMsg").value.trim();
  const m = document.getElementById("mdMsg").value.trim();
  if(!p || !m){ alert("í™˜ì/ì˜ì‚¬ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”."); return; }
  chatEntries.push({ time: nowStamp(), patient: p, doctor: m });
  saveChat();
  renderChat();
  document.getElementById("ptMsg").value="";
  document.getElementById("mdMsg").value="";
  toast("ë¡œê·¸ì— ì¶”ê°€");
});
document.getElementById("copyChatBtn").addEventListener("click", ()=>{
  copyText(document.getElementById("chatLog").textContent);
});
document.getElementById("downloadChatBtn").addEventListener("click", ()=>{
  downloadText(`chat-log_${new Date().toISOString().slice(0,10)}.txt`, document.getElementById("chatLog").textContent);
});
document.getElementById("clearChatBtn").addEventListener("click", ()=>{
  if(!confirm("ì± íŒ… ë¡œê·¸ë¥¼ ì‚­ì œí• ê¹Œìš”?")) return;
  chatEntries = [];
  saveChat();
  renderChat();
  toast("ì‚­ì œ ì™„ë£Œ");
});

/* RULES */
document.getElementById("applyRulesBtn").addEventListener("click", ()=>{
  try{
    const parsed = JSON.parse(document.getElementById("rulesJson").value);
    if(!Array.isArray(parsed) || !parsed.length) throw new Error("ë£°ì€ ë°°ì—´ì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
    // ì•„ì£¼ ìµœì†Œí•œì˜ ìŠ¤í‚¤ë§ˆ ì²´í¬
    parsed.forEach(r=>{
      ["id","name","keywords","topDx","mustAsk","docPrompts"].forEach(k=>{
        if(!(k in r)) throw new Error(`í•„ìˆ˜ í•„ë“œ ëˆ„ë½: ${k}`);
      });
      if(!Array.isArray(r.keywords)) throw new Error("keywordsëŠ” ë°°ì—´ì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
      if(!Array.isArray(r.topDx) || !Array.isArray(r.mustAsk) || !Array.isArray(r.docPrompts)) throw new Error("topDx/mustAsk/docPromptsëŠ” ë°°ì—´ì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
    });
    RULES = parsed;
    saveRules(RULES);
    toast("ë£° ì ìš© ì™„ë£Œ");
  }catch(e){
    alert("ë£° JSON ì˜¤ë¥˜: " + e.message);
  }
});
document.getElementById("resetRulesBtn").addEventListener("click", ()=>{
  RULES = DEFAULT_RULES;
  saveRules(RULES);
  document.getElementById("rulesJson").value = JSON.stringify(RULES, null, 2);
  toast("ê¸°ë³¸ ë£°ë¡œ ë³µì›");
});
document.getElementById("copyRulesBtn").addEventListener("click", ()=>{
  copyText(document.getElementById("rulesJson").value);
});

/* =========================
   8) ì´ˆê¸° ë¡œë”©(ë§ˆì§€ë§‰ ì…ë ¥/ë£°/ì±—)
   ========================= */
function init(){
  document.getElementById("rulesJson").value = JSON.stringify(RULES, null, 2);

  // ë§ˆì§€ë§‰ ì…ë ¥ ë³µì›
  try{
    const raw = localStorage.getItem("cds_last_input_v1");
    if(raw){
      const d = JSON.parse(raw);
      document.getElementById("symptoms").value = d.sym || "";
      document.getElementById("age").value = d.age || "";
      document.getElementById("sex").value = d.sex || "";
      document.getElementById("preg").value = d.preg || "";
      document.getElementById("duration").value = d.dur || "";
      document.getElementById("vitals").value = d.vitals || "";
      document.getElementById("pmh").value = d.pmh || "";
    }
  }catch(e){}

  renderChat();
}
init();
</script>
</body>
</html>
