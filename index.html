<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>1ì°¨ ì˜ë£Œìš©: ê°ë³„Â·ë ˆë“œí”Œë˜ê·¸Â·EMR ë³µë¶™</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1620; --panel2:#0c121a;
      --text:#e8eef6; --muted:#9bb0c6; --line:#1d2a3a;
      --accent:#5aa9ff; --warn:#ffb020; --danger:#ff5a6a; --ok:#4fd1c5;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Apple SD Gothic Neo, Arial, "Helvetica Neue", Helvetica, sans-serif;
    }
    *{box-sizing:border-box}
    body{margin:0; background:linear-gradient(180deg,#070a0f 0%, #0b0f14 55%, #070a0f 100%); color:var(--text); font-family:var(--sans);}
    .wrap{max-width:1200px; margin:0 auto; padding:20px 16px 46px;}
    .topbar{display:flex; gap:12px; align-items:flex-start; justify-content:space-between; margin-bottom:12px; flex-wrap:wrap}
    h1{font-size:18px; margin:0 0 6px}
    .sub{color:var(--muted); font-size:13px; line-height:1.45}
    .badge{font-size:12px; padding:6px 10px; border:1px solid var(--line); border-radius:999px; background:rgba(255,255,255,.02); color:var(--muted)}
    .grid{display:grid; grid-template-columns: 1fr 1.1fr; gap:12px; align-items:start}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.03) 0%, rgba(255,255,255,.015) 100%);
      border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden;
    }
    .hd{padding:12px 14px; border-bottom:1px solid var(--line); background:rgba(0,0,0,.12); display:flex; align-items:center; justify-content:space-between; gap:10px}
    .hd h2{font-size:14px; margin:0}
    .bd{padding:14px}

    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    input, select, textarea{
      width:100%; color:var(--text); background:rgba(0,0,0,.22);
      border:1px solid var(--line); border-radius:12px; padding:10px 11px; outline:none; font-size:13px;
    }
    textarea{min-height:110px; resize:vertical; line-height:1.45}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    @media (max-width: 560px){ .row{grid-template-columns:1fr;} }

    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    button{
      border:1px solid var(--line); background:rgba(255,255,255,.03);
      color:var(--text); padding:10px 12px; border-radius:12px;
      cursor:pointer; font-size:13px;
    }
    button.primary{border-color:rgba(90,169,255,.35); background:rgba(90,169,255,.12)}
    button.danger{border-color:rgba(255,90,106,.35); background:rgba(255,90,106,.10)}
    button:hover{filter:brightness(1.08)}

    .hint{font-size:12px; color:var(--muted); margin-top:8px; line-height:1.45}
    details{
      border:1px dashed rgba(155,176,198,.35);
      border-radius:14px;
      padding:10px 12px;
      background:rgba(0,0,0,.10);
      margin-top:10px;
    }
    summary{cursor:pointer; color:var(--muted); font-size:12px}
    .pill{display:inline-flex; gap:8px; align-items:center; font-size:12px; padding:6px 10px; border:1px solid var(--line); border-radius:999px; color:var(--muted); background:rgba(255,255,255,.02)}
    .alert{
      border:1px solid rgba(255,90,106,.35);
      background:rgba(255,90,106,.10);
      padding:10px 12px; border-radius:14px; margin:0 0 12px;
      display:none;
    }
    .alert.show{display:block}
    .alert b{color:#ffd2d7}

    /* Output layout: 2x2 tiles + EMR block */
    .outGrid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width: 700px){ .outGrid{grid-template-columns:1fr;} }

    .tile{
      border:1px solid var(--line);
      border-radius:16px;
      background:linear-gradient(180deg, rgba(255,255,255,.02) 0%, rgba(0,0,0,.08) 100%);
      overflow:hidden;
    }
    .tile .thd{padding:10px 12px; border-bottom:1px solid var(--line); background:rgba(0,0,0,.10); display:flex; justify-content:space-between; align-items:center; gap:8px}
    .tile .thd h3{margin:0; font-size:13px}
    .tile .tbd{padding:10px 12px}
    ul{margin:0; padding-left:18px}
    li{margin:6px 0; font-size:13px; line-height:1.45}
    .muted{color:var(--muted)}
    .mono{font-family:var(--mono)}
    pre{
      white-space:pre-wrap;
      margin:0;
      padding:12px;
      background:rgba(0,0,0,.22);
      border:1px solid var(--line);
      border-radius:14px;
      min-height:220px;
      font-size:12.5px;
      line-height:1.45;
    }
    .toggleRow{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .seg{
      display:inline-flex; border:1px solid var(--line); border-radius:999px; overflow:hidden;
      background:rgba(255,255,255,.02)
    }
    .seg button{
      border:0; border-right:1px solid var(--line);
      border-radius:0; padding:7px 10px; background:transparent; color:var(--muted); font-size:12px;
    }
    .seg button:last-child{border-right:0}
    .seg button.active{background:rgba(90,169,255,.12); color:var(--text)}
    .footer{margin-top:10px; color:var(--muted); font-size:12px; line-height:1.5}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>1ì°¨ ì˜ë£Œê¸°ê´€ìš©: ê°ë³„ 3 Â· ìœ„í—˜ ì§ˆë¬¸ 3 Â· EMR ë³µë¶™ ë…¸íŠ¸</h1>
        <div class="sub">
          í•„ìˆ˜ ì…ë ¥ì€ <b>ë‚˜ì´Â·ì„±ë³„Â·ì£¼ì¦ìƒ</b>ë§Œ. ë‚˜ë¨¸ì§€ëŠ” ì„ íƒ. ì¶œë ¥ì€ ì§§ê²Œ ë³´ì—¬ì£¼ê³ , ì•„ë˜ì— <b>EMRì— ë°”ë¡œ ë¶™ì—¬ë„£ëŠ” ë…¸íŠ¸</b>ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
        </div>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
        <span class="badge">âš ï¸ ì§„ë‹¨/ì¹˜ë£Œ ì§€ì‹œ ì•„ë‹˜</span>
        <span class="badge">ğŸ”’ PHI ìµœì†Œ ì…ë ¥ ê¶Œì¥</span>
        <span class="badge">ğŸ“ ë³µì‚¬ 1í´ë¦­</span>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Input -->
      <div class="card">
        <div class="hd">
          <h2>ì…ë ¥</h2>
          <div class="toggleRow">
            <span class="pill" id="modePill">ìë™ ìƒì„±</span>
            <div class="seg" aria-label="detail toggle">
              <button id="shortBtn" class="active" type="button">ì§§ê²Œ</button>
              <button id="detailBtn" type="button">ì¡°ê¸ˆ ë”</button>
            </div>
          </div>
        </div>
        <div class="bd">
          <div class="row">
            <div>
              <label>ë‚˜ì´ (í•„ìˆ˜)</label>
              <input id="age" type="number" min="0" placeholder="ì˜ˆ: 42" />
            </div>
            <div>
              <label>ì„±ë³„ (í•„ìˆ˜)</label>
              <select id="sex">
                <option value="">ì„ íƒ</option>
                <option value="F">ì—¬</option>
                <option value="M">ë‚¨</option>
                <option value="O">ê¸°íƒ€/ë¯¸ìƒ</option>
              </select>
            </div>
          </div>

          <div style="margin-top:10px">
            <label>ì£¼ì¦ìƒ/ìƒí™© (í•„ìˆ˜) â€” í™˜ì ë§ ê·¸ëŒ€ë¡œ ì ì–´ë„ ë¨</label>
            <textarea id="cc" placeholder="ì˜ˆ: 'ê°€ìŠ´ì´ ì¥ì–´ì§œë“¯ ì•„í”„ê³  ì‹ì€ë•€ì´ ë‚˜ìš”. 2ì‹œê°„ ì „ë¶€í„°. ìˆ¨ë„ ì°¨ìš”.'"></textarea>
          </div>

          <details>
            <summary>ì¶”ê°€ ì •ë³´(ì„ íƒ) â€” ìˆìœ¼ë©´ ë” ì •í™•í•œ ë¬¸êµ¬ë¡œ ìƒì„±ë¨</summary>
            <div class="row" style="margin-top:10px">
              <div>
                <label>ì¦ìƒ ì‹œì‘/ê¸°ê°„</label>
                <input id="duration" placeholder="ì˜ˆ: 2ì‹œê°„ ì „ / 3ì¼ì§¸" />
              </div>
              <div>
                <label>í™œë ¥ì§•í›„/SpO2</label>
                <input id="vitals" placeholder="ì˜ˆ: BP 90/60 HR 120 SpO2 90%" />
              </div>
            </div>
            <div class="row" style="margin-top:10px">
              <div>
                <label>ê¸°ì €ì§ˆí™˜/ì•½ë¬¼</label>
                <input id="pmh" placeholder="ì˜ˆ: HTN, DM / í•­ì‘ê³ ì œ ë³µìš©" />
              </div>
              <div>
                <label>ì„ì‹ /ì‚°í›„</label>
                <select id="preg">
                  <option value="">í•´ë‹¹ ì—†ìŒ/ë¯¸ìƒ</option>
                  <option value="pregnant">ì„ì‹  ì¤‘</option>
                  <option value="postpartum">ì‚°í›„(6ì£¼ ì´ë‚´)</option>
                </select>
              </div>
            </div>
            <div style="margin-top:10px">
              <label>ì¶”ê°€ ë©”ëª¨</label>
              <input id="memo" placeholder="ì˜ˆ: ì•Œë ˆë¥´ê¸°, ìµœê·¼ ìˆ˜ìˆ /ì¥ê±°ë¦¬, ì™¸ìƒ, ê³ ìœ„í—˜ ë³‘ë ¥ ë“±" />
            </div>
          </details>

          <div class="btns">
            <button class="primary" id="genBtn">ìƒì„±</button>
            <button id="copyAllBtn">EMR ë…¸íŠ¸ ë³µì‚¬</button>
            <button class="danger" id="resetBtn">ì´ˆê¸°í™”</button>
          </div>

          <div class="hint">
            íŒ: ì—¬ê¸° ëª©ì ì€ â€œë– ë¨¹ì—¬ì£¼ëŠ” EMR ë¬¸êµ¬â€ë¼ì„œ, ì •ë³´ê°€ ë¶€ì¡±í•˜ë©´ <b>â€˜ë¯¸ìƒâ€™ìœ¼ë¡œ ìë™ ì±„ì›€</b>.
          </div>
        </div>
      </div>

      <!-- RIGHT: Output -->
      <div class="card">
        <div class="hd">
          <h2>ì¶œë ¥</h2>
          <span class="pill" id="categoryPill">ì¹´í…Œê³ ë¦¬: ìë™</span>
        </div>
        <div class="bd">
          <div class="alert" id="alertBox">
            <div><b>ë ˆë“œí”Œë˜ê·¸ ê°€ëŠ¥ì„±</b> í‚¤ì›Œë“œê°€ ê°ì§€ë¨ â†’ ì‘ê¸‰/ì¦‰ì‹œí‰ê°€ í•„ìš” ì—¬ë¶€ë¥¼ ë¨¼ì € í™•ì¸</div>
            <div class="muted" id="alertText" style="margin-top:6px;font-size:12px"></div>
          </div>

          <div class="outGrid">
            <div class="tile">
              <div class="thd">
                <h3>ê°ë³„ 3</h3>
                <button type="button" id="copyDxBtn">ë³µì‚¬</button>
              </div>
              <div class="tbd">
                <ul id="dxList"><li class="muted">â€˜ìƒì„±â€™ ëˆ„ë¥´ë©´ ì±„ì›Œì§</li></ul>
              </div>
            </div>

            <div class="tile">
              <div class="thd">
                <h3>ë†“ì¹˜ë©´ ìœ„í—˜í•œ ì§ˆë¬¸ 3</h3>
                <button type="button" id="copyQBtn">ë³µì‚¬</button>
              </div>
              <div class="tbd">
                <ul id="qList"><li class="muted">â€˜ìƒì„±â€™ ëˆ„ë¥´ë©´ ì±„ì›Œì§</li></ul>
              </div>
            </div>

            <div class="tile">
              <div class="thd">
                <h3>í™˜ìì—ê²Œ ë°”ë¡œ ì „ë‹¬(ì•ˆì „ë§) 3ì¤„</h3>
                <button type="button" id="copySNBtn">ë³µì‚¬</button>
              </div>
              <div class="tbd">
                <ul id="snList"><li class="muted">â€˜ìƒì„±â€™ ëˆ„ë¥´ë©´ ì±„ì›Œì§</li></ul>
              </div>
            </div>

            <div class="tile">
              <div class="thd">
                <h3>EMR â€œì± íŒ…/ì „í™”â€ ë…¸íŠ¸ 3ì¤„</h3>
                <button type="button" id="copyChatNoteBtn">ë³µì‚¬</button>
              </div>
              <div class="tbd">
                <ul id="chatNoteList"><li class="muted">â€˜ìƒì„±â€™ ëˆ„ë¥´ë©´ ì±„ì›Œì§</li></ul>
              </div>
            </div>
          </div>

          <div style="margin-top:10px" class="tile">
            <div class="thd">
              <h3>EMRì— ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ê¸°</h3>
              <div style="display:flex; gap:8px; flex-wrap:wrap;">
                <button type="button" class="primary" id="copyNoteBtn">ë…¸íŠ¸ ë³µì‚¬</button>
                <button type="button" id="downloadBtn">.txt ì €ì¥</button>
              </div>
            </div>
            <div class="tbd">
              <pre id="noteOut" class="mono">(ì—¬ê¸°ì— ìƒì„±ë¨)</pre>
            </div>
          </div>

          <div class="footer">
            ë©´ì±…: ë³¸ í˜ì´ì§€ëŠ” ë¬¸êµ¬/ëˆ„ë½ ë°©ì§€ ë³´ì¡° ë„êµ¬ì´ë©° ì§„ë‹¨Â·ì¹˜ë£Œë¥¼ ëŒ€ì²´í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   UX ëª©í‘œ
   - ë£°/ë¯¸ë§¤ì¹­ ì—†ìŒ
   - í•„ìˆ˜: ë‚˜ì´/ì„±ë³„/ì£¼ì¦ìƒ
   - ì¶œë ¥ì€ ì§§ê²Œ(4íƒ€ì¼) + EMR ë…¸íŠ¸
   - ì¹´í…Œê³ ë¦¬ ì¶”ì •ì€ ë‚´ë¶€ í‚¤ì›Œë“œ(ìˆ¨ê¹€)ë¡œë§Œ í•˜ê³ , ì•ˆ ë§ìœ¼ë©´ ë²”ìš© í…œí”Œë¦¿
   ========================= */

let DETAIL = "short"; // short | detail

const $ = (id) => document.getElementById(id);

function toast(msg){
  const el = document.createElement("div");
  el.textContent = msg;
  el.style.position="fixed";
  el.style.bottom="18px";
  el.style.left="50%";
  el.style.transform="translateX(-50%)";
  el.style.padding="10px 12px";
  el.style.border="1px solid rgba(90,169,255,.35)";
  el.style.background="rgba(90,169,255,.12)";
  el.style.borderRadius="12px";
  el.style.color="white";
  el.style.zIndex=9999;
  el.style.fontSize="13px";
  el.style.boxShadow="0 10px 25px rgba(0,0,0,.35)";
  document.body.appendChild(el);
  setTimeout(()=>el.remove(), 1200);
}
function normalize(s){ return (s||"").toLowerCase(); }
function hasAny(text, kws){
  const t = normalize(text);
  return kws.some(k=>t.includes(normalize(k)));
}
function copyText(txt){
  navigator.clipboard.writeText(txt).then(()=>toast("ë³µì‚¬ ì™„ë£Œ")).catch(()=>alert("ë³µì‚¬ ì‹¤íŒ¨(ê¶Œí•œ í™•ì¸)"));
}
function downloadText(filename, txt){
  const blob = new Blob([txt], {type:"text/plain;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}
function setList(el, items){
  el.innerHTML="";
  items.forEach(x=>{
    const li=document.createElement("li"); li.textContent=x; el.appendChild(li);
  });
}
function nowStamp(){
  const d = new Date();
  const pad = n => String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

/* =========================
   ë‚´ë¶€ í‚¤ì›Œë“œ ì¹´í…Œê³ ë¦¬(ì‚¬ìš©ìì—ê²Œ "ë£°" ë…¸ì¶œ ì—†ìŒ)
   ========================= */
const CATS = [
  {
    id:"chest",
    name:"í‰í†µ/í‰ë¶€ë¶ˆí¸",
    match:["í‰í†µ","ê°€ìŠ´í†µì¦","ê°€ìŠ´ì´","ì¥ì–´ì§œ","ì••ë°•ê°","ë°©ì‚¬","ì‹ì€ë•€","chest pain","èƒ¸ç—›"],
    red:["ì‹¤ì‹ ","ì˜ì‹ì €í•˜","í˜¸í¡ê³¤ë€","ì €í˜ˆì••","SpO2","ì²­ìƒ‰ì¦","ì‹ ê²½í•™ì ","ë§ˆë¹„"],
    dx:[
      "ê¸‰ì„±ê´€ìƒë™ë§¥ì¦í›„êµ°(ACS) ê°€ëŠ¥ì„±",
      "íìƒ‰ì „ì¦(PE) ê°€ëŠ¥ì„±",
      "ëŒ€ë™ë§¥ë°•ë¦¬ ê°€ëŠ¥ì„±"
    ],
    q:[
      "í†µì¦ ì‹œì‘(ê°‘ì‘/ì ì§„), ë°©ì‚¬(í„±/íŒ”), ë°œí•œÂ·êµ¬ì—­Â·ì‹¤ì‹ Â·í˜¸í¡ê³¤ë€ ë™ë°˜?",
      "ìœ„í—˜ì¸ì: HTN/DM/í¡ì—°/ê°€ì¡±ë ¥, ìµœê·¼ ìˆ˜ìˆ Â·ì¥ê±°ë¦¬, OCP/ì„ì‹ Â·ì‚°í›„, DVT ë³‘ë ¥?",
      "í˜„ì¬ ìƒíƒœ: SpO2/í˜¸í¡ìˆ˜/í˜ˆì••/ì˜ì‹, íœ´ì‹ ì‹œì—ë„ ì§€ì† ë˜ëŠ” ì•…í™”?"
    ],
    sn:[
      "í˜„ì¬ ì¦ìƒì€ ì‹¬ì¥/í ë“± ì‘ê¸‰ ì›ì¸ ê°€ëŠ¥ì„±ì´ ìˆì–´ ì¦‰ì‹œ í‰ê°€ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
      "í˜¸í¡ê³¤ë€Â·ì‹¤ì‹ Â·ì§€ì†/ì•…í™”ë˜ëŠ” í‰í†µÂ·ì‹ì€ë•€Â·ì‹ ê²½í•™ì  ì¦ìƒì´ ìˆìœ¼ë©´ ë°”ë¡œ ì‘ê¸‰ì‹¤ë¡œ ê°€ì„¸ìš”.",
      "ì§€ê¸ˆ ìƒíƒœê°€ ì• ë§¤í•´ë„ ì•…í™” ì‹œ ì§€ì²´í•˜ì§€ ë§ê³  ì¦‰ì‹œ ë‚´ì›/ì‘ê¸‰ì‹¤ ë°©ë¬¸í•˜ì„¸ìš”."
    ]
  },
  {
    id:"dyspnea",
    name:"í˜¸í¡ê³¤ë€",
    match:["í˜¸í¡ê³¤ë€","ìˆ¨ì°¸","ìˆ¨ì´ ì°¨","dyspnea","ì²œëª…","wheezing","SpO2","ê°í˜ˆ"],
    red:["SpO2","ì²­ìƒ‰ì¦","ì˜ì‹ì €í•˜","ì €í˜ˆì••","ê°í˜ˆ","í‰í†µ"],
    dx:[
      "ì²œì‹/ê¸°ê´€ì§€ê²½ë ¨ ë˜ëŠ” COPD ì•…í™”",
      "íë ´/ê°ì—¼ì„± í˜¸í¡ê¸° ì§ˆí™˜",
      "íìƒ‰ì „ì¦(PE) ë˜ëŠ” ì‹¬ë¶€ì „ ì•…í™”"
    ],
    q:[
      "SpO2/í˜¸í¡ìˆ˜/ë§ë¬¸ì¥ ê°€ëŠ¥? ì²­ìƒ‰ì¦Â·ì˜ì‹ë³€í™” ìˆë‚˜?",
      "í‰í†µÂ·ê°í˜ˆÂ·ë‹¤ë¦¬ë¶€ì¢…/í†µì¦Â·ìµœê·¼ ìˆ˜ìˆ /ì¥ê±°ë¦¬Â·ì„ì‹ /ì‚°í›„ ë“± í˜ˆì „ ìœ„í—˜?",
      "ë°œì—´Â·ê°€ë˜Â·í‰í†µ/ì‹¬ë¶€ì „ ë³‘ë ¥Â·í¡ì—°ë ¥Â·ì•½ë¬¼(ì§„ì •ì œ ë“±) í™•ì¸?"
    ],
    sn:[
      "í˜¸í¡ê³¤ë€ì€ ì•…í™” ì‹œ ìœ„í—˜í•  ìˆ˜ ìˆì–´ ì‚°ì†Œí¬í™”ë„/í™œë ¥ í™•ì¸ì´ ì¤‘ìš”í•©ë‹ˆë‹¤.",
      "ë§í•˜ê¸° ì–´ë ¤ìš¸ ì •ë„ì˜ ìˆ¨ì°¸, SpO2 ì €í•˜, í‰í†µÂ·ê°í˜ˆÂ·ì˜ì‹ë³€í™”ê°€ ìˆìœ¼ë©´ ì¦‰ì‹œ ì‘ê¸‰ì‹¤ë¡œ ê°€ì„¸ìš”.",
      "ì¦ìƒì´ ì§€ì†/ì•…í™”í•˜ë©´ ì§€ì²´í•˜ì§€ ë§ê³  ì¬ë‚´ì›í•˜ê±°ë‚˜ ì‘ê¸‰ì‹¤ í‰ê°€ê°€ í•„ìš”í•©ë‹ˆë‹¤."
    ]
  },
  {
    id:"abd",
    name:"ë³µí†µ",
    match:["ë³µí†µ","ë°°ê°€","ë³µë¶€","abdominal","í† í˜ˆ","í˜ˆë³€","êµ¬í† ","ë°˜ë°œí†µ","ì„¤ì‚¬","ë³€ë¹„"],
    red:["í† í˜ˆ","í˜ˆë³€","ë³µë¶€ê°•ì§","ë°˜ë°œí†µ","ì €í˜ˆì••","ì˜ì‹ì €í•˜","ê³ ì—´","ì„ì‹ ","ì‚°í›„"],
    dx:[
      "ê¸‰ì„±ë³µì¦(ì¶©ìˆ˜ì—¼/ë‹´ë‚­ì—¼/ì²œê³µ/ì¥íìƒ‰ ë“±) ê°€ëŠ¥ì„±",
      "ìœ„ì¥ê´€ ì¶œí˜ˆ ê°€ëŠ¥ì„±(í† í˜ˆ/í˜ˆë³€ ë™ë°˜ ì‹œ)",
      "ì‚°ë¶€ì¸ê³¼ì  ì‘ê¸‰ í¬í•¨ ê°ë³„ í•„ìš”(ì„ì‹  ê°€ëŠ¥/ì‚°í›„/ì§ˆì¶œí˜ˆ)"
    ],
    q:[
      "í†µì¦ ìœ„ì¹˜/ì´ë™, ì§€ì†Â·ì•…í™”, ë°˜ë°œí†µÂ·ê°•ì§, êµ¬í† Â·ë°œì—´Â·í˜ˆë³€/í† í˜ˆ ë™ë°˜?",
      "ì„ì‹  ê°€ëŠ¥/ë§ˆì§€ë§‰ ìƒë¦¬/ì‚°í›„ ì—¬ë¶€ + ì§ˆì¶œí˜ˆÂ·ê³¨ë°˜í†µ ë™ë°˜?",
      "ìˆ˜ìˆ ë ¥(ìœ ì°©), NSAID/í•­ì‘ê³ ì œ, íƒˆìˆ˜, ì†Œë³€ì¦ìƒ(ì˜†êµ¬ë¦¬í†µ) í™•ì¸?"
    ],
    sn:[
      "ë³µí†µì€ ì›ì¸ì— ë”°ë¼ ì‘ê¸‰ ìˆ˜ìˆ /ì¶œí˜ˆ ê°€ëŠ¥ì„±ì´ ìˆì–´ ê²½ê³  ì‹ í˜¸ í™•ì¸ì´ ì¤‘ìš”í•©ë‹ˆë‹¤.",
      "ì§€ì†Â·ì•…í™” í†µì¦, ë°˜ë³µ êµ¬í† , ê³ ì—´, í† í˜ˆ/í˜ˆë³€, ì‹¤ì‹ /ì €í˜ˆì••ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì‘ê¸‰ì‹¤ë¡œ ê°€ì„¸ìš”.",
      "ì˜¤ëŠ˜ ì¢‹ì•„ì ¸ë„ ë‹¤ì‹œ ì•…í™”í•˜ë©´ ë°”ë¡œ ì¬í‰ê°€ê°€ í•„ìš”í•©ë‹ˆë‹¤."
    ]
  },
  {
    id:"head",
    name:"ë‘í†µ",
    match:["ë‘í†µ","ë¨¸ë¦¬ê°€","headache","ë²ˆê°œ","ìµœì•…","ê²½ë¶€ê°•ì§","ì‹œì•¼","ë§ˆë¹„","ì˜ì‹","êµ¬í† "],
    red:["ê°‘ìê¸°","ë²ˆê°œ","ìµœì•…","ê²½ë¶€ê°•ì§","ì˜ì‹ì €í•˜","ë§ˆë¹„","ì–¸ì–´","ì‹œì•¼","ê³ ì—´","ê²½ë ¨","ì„ì‹ ","ì‚°í›„"],
    dx:[
      "ë‡Œí˜ˆê´€ì„± ì›ì¸(ì§€ì£¼ë§‰í•˜ì¶œí˜ˆ ë“±) ê°€ëŠ¥ì„±(ê°‘ì‘Â·ìµœì•…/ì‹ ê²½í•™ì  ì¦ìƒ ì‹œ)",
      "ìˆ˜ë§‰ì—¼/ë‡Œì—¼ ë“± ê°ì—¼ ê°€ëŠ¥ì„±(ë°œì—´Â·ê²½ë¶€ê°•ì§/ì˜ì‹ë³€í™” ë™ë°˜ ì‹œ)",
      "í¸ë‘í†µ/ê¸´ì¥ì„± ë‘í†µ(ë ˆë“œí”Œë˜ê·¸ ì—†ì„ ë•Œ)"
    ],
    q:[
      "ë°œë³‘ ì–‘ìƒ(ê°‘ìê¸°/ë²ˆê°œ), â€˜í‰ìƒ ìµœì•…â€™ ì—¬ë¶€ + ì‹ ê²½í•™ì  ê²°ì†(ë§ˆë¹„/ì–¸ì–´/ì‹œì•¼)?",
      "ë°œì—´Â·ê²½ë¶€ê°•ì§Â·ì˜ì‹ë³€í™”Â·ê²½ë ¨Â·ë°œì§„ ë“± ê°ì—¼/ì¤‘ì¦ ì§•í›„?",
      "ì„ì‹ /ì‚°í›„, í•­ì‘ê³ ì œ, ì™¸ìƒ, ë©´ì—­ì €í•˜/ì•” ë³‘ë ¥ ë“± ìœ„í—˜ì¸ì?"
    ],
    sn:[
      "ê°‘ìê¸° ì‹œì‘í•œ ì‹¬í•œ ë‘í†µì´ë‚˜ ì‹ ê²½í•™ì  ì¦ìƒì€ ì‘ê¸‰ í‰ê°€ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
      "ì˜ì‹ë³€í™”Â·ë§ˆë¹„Â·ì‹œì•¼ì¥ì• Â·ê²½ë ¨Â·ê³ ì—´Â·ê²½ë¶€ê°•ì§ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì‘ê¸‰ì‹¤ë¡œ ê°€ì„¸ìš”.",
      "í†µì¦ì´ ì§€ì†/ì•…í™”í•˜ê±°ë‚˜ ìƒˆ ì¦ìƒì´ ìƒê¸°ë©´ ë°”ë¡œ ì¬ë‚´ì›í•˜ì„¸ìš”."
    ]
  }
];

const COMMON_RED = ["ì˜ì‹ì €í•˜","ì‹¤ì‹ ","ê²½ë ¨","ë§ˆë¹„","ë§ì´ ì–´ëˆŒ","ì²­ìƒ‰ì¦","ì €í˜ˆì••","SpO2","ê°í˜ˆ","í† í˜ˆ","í˜ˆë³€","í‰í†µ","í˜¸í¡ê³¤ë€","ê°‘ìê¸°","ìµœì•…","ê²½ë¶€ê°•ì§","ê³ ì—´"];

function pickCategory(text){
  for(const c of CATS){
    if(hasAny(text, c.match)) return c;
  }
  return null;
}
function detectRed(text, cat){
  const hits = [];
  const pool = [...new Set([...(cat?.red||[]), ...COMMON_RED])];
  for(const k of pool){
    if(normalize(text).includes(normalize(k))) hits.push(k);
  }
  return hits;
}

/* =========================
   ë²”ìš© í…œí”Œë¦¿(ì¹´í…Œê³ ë¦¬ ëª» ì¡ê±°ë‚˜ ì •ë³´ ë¶€ì¡±í•´ë„ ì‘ë™)
   ========================= */
function genericDx(){
  // 1ì°¨ ì˜ë£Œì—ì„œ "ìš°ì„  ë°°ì œ" ê´€ì ìœ¼ë¡œ 3ê°œ
  return [
    "ìƒëª…ìœ„í˜‘ ê°€ëŠ¥ ì›ì¸(ê¸°ë„/í˜¸í¡/ìˆœí™˜/ì¶œí˜ˆ/ì‹ ê²½í•™ì  ì‘ê¸‰) ìš°ì„  ë°°ì œ í•„ìš”",
    "ê°ì—¼/ì—¼ì¦ì„± ì§ˆí™˜ ê°€ëŠ¥ì„±(ë°œì—´Â·ì „ì‹ ì¦ìƒ ë™ë°˜ ì—¬ë¶€ í™•ì¸)",
    "ì•½ë¬¼/ëŒ€ì‚¬/ì™¸ìƒ/ê¸°ì €ì§ˆí™˜ ì•…í™” ê°€ëŠ¥ì„±(ë³µìš©ì•½Â·ê¸°ì €ì§ˆí™˜Â·ì™¸ìƒë ¥ í™•ì¸)"
  ];
}
function genericQs(){
  return [
    "ì˜ì‹ë³€í™”/ì‹¤ì‹ /í˜¸í¡ê³¤ë€/í‰í†µ/ì¶œí˜ˆ(í† í˜ˆÂ·í˜ˆë³€)/ì‹ ê²½í•™ì  ì¦ìƒ(ë§ˆë¹„Â·ì–¸ì–´Â·ì‹œì•¼) ìˆë‚˜ìš”?",
    "ì¦ìƒì´ â€˜ê°‘ìê¸°â€™ ì‹œì‘í–ˆë‚˜ìš”, ê·¸ë¦¬ê³  ì ì  ì•…í™”í•˜ë‚˜ìš”? í˜„ì¬ ê±·ê¸°/ë§í•˜ê¸°ê°€ ê°€ëŠ¥í•œê°€ìš”?",
    "ê³ ìœ„í—˜ ìš”ì¸(ì„ì‹ Â·ì‚°í›„, í•­ì‘ê³ ì œ, ë©´ì—­ì €í•˜/ì•”, ìµœê·¼ ìˆ˜ìˆ Â·ì¥ê±°ë¦¬, í° ì™¸ìƒ) ìˆë‚˜ìš”?"
  ];
}
function genericSN(){
  return [
    "í˜„ì¬ ì¦ìƒì€ ì›ì¸ì´ í™•ì •ë˜ì§€ ì•Šì•„ ê²½ê³¼ ê´€ì°°/ì¶”ê°€ í‰ê°€ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
    "í˜¸í¡ê³¤ë€Â·ì‹¤ì‹ Â·ì˜ì‹ë³€í™”Â·ì§€ì† ì•…í™” í†µì¦Â·ì¶œí˜ˆÂ·ì‹ ê²½í•™ì  ì¦ìƒì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì‘ê¸‰ì‹¤ë¡œ ê°€ì„¸ìš”.",
    "ì¦ìƒì´ ì§€ì†/ì•…í™”í•˜ê±°ë‚˜ ìƒˆ ì¦ìƒì´ ìƒê¸°ë©´ ì§€ì²´í•˜ì§€ ë§ê³  ì¬ë‚´ì›í•˜ì„¸ìš”."
  ];
}

/* =========================
   EMR ë¬¸êµ¬ ìƒì„±(ë°”ë¡œ ë¶™ì—¬ë„£ê¸°ìš©)
   ========================= */
function sexK(sex){
  if(sex==="M") return "ë‚¨";
  if(sex==="F") return "ì—¬";
  return "ì„±ë³„ ë¯¸ìƒ";
}
function safe(v, fallback="ë¯¸ìƒ"){
  return (v && String(v).trim().length) ? String(v).trim() : fallback;
}

function buildNote(input, cat, dx, qs, sn){
  const ts = nowStamp();
  const age = safe(input.age, "ë‚˜ì´ ë¯¸ìƒ");
  const sex = sexK(input.sex);
  const cc = safe(input.cc, "ì£¼ì¦ìƒ ë¯¸ìƒ");

  const duration = safe(input.duration, "ë¯¸ìƒ");
  const vitals = safe(input.vitals, "ë¯¸ìƒ");
  const pmh = safe(input.pmh, "ë¯¸ìƒ");
  const preg = input.preg ? (input.preg==="pregnant" ? "ì„ì‹  ì¤‘" : "ì‚°í›„(6ì£¼ ì´ë‚´)") : "ë¯¸ìƒ/í•´ë‹¹ ì—†ìŒ";
  const memo = safe(input.memo, "ì—†ìŒ/ë¯¸ìƒ");

  // DETAIL ëª¨ë“œë©´ ì§ˆë¬¸/ì•ˆì „ë§ì„ í•œ ì¤„ ë” ì¹œì ˆí•˜ê²Œ ë„£ìŒ
  const qBlock = qs.map((q,i)=>`- Q${i+1}) ${q}  [ ]ì˜ˆ  [ ]ì•„ë‹ˆì˜¤  [ ]ë¯¸ìƒ`).join("\n");
  const snBlock = sn.map((s)=>`- ${s}`).join("\n");

  const ddxBlock = dx.map((d,i)=>`- #${i+1} ${d}`).join("\n");

  const base = [
    `=== Encounter Note (paste-ready) ===`,
    `Timestamp: ${ts}`,
    ``,
    `[Chief Complaint]`,
    `- ${age}ì„¸ ${sex} / ì£¼ì¦ìƒ: ${cc}`,
    ``,
    `[HPI]`,
    `- ì‹œì‘/ê¸°ê°„: ${duration}`,
    `- (í™˜ìì§„ìˆ  ê¸°ë°˜) ë™ë°˜/ì•…í™”ìš”ì¸ ë“±: ${memo}`,
    ``,
    `[Vitals/Key Data]`,
    `- ${vitals}`,
    ``,
    `[PMH/Meds / Pregnancy]`,
    `- ê¸°ì €ì§ˆí™˜/ì•½ë¬¼: ${pmh}`,
    `- ì„ì‹ /ì‚°í›„: ${preg}`,
    ``,
    `[Assessment - Differential (Top 3)]`,
    `${ddxBlock}`,
    ``,
    `[High-risk screen (asked)]`,
    `${qBlock}`,
    ``,
    `[Plan / Disposition]`,
    `- (í•„ìš” ì‹œ) ì‘ê¸‰ ì›ì¸ ë°°ì œ ìœ„í•´ ì¦‰ì‹œ í‰ê°€/ìƒê¸‰ê¸°ê´€ ì˜ë¢° ë˜ëŠ” ì‘ê¸‰ì‹¤ ë°©ë¬¸ ê¶Œê³ í•¨.`,
    `- ëŒ€ì•ˆ/ì¶”ì : ì¦ìƒ ì§€ì†/ì•…í™” ì‹œ ì¬í‰ê°€(ì˜ˆ: 24â€“48ì‹œê°„ ë‚´) ì•ˆë‚´í•¨.`,
    ``,
    `[Safety-net (patient instructions)]`,
    `${snBlock}`,
    ``,
    `[Patient understanding]`,
    `- ì„¤ëª… ë° ì£¼ì˜ì‚¬í•­ ì•ˆë‚´í–ˆê³ , í™˜ì ì´í•´/ë™ì˜ ì—¬ë¶€: [ ]ì´í•´í•¨  [ ]ì¶”ê°€ì„¤ëª… í•„ìš”  [ ]ë¯¸ìƒ`,
  ];

  if(DETAIL==="detail"){
    base.push(
      ``,
      `[Documentation add-on]`,
      `- í™˜ì ì„ íƒ(ë‚´ì›/ê²€ì‚¬/ì´ì†¡) ë° ê±°ë¶€/ì§€ì—° ì‹œ ì‚¬ìœ : [ ]ì—†ìŒ  [ ]ìˆìŒ( )  [ ]ë¯¸ìƒ`,
      `- ì—°ë½/ì¶”ì  ê³„íš(ê²€ì‚¬ ê²°ê³¼ í™•ì¸/ì¬ì—°ë½): [ ]ì•ˆë‚´í•¨  [ ]ë¯¸ìƒ`
    );
  }

  return base.join("\n");
}

function buildChat3Lines(input, sn){
  // â€œì± íŒ…/ì „í™”â€ìš© 3ì¤„: EMRì— ë¶™ì—¬ë„£ê¸° ì‰¬ìš´ í˜•íƒœ
  const age = safe(input.age, "ë‚˜ì´ ë¯¸ìƒ");
  const sex = sexK(input.sex);
  const cc = safe(input.cc, "ì£¼ì¦ìƒ ë¯¸ìƒ");
  const dur = safe(input.duration, "ë¯¸ìƒ");

  return [
    `ë¹„ëŒ€ë©´(ì± íŒ…/ì „í™”) ìš”ì•½: ${age}ì„¸ ${sex}, '${cc}' (ê¸°ê°„: ${dur}).`,
    `ì„¤ëª…/ê¶Œê³ : ìœ„í—˜ ê°€ëŠ¥ì„± ì„¤ëª… í›„, ìƒíƒœì— ë”°ë¼ ì¦‰ì‹œ ë‚´ì›/ì‘ê¸‰ì‹¤ í‰ê°€ í•„ìš”í•  ìˆ˜ ìˆìŒì„ ì•ˆë‚´.`,
    `ì•ˆì „ë§: ${sn[1]}` // ê°€ìš´ë° ì¤„(ì‘ê¸‰ ê¸°ì¤€) ê³ ì •
  ];
}

/* =========================
   ë Œë” & ì´ë²¤íŠ¸
   ========================= */
function renderAll(){
  const input = {
    age: $("age").value,
    sex: $("sex").value,
    cc: $("cc").value,
    duration: $("duration").value,
    vitals: $("vitals").value,
    pmh: $("pmh").value,
    preg: $("preg").value,
    memo: $("memo").value,
  };

  // í•„ìˆ˜ ì²´í¬(í—ˆë“¤ ë‚®ê²Œ: ëˆ„ë½í•´ë„ ë¯¸ìƒìœ¼ë¡œ ë§Œë“¤ì§€ë§Œ, ì„±ë³„/ë‚˜ì´ëŠ” ê°€ëŠ¥í•˜ë©´ ì…ë ¥ ìœ ë„)
  const fullText = `${input.age} ${input.sex} ${input.cc} ${input.duration} ${input.vitals} ${input.pmh} ${input.preg} ${input.memo}`.trim();

  const cat = pickCategory(fullText);
  $("categoryPill").textContent = `ì¹´í…Œê³ ë¦¬: ${cat ? cat.name : "ì¼ë°˜(ë²”ìš©)"}`;

  const redHits = detectRed(fullText, cat);
  if(redHits.length){
    $("alertBox").classList.add("show");
    $("alertText").textContent = `ê°ì§€ í‚¤ì›Œë“œ: ${redHits.slice(0,8).join(", ")}${redHits.length>8?" ...":""}`;
  }else{
    $("alertBox").classList.remove("show");
    $("alertText").textContent = "";
  }

  const dx = cat ? cat.dx.slice(0,3) : genericDx();
  const qs = cat ? cat.q.slice(0,3) : genericQs();
  const sn = cat ? cat.sn.slice(0,3) : genericSN();

  setList($("dxList"), dx);
  setList($("qList"), qs);

  // ì•ˆì „ë§ì€ â€œì§§ê²Œâ€ì—ì„œëŠ” 3ì¤„ ê·¸ëŒ€ë¡œ, â€œì¡°ê¸ˆ ë”â€ì—ì„œëŠ” 1ë²ˆ ì¤„ì„ ì¢€ ë” êµ¬ì²´í™”
  let snUse = [...sn];
  if(DETAIL==="detail"){
    snUse[0] = snUse[0] + " (ì¦ìƒì´ ìƒˆë¡œ ìƒê¸°ê±°ë‚˜ íŒ¨í„´ì´ ë‹¬ë¼ì§€ë©´ ì¦‰ì‹œ ì¬í‰ê°€ ê¶Œê³ )";
  }
  setList($("snList"), snUse);

  const chat3 = buildChat3Lines(input, snUse);
  setList($("chatNoteList"), chat3);

  const note = buildNote(input, cat, dx, qs, snUse);
  $("noteOut").textContent = note;

  // ë§ˆì§€ë§‰ ì…ë ¥ ì €ì¥
  localStorage.setItem("pcp_cds_last_v2", JSON.stringify(input));
}

function resetAll(){
  ["age","cc","duration","vitals","pmh","memo"].forEach(id=>$(id).value="");
  $("sex").value="";
  $("preg").value="";
  $("dxList").innerHTML = `<li class="muted">â€˜ìƒì„±â€™ ëˆ„ë¥´ë©´ ì±„ì›Œì§</li>`;
  $("qList").innerHTML  = `<li class="muted">â€˜ìƒì„±â€™ ëˆ„ë¥´ë©´ ì±„ì›Œì§</li>`;
  $("snList").innerHTML = `<li class="muted">â€˜ìƒì„±â€™ ëˆ„ë¥´ë©´ ì±„ì›Œì§</li>`;
  $("chatNoteList").innerHTML = `<li class="muted">â€˜ìƒì„±â€™ ëˆ„ë¥´ë©´ ì±„ì›Œì§</li>`;
  $("noteOut").textContent="(ì—¬ê¸°ì— ìƒì„±ë¨)";
  $("categoryPill").textContent="ì¹´í…Œê³ ë¦¬: ìë™";
  $("alertBox").classList.remove("show");
  localStorage.removeItem("pcp_cds_last_v2");
}

$("genBtn").addEventListener("click", ()=>{
  // ì„±ë³„/ë‚˜ì´ ëˆ„ë½ì´ì–´ë„ ìƒì„±ì€ ë˜ê²Œ í•˜ê³ , í† ìŠ¤íŠ¸ë¡œë§Œ ì•ˆë‚´
  if(!$("age").value.trim() || !$("sex").value || !$("cc").value.trim()){
    toast("í•„ìˆ˜ ì…ë ¥ì´ ì¼ë¶€ ë¹„ì–´ìˆì–´ë„ â€˜ë¯¸ìƒâ€™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤");
  }
  renderAll();
});

$("copyNoteBtn").addEventListener("click", ()=>copyText($("noteOut").textContent));
$("copyAllBtn").addEventListener("click", ()=>copyText($("noteOut").textContent));

$("downloadBtn").addEventListener("click", ()=>{
  downloadText(`emr_note_${new Date().toISOString().slice(0,10)}.txt`, $("noteOut").textContent);
});

$("resetBtn").addEventListener("click", ()=>{
  if(!confirm("ì…ë ¥/ì¶œë ¥ì„ ì´ˆê¸°í™”í• ê¹Œìš”?")) return;
  resetAll();
  toast("ì´ˆê¸°í™” ì™„ë£Œ");
});

$("copyDxBtn").addEventListener("click", ()=>{
  const items=[...document.querySelectorAll("#dxList li")].map(li=>li.textContent);
  copyText(items.map((x,i)=>`#${i+1} ${x}`).join("\n"));
});
$("copyQBtn").addEventListener("click", ()=>{
  const items=[...document.querySelectorAll("#qList li")].map(li=>li.textContent);
  copyText(items.map((x,i)=>`Q${i+1}. ${x}`).join("\n"));
});
$("copySNBtn").addEventListener("click", ()=>{
  const items=[...document.querySelectorAll("#snList li")].map(li=>li.textContent);
  copyText(items.map(x=>`- ${x}`).join("\n"));
});
$("copyChatNoteBtn").addEventListener("click", ()=>{
  const items=[...document.querySelectorAll("#chatNoteList li")].map(li=>li.textContent);
  copyText(items.map(x=>`- ${x}`).join("\n"));
});

/* detail toggle */
$("shortBtn").addEventListener("click", ()=>{
  DETAIL="short";
  $("shortBtn").classList.add("active");
  $("detailBtn").classList.remove("active");
  toast("ì§§ê²Œ ëª¨ë“œ");
  // ì´ë¯¸ ìƒì„±ëœ ìƒíƒœë©´ ì¦‰ì‹œ ì¬ë Œë”
  if($("noteOut").textContent && $("noteOut").textContent !== "(ì—¬ê¸°ì— ìƒì„±ë¨)") renderAll();
});
$("detailBtn").addEventListener("click", ()=>{
  DETAIL="detail";
  $("detailBtn").classList.add("active");
  $("shortBtn").classList.remove("active");
  toast("ì¡°ê¸ˆ ë” ëª¨ë“œ");
  if($("noteOut").textContent && $("noteOut").textContent !== "(ì—¬ê¸°ì— ìƒì„±ë¨)") renderAll();
});

/* ì´ˆê¸° ë¡œë”©: ë§ˆì§€ë§‰ ì…ë ¥ ë³µì› */
(function init(){
  try{
    const raw = localStorage.getItem("pcp_cds_last_v2");
    if(raw){
      const d = JSON.parse(raw);
      $("age").value = d.age || "";
      $("sex").value = d.sex || "";
      $("cc").value = d.cc || "";
      $("duration").value = d.duration || "";
      $("vitals").value = d.vitals || "";
      $("pmh").value = d.pmh || "";
      $("preg").value = d.preg || "";
      $("memo").value = d.memo || "";
    }
  }catch(e){}
})();
</script>
</body>
</html>
